<?php
 class umiAuth extends singleton implements iSingleton, iUmiAuth {const PREAUTH_INVALID = 0;const PREAUTH_SUCCESS_NEW = 1;const PREAUTH_SUCCESS_RESTORE = 2;const PREAUTH_ALREADY = 3;const PREAUTH_NEEDNOT = 4;public function __construct() {}public static function getInstance($v4a8a08f09d37b73795649038408b5f33 = NULL) {parent::getInstance(__CLASS__);}public function tryPreAuth() {$v0abe16877de06248cdf4eafcc650228c = "";$v49e23c2f3612d869a00a6bf9269e1b7a = "";$vc6782fd2652f6f48834e792737516c2b = 'u-login';$vd8df0291f44164611255e63350c87f81 = 'u-password';$vc24ae1dba0bb0f3e0d9ed535249d9a6d = 'u-password-md5';$v3e067bf52710d06701ef80d60ec64375 = 'u-session-id';if($vd56b699830e77ba53855679cb1d252da = getCookie($vc6782fd2652f6f48834e792737516c2b)) {if($v0abe16877de06248cdf4eafcc650228c = getCookie($vd8df0291f44164611255e63350c87f81)) {$v0abe16877de06248cdf4eafcc650228c = md5($v0abe16877de06248cdf4eafcc650228c);}else {$v0abe16877de06248cdf4eafcc650228c = getCookie($vc24ae1dba0bb0f3e0d9ed535249d9a6d);}}if (function_exists('apache_request_headers')) {$v5d4cd034486d8289e776ec9bbfdb93cd = apache_request_headers();if (isset($v5d4cd034486d8289e776ec9bbfdb93cd[$vc6782fd2652f6f48834e792737516c2b])) {$vd56b699830e77ba53855679cb1d252da = umiObjectProperty::filterInputString(str_replace(chr(0), "", $v5d4cd034486d8289e776ec9bbfdb93cd[$vc6782fd2652f6f48834e792737516c2b]));}if (isset($v5d4cd034486d8289e776ec9bbfdb93cd[$vc24ae1dba0bb0f3e0d9ed535249d9a6d])) {$v0abe16877de06248cdf4eafcc650228c = umiObjectProperty::filterInputString(str_replace(chr(0), "", $v5d4cd034486d8289e776ec9bbfdb93cd[$vc24ae1dba0bb0f3e0d9ed535249d9a6d]));}elseif (isset($v5d4cd034486d8289e776ec9bbfdb93cd[$vd8df0291f44164611255e63350c87f81])) {$v0abe16877de06248cdf4eafcc650228c = md5(umiObjectProperty::filterInputString(str_replace(chr(0), "", $v5d4cd034486d8289e776ec9bbfdb93cd[$vd8df0291f44164611255e63350c87f81])));}if (isset($v5d4cd034486d8289e776ec9bbfdb93cd[$v3e067bf52710d06701ef80d60ec64375])) {$v49e23c2f3612d869a00a6bf9269e1b7a = umiObjectProperty::filterInputString(str_replace(chr(0), "", $v5d4cd034486d8289e776ec9bbfdb93cd[$v3e067bf52710d06701ef80d60ec64375]));}}if (isset($_REQUEST[$vc6782fd2652f6f48834e792737516c2b])) {$vd56b699830e77ba53855679cb1d252da = umiObjectProperty::filterInputString(str_replace(chr(0), "", $_REQUEST[$vc6782fd2652f6f48834e792737516c2b]));}if (isset($_REQUEST[$vc24ae1dba0bb0f3e0d9ed535249d9a6d])) {$v0abe16877de06248cdf4eafcc650228c = umiObjectProperty::filterInputString(str_replace(chr(0), "", $_REQUEST[$vc24ae1dba0bb0f3e0d9ed535249d9a6d]));}elseif (isset($_REQUEST[$vd8df0291f44164611255e63350c87f81])) {$v0abe16877de06248cdf4eafcc650228c = md5(umiObjectProperty::filterInputString(str_replace(chr(0), "", $_REQUEST[$vd8df0291f44164611255e63350c87f81])));}if (isset($_REQUEST[$v3e067bf52710d06701ef80d60ec64375])) {$v49e23c2f3612d869a00a6bf9269e1b7a = umiObjectProperty::filterInputString(str_replace(chr(0), "", $_REQUEST[$v3e067bf52710d06701ef80d60ec64375]));}if (strlen($vd56b699830e77ba53855679cb1d252da) && strlen($v0abe16877de06248cdf4eafcc650228c)) {$v6301cee35ea764a1e241978f93f01069 = umiObjectTypesCollection::getInstance()->getBaseType("users", "user");$v726e8e4809d4c1b28a6549d86436a124 = umiObjectTypesCollection::getInstance()->getType($v6301cee35ea764a1e241978f93f01069);$vd44cd3a6942d574f4da3210e6ef10680 = $v726e8e4809d4c1b28a6549d86436a124->getFieldId("login");$v2c13e063e421d50c5268eb9a13dac511 = $v726e8e4809d4c1b28a6549d86436a124->getFieldId("password");$v6f8866f4da308ed0cc81fa4ca3d3b38b = $v726e8e4809d4c1b28a6549d86436a124->getFieldId("is_activated");$v8be74552df93e31bbdd6b36ed74bdb6a = new umiSelection;$v8be74552df93e31bbdd6b36ed74bdb6a->addLimit(1);$v8be74552df93e31bbdd6b36ed74bdb6a->addObjectType($v6301cee35ea764a1e241978f93f01069);$v8be74552df93e31bbdd6b36ed74bdb6a->addPropertyFilterEqual($vd44cd3a6942d574f4da3210e6ef10680, $vd56b699830e77ba53855679cb1d252da);$v8be74552df93e31bbdd6b36ed74bdb6a->addPropertyFilterEqual($v2c13e063e421d50c5268eb9a13dac511, $v0abe16877de06248cdf4eafcc650228c);$v8be74552df93e31bbdd6b36ed74bdb6a->addPropertyFilterEqual($v6f8866f4da308ed0cc81fa4ca3d3b38b, 1);$result = umiSelectionsParser::runSelection($v8be74552df93e31bbdd6b36ed74bdb6a);if(sizeof($result) === 1) {$v8e44f0089b076e18a718eb9ca3d94674 = intval($result[0]);$v21d6f40cfb511982e4424e0e250a9557 = session::getInstance();$v9e978fff61a562774b122fc74682b3cf = session::getId();system_runSession();if ($v21d6f40cfb511982e4424e0e250a9557->get("cms_login") === $vd56b699830e77ba53855679cb1d252da && $v21d6f40cfb511982e4424e0e250a9557->get("cms_pass") === $v0abe16877de06248cdf4eafcc650228c && $v21d6f40cfb511982e4424e0e250a9557->get("user_id") === $v8e44f0089b076e18a718eb9ca3d94674) {return self::PREAUTH_ALREADY;}if (getRequest('mobile_application') == 'true' && !regedit::getInstance()->getVal('//modules/emarket')) {$v8d777f385d3dfec8815d20f7496026dc = array(       "data" => array(        "type" => null,        "action" => null,        "error" => array(         "code" => 0,         "message" => getLabel('label-module-emarket-is-absent')        )       )      );$v7f2db423a49b305459147332fb01cf87 = outputBuffer::current();$v7f2db423a49b305459147332fb01cf87->clear();if (getRequest("xmlMode") == 'force') {$vdd988cfd769c9f7fbd795a0f5da8e751 = new DOMDocument('1.0', 'utf-8');$v173a1756d2d82394cb803161f70f9a38 = $vdd988cfd769c9f7fbd795a0f5da8e751->createElement("result");$vdd988cfd769c9f7fbd795a0f5da8e751->appendChild($v173a1756d2d82394cb803161f70f9a38);$v173a1756d2d82394cb803161f70f9a38->setAttribute('xmlns:xlink', 'http://www.w3.org/TR/xlink');$v607f2f3099f2a347b327caa70e0be4b2 = new xmlTranslator($vdd988cfd769c9f7fbd795a0f5da8e751);$v607f2f3099f2a347b327caa70e0be4b2->translateToXml($v173a1756d2d82394cb803161f70f9a38, $v8d777f385d3dfec8815d20f7496026dc);$v7f2db423a49b305459147332fb01cf87->contentType('text/xml');$v7f2db423a49b305459147332fb01cf87->push($vdd988cfd769c9f7fbd795a0f5da8e751->saveXML());}elseif(getRequest("jsonMode") == 'force') {$v607f2f3099f2a347b327caa70e0be4b2 = new jsonTranslator;$v7f2db423a49b305459147332fb01cf87->contentType('text/javascript');$v7f2db423a49b305459147332fb01cf87->option('generation-time', false);$v7f2db423a49b305459147332fb01cf87->push($v607f2f3099f2a347b327caa70e0be4b2->translateToJson($v8d777f385d3dfec8815d20f7496026dc));}else {throw new publicException(getLabel('label-module-emarket-is-absent'));}exit();}if (strlen($v49e23c2f3612d869a00a6bf9269e1b7a)) {if (strlen($v9e978fff61a562774b122fc74682b3cf)) {session::destroy();}session::setId($v49e23c2f3612d869a00a6bf9269e1b7a);session::getInstance();$v70e8822b2e035fa3777d666207aeafa8 = new umiEventPoint("users_prelogin_successfull");$v70e8822b2e035fa3777d666207aeafa8->setParam("prelogin_mode", self::PREAUTH_SUCCESS_RESTORE);$v70e8822b2e035fa3777d666207aeafa8->setParam("user_id", $v8e44f0089b076e18a718eb9ca3d94674);umiEventsController::getInstance()->callEvent($v70e8822b2e035fa3777d666207aeafa8);return self::PREAUTH_SUCCESS_RESTORE;}else {$v21d6f40cfb511982e4424e0e250a9557 = session::recreateInstance();$v21d6f40cfb511982e4424e0e250a9557->set("cms_login", $vd56b699830e77ba53855679cb1d252da);$v21d6f40cfb511982e4424e0e250a9557->set("cms_pass", $v0abe16877de06248cdf4eafcc650228c);$v21d6f40cfb511982e4424e0e250a9557->set("user_id", $v8e44f0089b076e18a718eb9ca3d94674);$v41275a535677f79ff347e01bc530c176 = permissionsCollection::getInstance();if ($v41275a535677f79ff347e01bc530c176->isAdmin($v8e44f0089b076e18a718eb9ca3d94674)) {$v21d6f40cfb511982e4424e0e250a9557->set('csrf_token', md5(rand() . microtime()));if ($v41275a535677f79ff347e01bc530c176->isSv($v8e44f0089b076e18a718eb9ca3d94674)) {$v21d6f40cfb511982e4424e0e250a9557->set('user_is_sv', true);}$v21d6f40cfb511982e4424e0e250a9557->setValid();}session::recreateInstance();$v70e8822b2e035fa3777d666207aeafa8 = new umiEventPoint("users_prelogin_successfull");$v70e8822b2e035fa3777d666207aeafa8->setParam("prelogin_mode", self::PREAUTH_SUCCESS_NEW);$v70e8822b2e035fa3777d666207aeafa8->setParam("user_id", $v8e44f0089b076e18a718eb9ca3d94674);umiEventsController::getInstance()->callEvent($v70e8822b2e035fa3777d666207aeafa8);if (intval(getRequest('u-login-store')) || strtoupper(getRequest('u-login-store')) === 'ON') {setcookie($vc6782fd2652f6f48834e792737516c2b, $vd56b699830e77ba53855679cb1d252da, (time() + 2678400), "/");setcookie($vc24ae1dba0bb0f3e0d9ed535249d9a6d, $v0abe16877de06248cdf4eafcc650228c, (time() + 2678400), "/");}elseif (getRequest('mobile_application') == 'true') {setcookie($vc6782fd2652f6f48834e792737516c2b, $vd56b699830e77ba53855679cb1d252da, 0, "/");setcookie($vc24ae1dba0bb0f3e0d9ed535249d9a6d, $v0abe16877de06248cdf4eafcc650228c, 0, "/");}return self::PREAUTH_SUCCESS_NEW;}}}return self::PREAUTH_INVALID;}}?>