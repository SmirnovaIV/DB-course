<?php
 class csvExporter extends umiExporter {public function setOutputBuffer() {$v7f2db423a49b305459147332fb01cf87 = outputBuffer::current('HTTPOutputBuffer');$v7f2db423a49b305459147332fb01cf87->charset("windows-1251");$v7f2db423a49b305459147332fb01cf87->contentType("text/plain");return $v7f2db423a49b305459147332fb01cf87;}public function export($v92ec19ffde05e15769b1bb3ee05ad745, $v593d4791d99adff3d667c8b1f5c3894b) {$v857a5246dff0c3c79e476b004684f6d3 = CURRENT_WORKING_DIR . "/sys-temp/export/";$vb80bb7740288fda1f201890375a60c8f = getRequest('param0');if (!is_dir($v857a5246dff0c3c79e476b004684f6d3)) mkdir($v857a5246dff0c3c79e476b004684f6d3, 0777, true);$v8e9e791281df5188f135edcc30eaa97e = $v857a5246dff0c3c79e476b004684f6d3 . $vb80bb7740288fda1f201890375a60c8f . "." . $this->getFileExt();$v7c95caafbd5e4b5db3977617a0498de6 = $vb80bb7740288fda1f201890375a60c8f . "." . $this->getFileExt();if(file_exists($v8e9e791281df5188f135edcc30eaa97e) && !file_exists($v8e9e791281df5188f135edcc30eaa97e . 'array')) unlink($v8e9e791281df5188f135edcc30eaa97e);$v2a05e4f9b3949ba2c0b7d413a0863c3f = array();if (!file_exists($v8e9e791281df5188f135edcc30eaa97e . 'array')) {if (!count($v92ec19ffde05e15769b1bb3ee05ad745)) {$v8be74552df93e31bbdd6b36ed74bdb6a = new selector('pages');$v8be74552df93e31bbdd6b36ed74bdb6a->where('hierarchy')->page(0)->childs(0);$v92ec19ffde05e15769b1bb3ee05ad745 = $v8be74552df93e31bbdd6b36ed74bdb6a->result;}foreach ($v92ec19ffde05e15769b1bb3ee05ad745 as $v8e2dcfd7e7e24b1ca76c1193f645902b) {if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceof umiHierarchyElement) {$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v8e2dcfd7e7e24b1ca76c1193f645902b, true, true);}if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceof umiHierarchyElement) continue;$v7552cd149af7495ee7d8225974e50f80 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getId();$v2a05e4f9b3949ba2c0b7d413a0863c3f[$v7552cd149af7495ee7d8225974e50f80] = $v7552cd149af7495ee7d8225974e50f80;$vc9e9a848920877e76685b2e4e76de38d = umiHierarchy::getInstance()->getMaxNestingLevel($v7552cd149af7495ee7d8225974e50f80);if (!$vc9e9a848920877e76685b2e4e76de38d) continue;for ($v865c0c0b4ab0e063e5caa3387c1a8741 = 1;$v865c0c0b4ab0e063e5caa3387c1a8741 <= $vc9e9a848920877e76685b2e4e76de38d;$v865c0c0b4ab0e063e5caa3387c1a8741++) {$v8be74552df93e31bbdd6b36ed74bdb6a = new selector('pages');$v8be74552df93e31bbdd6b36ed74bdb6a->option('return')->value('id');$v8be74552df93e31bbdd6b36ed74bdb6a->where('hierarchy')->page($v7552cd149af7495ee7d8225974e50f80)->childs($v865c0c0b4ab0e063e5caa3387c1a8741);foreach($v8be74552df93e31bbdd6b36ed74bdb6a->result() as $v9b207167e5381c47682c6b4f58a623fb) {$v2a05e4f9b3949ba2c0b7d413a0863c3f[$v9b207167e5381c47682c6b4f58a623fb['id']] = $v9b207167e5381c47682c6b4f58a623fb['id'];}}}foreach ($v593d4791d99adff3d667c8b1f5c3894b as $v8e2dcfd7e7e24b1ca76c1193f645902b) {if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceof umiHierarchyElement) {$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v8e2dcfd7e7e24b1ca76c1193f645902b, true, true);}if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceof umiHierarchyElement) continue;$v7552cd149af7495ee7d8225974e50f80 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getId();if (isset($v2a05e4f9b3949ba2c0b7d413a0863c3f[$v7552cd149af7495ee7d8225974e50f80])) {unset($v2a05e4f9b3949ba2c0b7d413a0863c3f[$v7552cd149af7495ee7d8225974e50f80]);}$vc9e9a848920877e76685b2e4e76de38d = umiHierarchy::getInstance()->getMaxNestingLevel($v7552cd149af7495ee7d8225974e50f80);if (!$vc9e9a848920877e76685b2e4e76de38d) continue;for ($v865c0c0b4ab0e063e5caa3387c1a8741 = 1;$v865c0c0b4ab0e063e5caa3387c1a8741 <= $vc9e9a848920877e76685b2e4e76de38d;$v865c0c0b4ab0e063e5caa3387c1a8741++) {$v8be74552df93e31bbdd6b36ed74bdb6a = new selector('pages');$v8be74552df93e31bbdd6b36ed74bdb6a->option('return')->value('id');$v8be74552df93e31bbdd6b36ed74bdb6a->where('hierarchy')->page($v7552cd149af7495ee7d8225974e50f80)->childs($v865c0c0b4ab0e063e5caa3387c1a8741);foreach($v8be74552df93e31bbdd6b36ed74bdb6a->result() as $v9b207167e5381c47682c6b4f58a623fb) {if (isset($v2a05e4f9b3949ba2c0b7d413a0863c3f[$v9b207167e5381c47682c6b4f58a623fb['id']])) {unset($v2a05e4f9b3949ba2c0b7d413a0863c3f[$v9b207167e5381c47682c6b4f58a623fb['id']]);}}}}}else {$v2a05e4f9b3949ba2c0b7d413a0863c3f = unserialize(file_get_contents($v8e9e791281df5188f135edcc30eaa97e . 'array'));}$v480d1b61a0432d1319f7504a3d7318dd = false;if(getRequest('as_file') !== '0') {$v480d1b61a0432d1319f7504a3d7318dd = (int) mainConfiguration::getInstance()->get("modules", "exchange.export.limit");if($v480d1b61a0432d1319f7504a3d7318dd <= 0) $v480d1b61a0432d1319f7504a3d7318dd = 25;}$ved780287e302ec3b9fd3c5e78771919f = new xmlExporter($v7c95caafbd5e4b5db3977617a0498de6, $v480d1b61a0432d1319f7504a3d7318dd);if(getRequest('as_file') !== '0') {$ved780287e302ec3b9fd3c5e78771919f->addElements(array_slice($v2a05e4f9b3949ba2c0b7d413a0863c3f, 0, $v480d1b61a0432d1319f7504a3d7318dd + 1));}else {$ved780287e302ec3b9fd3c5e78771919f->addElements($v2a05e4f9b3949ba2c0b7d413a0863c3f);}$ved780287e302ec3b9fd3c5e78771919f->setIgnoreRelations();$v9a09b4dfda82e3e665e31092d1c3ec8d = $ved780287e302ec3b9fd3c5e78771919f->execute();$v10ae9fc7d453b0dd525d0edf2ede7961 = $this->getCSV($v9a09b4dfda82e3e665e31092d1c3ec8d, $v8e9e791281df5188f135edcc30eaa97e);$ve1260894f59eeae98c8440899de4df8d = fopen($v8e9e791281df5188f135edcc30eaa97e, 'a');foreach ($v10ae9fc7d453b0dd525d0edf2ede7961 as $vd05b6ed7d2345020440df396d6da7f73) {$vb45cffe084dd3d20d928bee85e7b0f21 = "\"" . implode('";"', $vd05b6ed7d2345020440df396d6da7f73) . "\"\n";if ($vb45cffe084dd3d20d928bee85e7b0f21 = @iconv('utf-8', 'windows-1251//IGNORE', $vb45cffe084dd3d20d928bee85e7b0f21)) {fputs($ve1260894f59eeae98c8440899de4df8d, $vb45cffe084dd3d20d928bee85e7b0f21);}}fclose($ve1260894f59eeae98c8440899de4df8d);$vaa8fb77e57d1ca18d593e909729871fe = $ved780287e302ec3b9fd3c5e78771919f->isCompleted();if(getRequest('as_file') !== '0') {$vb0344c1ba7e309d30b65650c47a422c3 = array_keys($ved780287e302ec3b9fd3c5e78771919f->getExportedElements());$v2a05e4f9b3949ba2c0b7d413a0863c3f = array_diff($v2a05e4f9b3949ba2c0b7d413a0863c3f, $vb0344c1ba7e309d30b65650c47a422c3);if (count($v2a05e4f9b3949ba2c0b7d413a0863c3f)) {$this->completed = false;file_put_contents($v8e9e791281df5188f135edcc30eaa97e . 'array', serialize($v2a05e4f9b3949ba2c0b7d413a0863c3f));}else {if (file_exists($v8e9e791281df5188f135edcc30eaa97e . 'array')) unlink ($v8e9e791281df5188f135edcc30eaa97e . 'array');$this->completed = true;}}else {$this->completed = $vaa8fb77e57d1ca18d593e909729871fe;}if ($this->completed) {$v10ae9fc7d453b0dd525d0edf2ede7961 = unserialize(file_get_contents($v8e9e791281df5188f135edcc30eaa97e . ".tmp"));$ve1260894f59eeae98c8440899de4df8d = fopen($v8e9e791281df5188f135edcc30eaa97e . ".tmp", 'w');foreach ($v10ae9fc7d453b0dd525d0edf2ede7961 as $vd05b6ed7d2345020440df396d6da7f73) {$vb45cffe084dd3d20d928bee85e7b0f21 = "\"" . implode('";"', $vd05b6ed7d2345020440df396d6da7f73) . "\"\n";if ($vb45cffe084dd3d20d928bee85e7b0f21 = @iconv('utf-8', 'windows-1251//IGNORE', $vb45cffe084dd3d20d928bee85e7b0f21)) {fwrite($ve1260894f59eeae98c8440899de4df8d, $vb45cffe084dd3d20d928bee85e7b0f21);}}$vd11e7941c75eaca417c6af0d0f9d7d45 = fopen($v8e9e791281df5188f135edcc30eaa97e, 'r');while ($vb45cffe084dd3d20d928bee85e7b0f21 = fgets($vd11e7941c75eaca417c6af0d0f9d7d45)) {if (substr_count($vb45cffe084dd3d20d928bee85e7b0f21, '"') % 2 != 0) {$v132ae73e31f76d8b94f87fe5ccfe28c9 = false;while (!feof($vd11e7941c75eaca417c6af0d0f9d7d45) && !$v132ae73e31f76d8b94f87fe5ccfe28c9) {$vb45cffe084dd3d20d928bee85e7b0f21 .= fgets($vd11e7941c75eaca417c6af0d0f9d7d45);if (substr_count($vb45cffe084dd3d20d928bee85e7b0f21, '"') % 2 == 0) {$v132ae73e31f76d8b94f87fe5ccfe28c9 = true;}}}fwrite($ve1260894f59eeae98c8440899de4df8d, $vb45cffe084dd3d20d928bee85e7b0f21);}fclose($ve1260894f59eeae98c8440899de4df8d);fclose($vd11e7941c75eaca417c6af0d0f9d7d45);unlink($v8e9e791281df5188f135edcc30eaa97e);rename($v8e9e791281df5188f135edcc30eaa97e . ".tmp", $v8e9e791281df5188f135edcc30eaa97e);}chmod($v8e9e791281df5188f135edcc30eaa97e, 0777);return false;}public function getFileExt() {return "csv";}protected function getCSV($v9a09b4dfda82e3e665e31092d1c3ec8d, $v47826cacc65c665212b821e6ff80b9b0) {$result = array();if (file_exists($v47826cacc65c665212b821e6ff80b9b0 . ".tmp")) {$va3cbc3f9d0ce2f2c1554e1b671d71d9c = unserialize(file_get_contents($v47826cacc65c665212b821e6ff80b9b0 . ".tmp"));$va8998c31a141924d06220074fcdc6925 = $va3cbc3f9d0ce2f2c1554e1b671d71d9c[0];$v151bef00012561d5b1fa51ab10913718 = $va3cbc3f9d0ce2f2c1554e1b671d71d9c[1];$vd14a8022b085f9ef19d479cbdd581127 = $va3cbc3f9d0ce2f2c1554e1b671d71d9c[2];}else {$va8998c31a141924d06220074fcdc6925 = array(     0 => 'id',     1 => 'name',     2 => 'type-id',     3 => 'is-active',     4 => 'template-id',     5 => 'parent-id'    );$v151bef00012561d5b1fa51ab10913718 = array(     0 => 'id',     1 => 'Наименование',     2 => 'Идентификатор типа',     3 => 'Активность',     4 => 'Идентификатор шаблона',     5 => 'id родительской страницы'    );$vd14a8022b085f9ef19d479cbdd581127 = array(     0 => 'native',     1 => 'native',     2 => 'native',     3 => 'native',     4 => 'native',     5 => 'native'    );}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);if ($v3d788fa62d7c185a1bee4c9147ee1091->query('//pages/page')->length) {$vb3b32a2d422265cd25c3323ed0157f81 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//pages/page');$v865c0c0b4ab0e063e5caa3387c1a8741 = 3;foreach ($vb3b32a2d422265cd25c3323ed0157f81 as $v71860c77c6745379b0d44304d66b6a13) {$v8024e258c6705fdca4821bb635c93534 = array();$v8024e258c6705fdca4821bb635c93534[0] = $v71860c77c6745379b0d44304d66b6a13->getAttribute('id');$v8024e258c6705fdca4821bb635c93534[1] = $v71860c77c6745379b0d44304d66b6a13->getElementsByTagName('name')->item(0)->nodeValue;$v8024e258c6705fdca4821bb635c93534[2] = $v71860c77c6745379b0d44304d66b6a13->getAttribute('type-id');$v8024e258c6705fdca4821bb635c93534[3] = $v71860c77c6745379b0d44304d66b6a13->getAttribute('is-active');if ($v71860c77c6745379b0d44304d66b6a13->getElementsByTagName('template')->length) {$v8024e258c6705fdca4821bb635c93534[4] = $v71860c77c6745379b0d44304d66b6a13->getElementsByTagName('template')->item(0)->getAttribute('id');}else {$v8024e258c6705fdca4821bb635c93534[4]='';}$v8024e258c6705fdca4821bb635c93534[5] = $v71860c77c6745379b0d44304d66b6a13->hasAttribute('parentId') ? $v71860c77c6745379b0d44304d66b6a13->getAttribute('parentId') : 0;$v74693d2fc58b46bd06410f278e39aa71 = $v71860c77c6745379b0d44304d66b6a13->getElementsByTagName('property');foreach ($v74693d2fc58b46bd06410f278e39aa71 as $v1a8db4c996d8ed8289da5f957879ab94) {$v46b9e6004c49d9cc040029c197cab278 = $v1a8db4c996d8ed8289da5f957879ab94->getAttribute('name');$va797cc58f41a2e26d5218b5f242e7451 = $v1a8db4c996d8ed8289da5f957879ab94->getAttribute('type');if(in_array($va797cc58f41a2e26d5218b5f242e7451, array('optioned', 'symlink'))) continue;if ($va797cc58f41a2e26d5218b5f242e7451 == 'relation') {if ($v1a8db4c996d8ed8289da5f957879ab94->hasAttribute('multiple') && $v1a8db4c996d8ed8289da5f957879ab94->getAttribute('multiple') == 'multiple') {$va797cc58f41a2e26d5218b5f242e7451 = 'multiple-relation';}$v2063c1608d6e0baf80249c42e2be5804 = $v1a8db4c996d8ed8289da5f957879ab94->getElementsByTagName('value')->item(0);$v4af9064d968e82ad420bae9e644ce216 = $v2063c1608d6e0baf80249c42e2be5804->getElementsByTagName('item');$vafd40dce490ea113be83c89ca7f3052d = array();if($v4af9064d968e82ad420bae9e644ce216->length) {for($v8ce4b16b22b58894aa86c421e8759df3 = 0;$v8ce4b16b22b58894aa86c421e8759df3 < $v4af9064d968e82ad420bae9e644ce216->length ;$v8ce4b16b22b58894aa86c421e8759df3++) {$vafd40dce490ea113be83c89ca7f3052d[] = $v4af9064d968e82ad420bae9e644ce216->item($v8ce4b16b22b58894aa86c421e8759df3)->getAttribute('name');}}$vafd40dce490ea113be83c89ca7f3052d = implode(',', $vafd40dce490ea113be83c89ca7f3052d);}elseif($va797cc58f41a2e26d5218b5f242e7451 == 'tags') {$vafd40dce490ea113be83c89ca7f3052d = $v1a8db4c996d8ed8289da5f957879ab94->getElementsByTagName('combined')->item(0)->nodeValue;}else {$vafd40dce490ea113be83c89ca7f3052d = $v1a8db4c996d8ed8289da5f957879ab94->getElementsByTagName('value')->item(0)->nodeValue;}$v3c6e0b8a9c15224a8228b9a98ca1531d = array_search($v46b9e6004c49d9cc040029c197cab278, $va8998c31a141924d06220074fcdc6925);if (!$v3c6e0b8a9c15224a8228b9a98ca1531d) {$va8998c31a141924d06220074fcdc6925[] = $v46b9e6004c49d9cc040029c197cab278;$v3c6e0b8a9c15224a8228b9a98ca1531d = array_search($v46b9e6004c49d9cc040029c197cab278, $va8998c31a141924d06220074fcdc6925);$vd14a8022b085f9ef19d479cbdd581127[$v3c6e0b8a9c15224a8228b9a98ca1531d] = $va797cc58f41a2e26d5218b5f242e7451;$v98f4c07b477f916e418baf130893df93 = $v1a8db4c996d8ed8289da5f957879ab94->getElementsByTagName('title')->item(0)->nodeValue;$v151bef00012561d5b1fa51ab10913718[$v3c6e0b8a9c15224a8228b9a98ca1531d] = $v98f4c07b477f916e418baf130893df93;}$v8024e258c6705fdca4821bb635c93534[$v3c6e0b8a9c15224a8228b9a98ca1531d] = $vafd40dce490ea113be83c89ca7f3052d;}$v14f802e1fba977727845e8872c1743a7 = array_keys($va8998c31a141924d06220074fcdc6925);foreach ($v14f802e1fba977727845e8872c1743a7 as $v3c6e0b8a9c15224a8228b9a98ca1531d) {if (!array_key_exists($v3c6e0b8a9c15224a8228b9a98ca1531d, $v8024e258c6705fdca4821bb635c93534)) {$v8024e258c6705fdca4821bb635c93534[$v3c6e0b8a9c15224a8228b9a98ca1531d] ='';}else {$v8024e258c6705fdca4821bb635c93534[$v3c6e0b8a9c15224a8228b9a98ca1531d] = str_replace('"', '""', $v8024e258c6705fdca4821bb635c93534[$v3c6e0b8a9c15224a8228b9a98ca1531d]);}}ksort($v8024e258c6705fdca4821bb635c93534);$result[$v865c0c0b4ab0e063e5caa3387c1a8741] = $v8024e258c6705fdca4821bb635c93534;$v865c0c0b4ab0e063e5caa3387c1a8741++;}}$va3cbc3f9d0ce2f2c1554e1b671d71d9c = array();$va3cbc3f9d0ce2f2c1554e1b671d71d9c[0] = $va8998c31a141924d06220074fcdc6925;$va3cbc3f9d0ce2f2c1554e1b671d71d9c[1] = $v151bef00012561d5b1fa51ab10913718;$va3cbc3f9d0ce2f2c1554e1b671d71d9c[2] = $vd14a8022b085f9ef19d479cbdd581127;file_put_contents($v47826cacc65c665212b821e6ff80b9b0 . ".tmp", serialize($va3cbc3f9d0ce2f2c1554e1b671d71d9c));return $result;}}?>