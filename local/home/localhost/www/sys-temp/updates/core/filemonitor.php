#!/usr/local/bin/php
<?php
 error_reporting(E_ALL);ini_set("display_errors", 1);include(dirname(__FILE__) . '/standalone.php');class FilesMonitor {protected $initialDir, $logFile, $excludes = array();public function __construct($v3b5ff77b5246280387620bdbcb5ced4a, $vec228b97c97d55a0ff1de131f1b9d220, array $v7d1b98ec98cdcfba1cb39cb36a9f9ec0) {$this->initialDir = $v3b5ff77b5246280387620bdbcb5ced4a;$this->logFile = $vec228b97c97d55a0ff1de131f1b9d220;foreach ($v7d1b98ec98cdcfba1cb39cb36a9f9ec0 as &$v18acedb191d664dc01b71835ae33caef) {$v18acedb191d664dc01b71835ae33caef = str_replace('~', $this->initialDir, $v18acedb191d664dc01b71835ae33caef);}unset($v18acedb191d664dc01b71835ae33caef);$this->excludes = $v7d1b98ec98cdcfba1cb39cb36a9f9ec0;}protected function isExcluded($vd6fe1d0be6347b8ef2427fa629c04485) {foreach ($this->excludes as $v18acedb191d664dc01b71835ae33caef) {if (preg_match('|' . $v18acedb191d664dc01b71835ae33caef . '|', $vd6fe1d0be6347b8ef2427fa629c04485)) {return true;}}return false;}protected function flushLog($v78e731027d8fd50ed642340b7c9a63b3) {echo "{$v78e731027d8fd50ed642340b7c9a63b3}\n";}public function getMD5($v736007832d2167baaae763fd3a3f3cf1, $vf06f23cba56ddbfebae8ef9c5f0d7c36 = array()){$vdc1d71bbb5c4d2a5e936db79ef10c19f = '';if ($ve1260894f59eeae98c8440899de4df8d = opendir($v736007832d2167baaae763fd3a3f3cf1)) {while (false !== ($v1043bfc77febe75fafec0c4309faccf1 = readdir($ve1260894f59eeae98c8440899de4df8d))) {if ($v1043bfc77febe75fafec0c4309faccf1 != "." && $v1043bfc77febe75fafec0c4309faccf1 != "..") {$vb5ec7908404735697247689650cdd54c = $v736007832d2167baaae763fd3a3f3cf1 . "/" . $v1043bfc77febe75fafec0c4309faccf1;if ($this->isExcluded($vb5ec7908404735697247689650cdd54c)) {$this->flushLog("{$vb5ec7908404735697247689650cdd54c} был исключен из проверки\n");continue;}if (is_dir($vb5ec7908404735697247689650cdd54c)) {$vdc1d71bbb5c4d2a5e936db79ef10c19f .= $this->getMD5($vb5ec7908404735697247689650cdd54c, $vf06f23cba56ddbfebae8ef9c5f0d7c36);}else {if (!empty($vf06f23cba56ddbfebae8ef9c5f0d7c36) && !in_array($vb5ec7908404735697247689650cdd54c, $vf06f23cba56ddbfebae8ef9c5f0d7c36)) {$vdc1d71bbb5c4d2a5e936db79ef10c19f .= "Файл {$vb5ec7908404735697247689650cdd54c} был создан<br/>";$this->flushLog("Файл {$vb5ec7908404735697247689650cdd54c} был создан\n");}file_put_contents($this->logFile, "{$vb5ec7908404735697247689650cdd54c};" . md5_file($vb5ec7908404735697247689650cdd54c) . "\n", FILE_APPEND);}}}closedir($ve1260894f59eeae98c8440899de4df8d);}return $vdc1d71bbb5c4d2a5e936db79ef10c19f;}public function checkMD5() {$vdc1d71bbb5c4d2a5e936db79ef10c19f = "";$v45b963397aa40d4a0063e0d85e4fe7a1 = array();if ($ve1260894f59eeae98c8440899de4df8d = fopen($this->logFile, "r")) {while (($v6438c669e0d0de98e6929c2cc0fac474 = fgets($ve1260894f59eeae98c8440899de4df8d)) !== false) {$v1ded0622d3320f26b47f514fabab54f1 = explode(';', $v6438c669e0d0de98e6929c2cc0fac474);$v47826cacc65c665212b821e6ff80b9b0 = trim($v1ded0622d3320f26b47f514fabab54f1[0]);$v1bc29b36f623ba82aaf6724fd3b16718 = trim($v1ded0622d3320f26b47f514fabab54f1[1]);if (file_exists($v47826cacc65c665212b821e6ff80b9b0)) {if ($v1bc29b36f623ba82aaf6724fd3b16718 != md5_file($v47826cacc65c665212b821e6ff80b9b0)) {$vdc1d71bbb5c4d2a5e936db79ef10c19f .= "Файл {$v47826cacc65c665212b821e6ff80b9b0} был изменен<br/>";$this->flushLog("Файл {$v47826cacc65c665212b821e6ff80b9b0} был изменен\n");}$v45b963397aa40d4a0063e0d85e4fe7a1[] = $v47826cacc65c665212b821e6ff80b9b0;}else {$vdc1d71bbb5c4d2a5e936db79ef10c19f .= "Файл {$v47826cacc65c665212b821e6ff80b9b0} был удален<br/>";$this->flushLog("Файл {$v47826cacc65c665212b821e6ff80b9b0} был удален\n");}}fclose($ve1260894f59eeae98c8440899de4df8d);}return array($vdc1d71bbb5c4d2a5e936db79ef10c19f, $v45b963397aa40d4a0063e0d85e4fe7a1);}public function checkFileSystem() {$vec228b97c97d55a0ff1de131f1b9d220 = $this->logFile;$v3b5ff77b5246280387620bdbcb5ced4a = $this->initialDir;if(file_exists($vec228b97c97d55a0ff1de131f1b9d220)) {$vcaf9b6b99962bf5c2264824231d7a40c = $this->checkMD5();$vdc1d71bbb5c4d2a5e936db79ef10c19f = $vcaf9b6b99962bf5c2264824231d7a40c[0];$vf06f23cba56ddbfebae8ef9c5f0d7c36 = $vcaf9b6b99962bf5c2264824231d7a40c[1];unlink($vec228b97c97d55a0ff1de131f1b9d220);$vdc1d71bbb5c4d2a5e936db79ef10c19f .= $this->getMD5($v3b5ff77b5246280387620bdbcb5ced4a, $vf06f23cba56ddbfebae8ef9c5f0d7c36);if (strlen($vdc1d71bbb5c4d2a5e936db79ef10c19f)) {$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();$v37a53c32cfc48178bd7c296e68557bcb = $vb1444fb0c07653567ad325aa25d4e37a->getVal("//settings/admin_email");$v0c83f57c786a0b4a39efab23731c7ebc = regedit::getInstance()->getVal("//settings/email_from");$vf003984af6466a03625ae1b386ad8977 = regedit::getInstance()->getVal("//settings/fio_from");$v2cfbe88d0c6458e37716f4356f20a9a7 = new umiMail();$v2cfbe88d0c6458e37716f4356f20a9a7->addRecipient($v37a53c32cfc48178bd7c296e68557bcb);$v2cfbe88d0c6458e37716f4356f20a9a7->setFrom($v0c83f57c786a0b4a39efab23731c7ebc, $vf003984af6466a03625ae1b386ad8977);$v2cfbe88d0c6458e37716f4356f20a9a7->setSubject('Изменения в файловой системе');$v2cfbe88d0c6458e37716f4356f20a9a7->setContent($vdc1d71bbb5c4d2a5e936db79ef10c19f);$v2cfbe88d0c6458e37716f4356f20a9a7->commit();$v2cfbe88d0c6458e37716f4356f20a9a7->send();$this->flushLog("Письмо с изменениями было отправлено на e-mail {$v37a53c32cfc48178bd7c296e68557bcb}\n");}else {$this->flushLog("Изменений не было\n");}}else {$this->getMD5($v3b5ff77b5246280387620bdbcb5ced4a);$this->flushLog("По директоиии {$v3b5ff77b5246280387620bdbcb5ced4a} был составлен лог\n");}}}if (isset($_SERVER['HTTP_HOST'])) exit();$v7d1b98ec98cdcfba1cb39cb36a9f9ec0 = array(  '^~/developerTools',  '^~/sys-temp',  '^~/images',  '^~/files',  '^~/filemonitor.php',  '\.svn$' );$vec228b97c97d55a0ff1de131f1b9d220 = CURRENT_WORKING_DIR . '/sys-temp/filemonitor.log';$v3b5ff77b5246280387620bdbcb5ced4a = CURRENT_WORKING_DIR;$v3a980dd4a0e7ece6cff82de3babb5bc0 = new FilesMonitor($v3b5ff77b5246280387620bdbcb5ced4a, $vec228b97c97d55a0ff1de131f1b9d220, $v7d1b98ec98cdcfba1cb39cb36a9f9ec0);$v3a980dd4a0e7ece6cff82de3babb5bc0->checkFileSystem();?>