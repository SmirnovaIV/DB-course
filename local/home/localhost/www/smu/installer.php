<?php
 error_reporting(0);ini_set('display_errors', 0);set_time_limit(0);if ((isset($_REQUEST['step'])&&$_REQUEST['step']=='ping')&&(isset($_REQUEST['guiUpdate'])&&$_REQUEST['guiUpdate']=='true')) {header('Content-Type: text/xml; charset=utf-8');echo "<result>ok</result>";die();}if (isset($_SERVER['DOCUMENT_ROOT']) && strlen($_SERVER['DOCUMENT_ROOT'])) {define("INSTALLER_CLI_MODE", false);}else {define("INSTALLER_CLI_MODE", true);}define("INSTALLER_DEBUG", false);define("_C_REQUIRES", true);define('_C_ERRORS', true);define('CRON', true);define('DEBUG', true);define('UMICMS_CLI_MODE', INSTALLER_CLI_MODE);if(INSTALLER_CLI_MODE) {function exception_error_handler($v70106d0d821513f45702b7d25664ab7c, $v809b1abe3f111fd3bb1a54c62706129f, $v1407f5af8e27ad3df1c3300918c80813, $vc2d4b0be0178288d69e1fbfd34098cc3) {try {throw new ErrorException($v809b1abe3f111fd3bb1a54c62706129f, 0, $v70106d0d821513f45702b7d25664ab7c, $v1407f5af8e27ad3df1c3300918c80813, $vc2d4b0be0178288d69e1fbfd34098cc3);}catch (ErrorException $v42552b1f133f9f8eb406d4f306ea9fd1) {$v6e2baaf3b97dbeef01c0043275f9a0e7 = "Ошибка установки #{$v70106d0d821513f45702b7d25664ab7c}: \"" . $v809b1abe3f111fd3bb1a54c62706129f . "\" в строке " . $vc2d4b0be0178288d69e1fbfd34098cc3 . " файла " . $v1407f5af8e27ad3df1c3300918c80813 . "\n";if ($v70106d0d821513f45702b7d25664ab7c!=0) {$v6e2baaf3b97dbeef01c0043275f9a0e7.= "Подробнее об ошибке http://errors.umi-cms.ru/{$v70106d0d821513f45702b7d25664ab7c}/\n";}echo $v6e2baaf3b97dbeef01c0043275f9a0e7;}}set_error_handler("exception_error_handler");function exception_handler(Exception $v42552b1f133f9f8eb406d4f306ea9fd1) {$v70106d0d821513f45702b7d25664ab7c = $v42552b1f133f9f8eb406d4f306ea9fd1->getCode();$v6e2baaf3b97dbeef01c0043275f9a0e7 = "Критическая ошибка установки #{$v70106d0d821513f45702b7d25664ab7c}: \"" . $v42552b1f133f9f8eb406d4f306ea9fd1->getMessage() . "\" в строке " . $v42552b1f133f9f8eb406d4f306ea9fd1->getLine() . " файла " . $v42552b1f133f9f8eb406d4f306ea9fd1->getFile() . "\n";if ($v70106d0d821513f45702b7d25664ab7c!=0) {$v6e2baaf3b97dbeef01c0043275f9a0e7.= "Подробнее об ошибке http://errors.umi-cms.ru/{$v70106d0d821513f45702b7d25664ab7c}/\n";}if ($v0666f0acdeed38d4cd9084ade1739498 = fopen("php://stderr", "w")) {fputs($v0666f0acdeed38d4cd9084ade1739498, $v6e2baaf3b97dbeef01c0043275f9a0e7);}die();}set_exception_handler('exception_handler');$args = parse_argv($_SERVER['argv']);}else {$args = $_REQUEST;header("Content-type: text/xml; charset=utf-8");}$v9133e46f372a4b065bffcf76edca9565 = true;if (in_array(substr(dirname(__FILE__), -4, 4), array('/smu', '\smu'))) {define("CURRENT_WORKING_DIR", realpath(dirname(__FILE__).'/..'));if (is_file(CURRENT_WORKING_DIR.'/installed')) {$v9133e46f372a4b065bffcf76edca9565 = false;}}else {define("CURRENT_WORKING_DIR", realpath(dirname(__FILE__)));}$v2764ca9d34e90313978d044f27ae433b = isset($args['step']) ? strtolower(trim($args['step'])) : 'install-run';$v857a5246dff0c3c79e476b004684f6d3 = './sys-temp/updates/';umask(0);$vc11d174dbd2e5f91a9c5b654b9d58d2c = getcwd();chdir(CURRENT_WORKING_DIR);$v97384261b8bbf966df16e5ad509922db = new umiInstallExecutor($v857a5246dff0c3c79e476b004684f6d3, $v9133e46f372a4b065bffcf76edca9565, $args);$v97384261b8bbf966df16e5ad509922db->run($v2764ca9d34e90313978d044f27ae433b, INSTALLER_CLI_MODE, $args);chdir($vc11d174dbd2e5f91a9c5b654b9d58d2c);exit();class umiInstallExecutor {const BUFFER_SIZE = 128;const STATE_FILE_NAME = ".isf";private $step = 'run';private $cli_mode = true;private $settings = null;private $params = array();private $connection = null;private $install_mode = false;static private $split_block_size;static private $state = false;static private $log   = array();private $temp_dir = "";private function flushLog($v6e2baaf3b97dbeef01c0043275f9a0e7) {if ($this->cli_mode) {echo $v6e2baaf3b97dbeef01c0043275f9a0e7, "\n";}else {self::$log[] = $v6e2baaf3b97dbeef01c0043275f9a0e7;}}private function appendLog($v7aea2552dfe7eb84b9443b6fc9ba6e01) {if($this->cli_mode) return;self::$log = array_merge(self::$log, $v7aea2552dfe7eb84b9443b6fc9ba6e01);}private function getConfigOption($v73d5342eba070f636ac3246f319bf77f, $vef3e30e070f70244fd6578d88a6b77ac, $vc21f969b5f03d33d43e04f8f136e7682 = null, $vbd5239d728d46691ef17539173044de7 = false, $v38b423f6471e0c7127d97cc882038f9f = 0) {if (is_null($this->settings)) $this->getInstallConfig( isset($vbd5239d728d46691ef17539173044de7)&&$vbd5239d728d46691ef17539173044de7!==false );if (isset($this->settings[$v73d5342eba070f636ac3246f319bf77f][$vef3e30e070f70244fd6578d88a6b77ac])) {return $this->settings[$v73d5342eba070f636ac3246f319bf77f][$vef3e30e070f70244fd6578d88a6b77ac];}else {if ($vbd5239d728d46691ef17539173044de7) {throw new Exception($vbd5239d728d46691ef17539173044de7, $v38b423f6471e0c7127d97cc882038f9f);}return $vc21f969b5f03d33d43e04f8f136e7682;}}private function getInstallConfig($v959b7175f88493905e3c324c2bf6f97d=true) {if (!is_null($this->settings)) return $this->settings;if ($this->install_mode) {$v8f24e0f08c5da0d887a794f2bb8f7bfe = dirname(__FILE__) . "/install.ini";}else {$v8f24e0f08c5da0d887a794f2bb8f7bfe = CURRENT_WORKING_DIR . "/install.ini";}if (!is_file($v8f24e0f08c5da0d887a794f2bb8f7bfe)) {if ($v959b7175f88493905e3c324c2bf6f97d) {throw new Exception("Не найден файл настроек для установки install.ini");}else {return false;}}$this->settings = parse_ini_file($v8f24e0f08c5da0d887a794f2bb8f7bfe, true);}private function checkDone($vea9f6aca279138c58f705c8d4cb4b8ce) {return isset(self::$state[$vea9f6aca279138c58f705c8d4cb4b8ce]) && self::$state[$vea9f6aca279138c58f705c8d4cb4b8ce];}private function setDone($vea9f6aca279138c58f705c8d4cb4b8ce, $v6b2ded51d81a4403d8a4bd25fa1e57ee = true) {self::$state[$vea9f6aca279138c58f705c8d4cb4b8ce] = $v6b2ded51d81a4403d8a4bd25fa1e57ee;$this->saveState();}private function getComponentOffset($v700c216fb376666eaeda0c892e8bdc09) {return (isset(self::$state['@components']) && isset(self::$state['@components'][$v700c216fb376666eaeda0c892e8bdc09]))     ?      (int) self::$state['@components'][$v700c216fb376666eaeda0c892e8bdc09]     :      0;}private function loadState() {$v60d31eb37595dd44584be5ef363283e3 = $this->temp_dir . umiInstallExecutor::STATE_FILE_NAME;if (file_exists($v60d31eb37595dd44584be5ef363283e3) && $v4a8a08f09d37b73795649038408b5f33 = file_get_contents($v60d31eb37595dd44584be5ef363283e3)) {self::$state = @unserialize($v4a8a08f09d37b73795649038408b5f33);}if (!self::$state) self::$state = array();}private function saveState() {$v60d31eb37595dd44584be5ef363283e3 = $this->temp_dir . umiInstallExecutor::STATE_FILE_NAME;file_put_contents($v60d31eb37595dd44584be5ef363283e3, serialize(self::$state));}private function getParam($vb068931cc450442b63f5b3d276ea4297) {return isset($this->params[$vb068931cc450442b63f5b3d276ea4297]) ? $this->params[$vb068931cc450442b63f5b3d276ea4297] : null;}private function setComponentOffset($v700c216fb376666eaeda0c892e8bdc09, $v7a86c157ee9713c34fbd7a1ee40f0c5a) {if (!isset(self::$state['@components']) || !is_array(self::$state['@components'])) self::$state['@components'] = array();self::$state['@components'][$v700c216fb376666eaeda0c892e8bdc09] = (int) $v7a86c157ee9713c34fbd7a1ee40f0c5a;$this->saveState();}public function __construct($v857a5246dff0c3c79e476b004684f6d3, $v9133e46f372a4b065bffcf76edca9565 = true, $v21ffce5b8a6cc8cc6a41448dd69623c9 = array()) {$this->temp_dir = $v857a5246dff0c3c79e476b004684f6d3;$this->install_mode = $v9133e46f372a4b065bffcf76edca9565;if (!defined("PHP_FILES_ACCESS_MODE")) {$v15d61712450a686a7f365adf4fef581f = $this->getConfigOption("SETUP", "php_files_access_mode", false);if (!$v15d61712450a686a7f365adf4fef581f) {if (INSTALLER_CLI_MODE || !$this->install_mode) {$v15d61712450a686a7f365adf4fef581f = substr(decoct(fileperms(__FILE__)), -4, 4);}else {$v15d61712450a686a7f365adf4fef581f = substr(decoct(fileperms(CURRENT_WORKING_DIR."/install.php")), -4, 4);}}define("PHP_FILES_ACCESS_MODE", octdec($v15d61712450a686a7f365adf4fef581f));}if (!self::$split_block_size) {self::$split_block_size = $this->getConfigOption("SETUP", "split_block_size", 100);}if(self::$state === false) {$this->loadState();}}public function __destruct() {}private function getDummyInfo() {$veb5e48e74123cacc52761302ea4a7d22 = array();$veb5e48e74123cacc52761302ea4a7d22['begin'] = '########## UMI.CMS - update begin ##########';$veb5e48e74123cacc52761302ea4a7d22['end'] =   '########### UMI.CMS - update end ###########';$veb5e48e74123cacc52761302ea4a7d22['dummyname'] = "dummy.php";$veb5e48e74123cacc52761302ea4a7d22['allow_array'] = array("install.php", "installer.php", "smu/install.php", "smu/installer.php", "umi_smt.php");return $veb5e48e74123cacc52761302ea4a7d22;}private function ht_create_dummy($vb1e97f49f558699c791bc3fab053b803) {$vd4721a6bab8c7dee78cc25f7fa154bfc = $this->getDownloader();$v275876e34cf609db118f3d84b799a790 = $vd4721a6bab8c7dee78cc25f7fa154bfc->get_file(base64_decode("aHR0cDovL3d3dy5pbnN0YWxsLnVtaS1jbXMucnUvZmlsZXMvZHVtbXkuaHRtbA=="));file_put_contents($vb1e97f49f558699c791bc3fab053b803, $v275876e34cf609db118f3d84b799a790);}private function setUpdateMode() {if ($this->checkDone(__METHOD__)) {return true;}$veb5e48e74123cacc52761302ea4a7d22 = $this->getDummyInfo();$this->ht_create_dummy(CURRENT_WORKING_DIR.'/'.$veb5e48e74123cacc52761302ea4a7d22['dummyname']);$v275876e34cf609db118f3d84b799a790 = array();if ( is_array($veb5e48e74123cacc52761302ea4a7d22['allow_array']) && 0<count($veb5e48e74123cacc52761302ea4a7d22['allow_array']) ) {foreach($veb5e48e74123cacc52761302ea4a7d22['allow_array'] as $v8c7dd922ad47494fc02c388e12c00eac) {$v275876e34cf609db118f3d84b799a790[] = 'RewriteCond %{REQUEST_URI} !/'.$v8c7dd922ad47494fc02c388e12c00eac.'$';}}$v275876e34cf609db118f3d84b799a790[] = 'RewriteCond %{REQUEST_URI} !/'.$veb5e48e74123cacc52761302ea4a7d22['dummyname'].'$';$v275876e34cf609db118f3d84b799a790[] = 'RewriteRule ^.*$ /'.$veb5e48e74123cacc52761302ea4a7d22['dummyname'].' [L]';$v5b198a570a5de3ae01532f954a3a9744 = array();if (file_exists(CURRENT_WORKING_DIR.'/.htaccess')) {$v5b198a570a5de3ae01532f954a3a9744 = $this->ht_get_clean_array(CURRENT_WORKING_DIR.'/.htaccess', $veb5e48e74123cacc52761302ea4a7d22);}$result = array();$v0b4a1297fe0ceea583d34bbca11c8805 = true;if (count($v5b198a570a5de3ae01532f954a3a9744)>0) {foreach($v5b198a570a5de3ae01532f954a3a9744 as $v6438c669e0d0de98e6929c2cc0fac474) {$result[] = $v6438c669e0d0de98e6929c2cc0fac474;if ($v0b4a1297fe0ceea583d34bbca11c8805 && preg_match('|^[ \t]*RewriteEngine|i', $v6438c669e0d0de98e6929c2cc0fac474)) {$v0b4a1297fe0ceea583d34bbca11c8805 = false;$result[] = $veb5e48e74123cacc52761302ea4a7d22['begin'];foreach($v275876e34cf609db118f3d84b799a790 as $v0aaf663ddd39615a81f716087b01a987) {$result[] = $v0aaf663ddd39615a81f716087b01a987;}$result[] = $veb5e48e74123cacc52761302ea4a7d22['end'];}}}$v9a0364b9e99bb480dd25e1f0284c8555 = implode("\r\n", $result)."\r\n";if ($v0b4a1297fe0ceea583d34bbca11c8805) {$v9a0364b9e99bb480dd25e1f0284c8555 .= $veb5e48e74123cacc52761302ea4a7d22['begin']."\r\n";$v9a0364b9e99bb480dd25e1f0284c8555 .= "RewriteEngine On\r\n";foreach($v275876e34cf609db118f3d84b799a790 as $v0aaf663ddd39615a81f716087b01a987) {$v9a0364b9e99bb480dd25e1f0284c8555 .= $v0aaf663ddd39615a81f716087b01a987."\r\n";}$v9a0364b9e99bb480dd25e1f0284c8555 .= $veb5e48e74123cacc52761302ea4a7d22['end']."\r\n";}file_put_contents(CURRENT_WORKING_DIR.'/.htaccess', $v9a0364b9e99bb480dd25e1f0284c8555);$this->setDone(__METHOD__);return true;}private function cleanUpdateMode() {$veb5e48e74123cacc52761302ea4a7d22 = $this->getDummyInfo();$v5b198a570a5de3ae01532f954a3a9744 = $this->ht_get_clean_array(CURRENT_WORKING_DIR.'/.htaccess', $veb5e48e74123cacc52761302ea4a7d22);file_put_contents(CURRENT_WORKING_DIR.'/.htaccess', implode("\r\n", $v5b198a570a5de3ae01532f954a3a9744)."\r\n");return true;}private function ht_get_clean_array($v435ed7e9f07f740abf511a62c00eef6e, $veb5e48e74123cacc52761302ea4a7d22) {$v9a0364b9e99bb480dd25e1f0284c8555 = file_get_contents($v435ed7e9f07f740abf511a62c00eef6e);$v5b198a570a5de3ae01532f954a3a9744 = array();foreach(explode("\n", $v9a0364b9e99bb480dd25e1f0284c8555) as $v86cad97d6e5003bedb49bec2a3f5c0d6=>$vc7eb2cc17348273164fa31be2b92c450) {$ve597a250e08b33df77a84c2cea63cf71 = explode(" ", trim($vc7eb2cc17348273164fa31be2b92c450));$v5b198a570a5de3ae01532f954a3a9744[] = trim($vc7eb2cc17348273164fa31be2b92c450);}if ( in_array($veb5e48e74123cacc52761302ea4a7d22['begin'], $v5b198a570a5de3ae01532f954a3a9744) && in_array($veb5e48e74123cacc52761302ea4a7d22['end'], $v5b198a570a5de3ae01532f954a3a9744) ) {$v01bc6f8efa4202821e95f4fdf6298b30 = false;foreach($v5b198a570a5de3ae01532f954a3a9744 as $v86cad97d6e5003bedb49bec2a3f5c0d6=>$vc7eb2cc17348273164fa31be2b92c450) {if ($vc7eb2cc17348273164fa31be2b92c450==$veb5e48e74123cacc52761302ea4a7d22['begin']) {$v01bc6f8efa4202821e95f4fdf6298b30 = true;unset($v5b198a570a5de3ae01532f954a3a9744[$v86cad97d6e5003bedb49bec2a3f5c0d6]);continue;}if ($vc7eb2cc17348273164fa31be2b92c450==$veb5e48e74123cacc52761302ea4a7d22['end']) {unset($v5b198a570a5de3ae01532f954a3a9744[$v86cad97d6e5003bedb49bec2a3f5c0d6]);break;}if ($v01bc6f8efa4202821e95f4fdf6298b30) {unset($v5b198a570a5de3ae01532f954a3a9744[$v86cad97d6e5003bedb49bec2a3f5c0d6]);continue;}}}return $v5b198a570a5de3ae01532f954a3a9744;}public function run($v2764ca9d34e90313978d044f27ae433b = 'install-run', $v0898b22730d57afcd394d8e4889ece4a = true, $v21ffce5b8a6cc8cc6a41448dd69623c9 = array()) {$this->step = $v2764ca9d34e90313978d044f27ae433b;$this->cli_mode = $v0898b22730d57afcd394d8e4889ece4a;$this->params = $v21ffce5b8a6cc8cc6a41448dd69623c9;$result = false;if (!$this->cli_mode && $v2764ca9d34e90313978d044f27ae433b!="check-user" && !$this->isSV() ) {if (!$this->install_mode) {$vcb5e100e5a9a3e7f6d1fd97512215282 = array("mess"=>"Недостаточно прав для выполнения обновлений!", "no"=>"15001");$v2764ca9d34e90313978d044f27ae433b = "error";}elseif (file_exists("./installed")&&is_file("./installed")) {$vcb5e100e5a9a3e7f6d1fd97512215282 = array("mess"=>"Система уже установлена.", "no"=>"15002");$v2764ca9d34e90313978d044f27ae433b = "error";}}try {switch($v2764ca9d34e90313978d044f27ae433b) {case "error": throw new Exception($vcb5e100e5a9a3e7f6d1fd97512215282["mess"], $vcb5e100e5a9a3e7f6d1fd97512215282["no"]);case "check-user":    $result = $this->checkUser();break;case "check-update":   $result = $this->checkUpdate();break;case "check-installed":   $result = $this->checkInstalled();break;case "save-settings":   $result = $this->saveSettings();break;case "install-run":    $result = $this->runInstaller();break;case "get-update-instructions": $result = $this->downloadUpdateInstructions();break;case "download-components":  $result = $this->downloadComponents();break;case "download-component":  $result = $this->downloadComponent();break;case "extract-components":  $result = $this->extractComponents();break;case "extract-component":  $result = $this->extractComponent();break;case "check-components":   $result = $this->checkComponents();break;case "check-component":   $result = $this->checkComponent();break;case "update-installer":  $result = $this->updateInstaller();break;case "update-database":   $result = $this->updateDatabaseStructure();break;case "configure":    $result = $this->configure();break;case "set-default-domain":  $result = $this->setDefaultDomain();break;case 'download-service-package': $result = $this->downloadServicePackage();break;case 'extract-service-package':  $result = $this->extractServicePackage();break;case 'write-initial-configuration': $result = $this->writeInitialConfiguration();break;case 'run-tests':     $result = $this->runTests();break;case "install-components":   $result = $this->installComponents();break;case "install-component":   $result = $this->installComponent();break;case "download-demosite":  $result = $this->downloadDemosite();break;case "extract-demosite":  $result = $this->extractDemosite();break;case "install-demosite":  $result = $this->installDemosite();break;case "check-demosite":    $result = $this->checkDemosite();break;case "backup-files":    $result = $this->backupFiles(      '/backup_files.xml', '/umibackup', array('.'), array('php', 'ini', 'js', 'htaccess', 'xsl', 'css', 'tpl'));break;case "backup-file":     $result = $this->backupFile();break;case "backup-mysql":     $result = $this->backupMySQL(      $v65d20a2eeb64b467ae2a1ff3c9116f7b='/backup_database.xml',      $v6fdcc2f9613d38eea050742973189d44='/umibackup'      );break;case "backup-mysql-table":   $result = $this->backupMySQLTable();break;case "backup-mysql-table-part": $result = $this->backupMySQLTablePart();break;case "cleanup":     $result = $this->cleanup();break;case "clear-cache":    $result = $this->clearCache();break;case 'get-demosite-list':    $result = $this->getDemositeList();break;case 'rollback':   $result = $this->rollback();break;case 'clear-tables':   $result = $this->clearTables();break;case 'restore-structure': $result = $this->restoreStructure();break;case 'restore-data':  $result = $this->restoreData();break;case 'restore-files':  $result = $this->restoreFiles();break;case 'restore-file':  $result = $this->restoreFile();break;case 'set-update-mode':  $result = $this->setUpdateMode();break;default: throw new Exception('Неизвестный шаг установки "' . $v2764ca9d34e90313978d044f27ae433b . '" для установки');}}catch (Exception $ve1671797c52e15f763380b45e841ec32) {if (!$this->cli_mode && $this->install_mode) {self::returnErrorXML($ve1671797c52e15f763380b45e841ec32);}if(!$this->getParam('guiUpdate') && ($this->cli_mode || $v2764ca9d34e90313978d044f27ae433b !== "install-run")) {throw $ve1671797c52e15f763380b45e841ec32;}self::returnErrorXML($ve1671797c52e15f763380b45e841ec32);}if(!$this->cli_mode) {if(in_array($v2764ca9d34e90313978d044f27ae433b, array('install-run', 'save-settings', 'download-service-package', 'extract-service-package', 'write-initial-configuration', 'run-tests', 'backup-files', 'backup-mysql', "get-update-instructions", "download-components", "extract-components", "check-components", "update-database", "install-components", "configure", "download-demosite", "extract-demosite", "check-demosite", "install-demosite", "set-default-domain", "clear-cache")) || $this->getParam('guiUpdate') ) {self::returnResultXML($result);}else {return $result;}}else {return 1;}}private function checkUpdate() {if (is_file($this->temp_dir . "/update-instructions.xml")) {unlink($this->temp_dir . "/update-instructions.xml");}self::$state = array();if (is_file($this->temp_dir . umiInstallExecutor::STATE_FILE_NAME)) {unlink($this->temp_dir . umiInstallExecutor::STATE_FILE_NAME);}$this->downloadUpdateInstructions();$v0f635d0e0f3874fff8b581c132e6c7a7 = new DOMDocument();$v0f635d0e0f3874fff8b581c132e6c7a7->load($this->temp_dir . "/update-instructions.xml");$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v0f635d0e0f3874fff8b581c132e6c7a7);$vefe90a8e604a7c840e88d03a67f6b7d8 = $v3d788fa62d7c185a1bee4c9147ee1091->query('/package')->item(0);if (!$this->install_mode) {$this->includeMicrocore();$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();$v3c6e0b8a9c15224a8228b9a98ca1531d = $vb1444fb0c07653567ad325aa25d4e37a->getVal("//settings/keycode");$va3d5b10ce810a80d3c98e72709f0e887 = $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute('domain_key');if ($v3c6e0b8a9c15224a8228b9a98ca1531d!=$va3d5b10ce810a80d3c98e72709f0e887) {$vb1444fb0c07653567ad325aa25d4e37a->setVal("//settings/keycode", $va3d5b10ce810a80d3c98e72709f0e887);}}if ($vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute('last-revision') == $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute('client-revision')) {throw new Exception('Updates not avaiable.');}else {if (!$this->install_mode && !INSTALLER_CLI_MODE && $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute('client-revision')>18080) {throw new Exception('Updates avaiable.');}else {$this->flushLog('Updates avaiable.');}}return true;}private function isSV() {@session_start();return (isset($_SESSION['user_is_sv']) && $_SESSION['user_is_sv']==true);}private function checkUser() {if ($this->isSV()) {$this->flushLog('Права на выполнение обновления подтверждены.');}else {throw new Exception('Недостаточно прав для выполнения обновлений!');}return true;}private function rollback() {if ( $this->checkRestore() and $this->execSubProcess('clear-tables')    and $this->execSubProcess('restore-structure')    and $this->execSubProcess('restore-data')    and $this->execSubProcess('restore-files')    ) {if (file_exists('./restore')&&is_file('./restore')) {unlink('./restore');}if (file_exists('../restore')&&is_file('../restore')) {unlink('../restore');}if (file_exists(CURRENT_WORKING_DIR.'/sys-temp/updates/'.self::STATE_FILE_NAME)) {unlink(CURRENT_WORKING_DIR.'/sys-temp/updates/'.self::STATE_FILE_NAME);}$this->cleanUpdateMode();$this->flushLog('Состояние системы восстановлено.');return true;}return false;}private function checkRestore() {if ($this->checkDone(__METHOD__)) {return true;}$this->flushLog("Проверка возможности восстановления...");$ve1de1021029d08bd039b08e56d062c7a = CURRENT_WORKING_DIR.'/umibackup';if (!file_exists($ve1de1021029d08bd039b08e56d062c7a.'/backup_database.xml') && !file_exists($ve1de1021029d08bd039b08e56d062c7a.'/backup_files.xml')) {throw new Exception("Восстановление системы невозможно - отсутствуют файлы бекапирования.");}if (!$this->cli_mode && !(file_exists(CURRENT_WORKING_DIR.'/restore')&&is_file(CURRENT_WORKING_DIR.'/restore'))) {throw new Exception("Для запуска восстановления необходим пустой файл restore в корне сайта.");}if (file_exists(CURRENT_WORKING_DIR.'/sys-temp/updates/.isf')) {unlink(CURRENT_WORKING_DIR.'/sys-temp/updates/.isf');}$this->setDone(__METHOD__);return true;}private function loadDomDocument($v435ed7e9f07f740abf511a62c00eef6e="") {$vdd988cfd769c9f7fbd795a0f5da8e751 = new DOMDocument();if (!$vdd988cfd769c9f7fbd795a0f5da8e751->load($v435ed7e9f07f740abf511a62c00eef6e)) {throw new Exception('Не удалось загрузить xml документ.');}return $vdd988cfd769c9f7fbd795a0f5da8e751;}private function saveDomDocument(DomDocument $v9a09b4dfda82e3e665e31092d1c3ec8d, $v435ed7e9f07f740abf511a62c00eef6e="") {if (!$v9a09b4dfda82e3e665e31092d1c3ec8d->save($v435ed7e9f07f740abf511a62c00eef6e)) {throw new Exception('Не удалось сохранить xml документ.');}return true;}private function clearTables() {if ($this->checkDone(__METHOD__)) {return true;}$v979ebc24246d104980d580591942b43d = CURRENT_WORKING_DIR.'/umibackup/backup_database.xml';$v9a09b4dfda82e3e665e31092d1c3ec8d = $this->loadDomDocument($v979ebc24246d104980d580591942b43d);$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);if ($v3d788fa62d7c185a1bee4c9147ee1091->query('//table[@deleted]')->length==0) {$this->flushLog("Удаление таблиц:");}$v6e8478a371b26cbb54f441493d35f643 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//table[not(@deleted)]');if ($v6e8478a371b26cbb54f441493d35f643->length>0) {$this->includeMicrocore();$v1b1cc7f086b3f074da452bc3129981eb = "SET foreign_key_checks = 0";l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);foreach($v6e8478a371b26cbb54f441493d35f643 as $vaab9e1de16f38176f86d7a92ba337a8d) {$vb068931cc450442b63f5b3d276ea4297 = $vaab9e1de16f38176f86d7a92ba337a8d->getAttribute('name');$v1b1cc7f086b3f074da452bc3129981eb = "SHOW TABLES LIKE '{$vb068931cc450442b63f5b3d276ea4297}'";$v9b207167e5381c47682c6b4f58a623fb = l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);if (mysql_numrows($v9b207167e5381c47682c6b4f58a623fb)!=0) {$v1b1cc7f086b3f074da452bc3129981eb = "DROP TABLE `".$vb068931cc450442b63f5b3d276ea4297."`";l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);$this->flushLog("Таблица ".$vb068931cc450442b63f5b3d276ea4297." была удалена.");}else {$this->flushLog("Таблица ".$vb068931cc450442b63f5b3d276ea4297." отсутствовала.");}$vaab9e1de16f38176f86d7a92ba337a8d->setAttribute('deleted', 'true');if (!$this->cli_mode) {$this->saveDomDocument($v9a09b4dfda82e3e665e31092d1c3ec8d, $v979ebc24246d104980d580591942b43d);return false;}}}$vda602f0b162fccbf6b150cfcfc7a7379 = $v3d788fa62d7c185a1bee4c9147ee1091->query('table[@deleted]');foreach($vda602f0b162fccbf6b150cfcfc7a7379 as $vaab9e1de16f38176f86d7a92ba337a8d) {$vaab9e1de16f38176f86d7a92ba337a8d->removeAttribute('deleted');}$this->saveDomDocument($v9a09b4dfda82e3e665e31092d1c3ec8d, $v979ebc24246d104980d580591942b43d);$this->flushLog("Удаление завершено.");$this->setDone(__METHOD__);return true;}private function restoreStructure() {if ($this->checkDone(__METHOD__)) {return true;}$v979ebc24246d104980d580591942b43d = CURRENT_WORKING_DIR.'/umibackup/backup_database.xml';$v11e0eed8d3696c0a632f822df385ab3c = $this->loadDomDocument($v979ebc24246d104980d580591942b43d);$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v11e0eed8d3696c0a632f822df385ab3c);$this->includeMicrocore();$v0ea7dd4da372f1a68a5dda3b9fc7e2e8 = new dbSchemeConverter($this->connection);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setDestinationFile(str_replace('.xml', '_old.xml', $v979ebc24246d104980d580591942b43d));$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setMode('save');$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->run();$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setMode('restore');$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setSourceFile($v979ebc24246d104980d580591942b43d);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->run();$this->flushLog("Структура базы данных восстановлена.");$this->setDone(__METHOD__);return true;}private function restoreData() {if ($this->checkDone(__METHOD__)) {return true;}$v979ebc24246d104980d580591942b43d = CURRENT_WORKING_DIR.'/umibackup/backup_database.xml';$v9ee0cd9d4f204c536aecd314d92147e3 = 50;$v11e0eed8d3696c0a632f822df385ab3c = $this->loadDomDocument($v979ebc24246d104980d580591942b43d);$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v11e0eed8d3696c0a632f822df385ab3c);if ($v3d788fa62d7c185a1bee4c9147ee1091->query("table")->length==0) {$this->flushLog("Нет таблиц для восстановления.");return true;}if ($v3d788fa62d7c185a1bee4c9147ee1091->query("table[@restored]")->length==0) {$this->flushLog("Восстановление данных таблиц:");}$vfa42767b7616d32b86d5e8db3c8f26d3 = $v3d788fa62d7c185a1bee4c9147ee1091->query("table[not(@restored)]");if ($vfa42767b7616d32b86d5e8db3c8f26d3->length>0) {foreach($vfa42767b7616d32b86d5e8db3c8f26d3 as $vaab9e1de16f38176f86d7a92ba337a8d) {$vb068931cc450442b63f5b3d276ea4297 = $vaab9e1de16f38176f86d7a92ba337a8d->getAttribute("name");$v7a86c157ee9713c34fbd7a1ee40f0c5a = $vaab9e1de16f38176f86d7a92ba337a8d->getAttribute("offset");if (!$v7a86c157ee9713c34fbd7a1ee40f0c5a) {$v7a86c157ee9713c34fbd7a1ee40f0c5a=0;}$v04d59e5cbf3b8bcb10ede20d71578386 = CURRENT_WORKING_DIR."/umibackup/mysql/{$vb068931cc450442b63f5b3d276ea4297}.sql";$ve2942a04780e223b215eb8b663cf5353 = $this->getCountMysqlValues($v04d59e5cbf3b8bcb10ede20d71578386);if ($v7a86c157ee9713c34fbd7a1ee40f0c5a==0) {$this->flushLog("Таблица {$vb068931cc450442b63f5b3d276ea4297}, количество записей {$ve2942a04780e223b215eb8b663cf5353}");}do {if ($ve2942a04780e223b215eb8b663cf5353==0) {break;}$v7f021a1415b86f2d013b2618fb31ae53 = $v7a86c157ee9713c34fbd7a1ee40f0c5a + $v9ee0cd9d4f204c536aecd314d92147e3 - 1;if ($v7f021a1415b86f2d013b2618fb31ae53>$ve2942a04780e223b215eb8b663cf5353) {$v7f021a1415b86f2d013b2618fb31ae53 = $ve2942a04780e223b215eb8b663cf5353 - 1;}$this->flushLog("Добавление записей с ".($v7a86c157ee9713c34fbd7a1ee40f0c5a+1)." по ".($v7f021a1415b86f2d013b2618fb31ae53+1)."...");$this->insertMysqlData($v04d59e5cbf3b8bcb10ede20d71578386, $vb068931cc450442b63f5b3d276ea4297, $v7a86c157ee9713c34fbd7a1ee40f0c5a, $v7f021a1415b86f2d013b2618fb31ae53);$v7a86c157ee9713c34fbd7a1ee40f0c5a = $v7f021a1415b86f2d013b2618fb31ae53 + 1;if (($ve2942a04780e223b215eb8b663cf5353>$v7a86c157ee9713c34fbd7a1ee40f0c5a) && (!$this->cli_mode)) {$vaab9e1de16f38176f86d7a92ba337a8d->setAttribute("offset", $v7a86c157ee9713c34fbd7a1ee40f0c5a);$this->saveDomDocument($v11e0eed8d3696c0a632f822df385ab3c, $v979ebc24246d104980d580591942b43d);return false;}}while ($ve2942a04780e223b215eb8b663cf5353>$v7a86c157ee9713c34fbd7a1ee40f0c5a);$vaab9e1de16f38176f86d7a92ba337a8d->removeAttribute("offset");$vaab9e1de16f38176f86d7a92ba337a8d->setAttribute("restored", "true");if (!$this->cli_mode) {$this->saveDomDocument($v11e0eed8d3696c0a632f822df385ab3c, $v979ebc24246d104980d580591942b43d);return false;}}}if ($v3d788fa62d7c185a1bee4c9147ee1091->query("table[not(@restored)]")->length==0) {$vfa42767b7616d32b86d5e8db3c8f26d3 = $v3d788fa62d7c185a1bee4c9147ee1091->query("table[@restored]");foreach($vfa42767b7616d32b86d5e8db3c8f26d3 as $vaab9e1de16f38176f86d7a92ba337a8d) {$vaab9e1de16f38176f86d7a92ba337a8d->removeAttribute("restored");}$this->saveDomDocument($v11e0eed8d3696c0a632f822df385ab3c, $v979ebc24246d104980d580591942b43d);$this->flushLog("Данные восстановлены.");$this->setDone(__METHOD__);return true;}}private function getCountMysqlValues($v04d59e5cbf3b8bcb10ede20d71578386) {if (filesize($v04d59e5cbf3b8bcb10ede20d71578386)==0) {return 0;}else {return count($this->getMysqlValues($v04d59e5cbf3b8bcb10ede20d71578386));}}private function getMysqlValues($v04d59e5cbf3b8bcb10ede20d71578386) {if (!file_exists($v04d59e5cbf3b8bcb10ede20d71578386)) {throw new Exception("Отсутствует файл с данными для восстановления {$v04d59e5cbf3b8bcb10ede20d71578386}");}$v9a0364b9e99bb480dd25e1f0284c8555 = file_get_contents($v04d59e5cbf3b8bcb10ede20d71578386);$v9a0364b9e99bb480dd25e1f0284c8555 = substr($v9a0364b9e99bb480dd25e1f0284c8555, strpos($v9a0364b9e99bb480dd25e1f0284c8555, '('));$v8d777f385d3dfec8815d20f7496026dc = explode("'), \n", $v9a0364b9e99bb480dd25e1f0284c8555);return $v8d777f385d3dfec8815d20f7496026dc;}private function insertMysqlData($v04d59e5cbf3b8bcb10ede20d71578386, $vb068931cc450442b63f5b3d276ea4297, $vea2b2676c28c0db26d39331a336c6b92, $vef399b2d446bb37b7c32ad2cc1b6045b) {$this->includeMicrocore();$v1b1cc7f086b3f074da452bc3129981eb = "SET foreign_key_checks = 0";$v9b207167e5381c47682c6b4f58a623fb = l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);$v8d777f385d3dfec8815d20f7496026dc = array_slice($this->getMysqlValues($v04d59e5cbf3b8bcb10ede20d71578386), $vea2b2676c28c0db26d39331a336c6b92, $vef399b2d446bb37b7c32ad2cc1b6045b-$vea2b2676c28c0db26d39331a336c6b92+1);$vf09cc7ee3a9a93273f4b80601cafb00c = trim(implode("'), ", $v8d777f385d3dfec8815d20f7496026dc));if (substr($vf09cc7ee3a9a93273f4b80601cafb00c, -1, 1)!=')') {$vf09cc7ee3a9a93273f4b80601cafb00c.="')";}$v1b1cc7f086b3f074da452bc3129981eb = "INSERT INTO `".$vb068931cc450442b63f5b3d276ea4297."` VALUES ".$vf09cc7ee3a9a93273f4b80601cafb00c;l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);$v1b1cc7f086b3f074da452bc3129981eb = "SET foreign_key_checks = 1";$v9b207167e5381c47682c6b4f58a623fb = l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);return true;}private function restoreFiles() {if($this->checkDone(__METHOD__)) return true;$v6fdcc2f9613d38eea050742973189d44 = CURRENT_WORKING_DIR.'/umibackup/files';$v65d20a2eeb64b467ae2a1ff3c9116f7b = CURRENT_WORKING_DIR.'/umibackup/backup_files.xml';$v97c66a27a342821017d8156042557fbd = CURRENT_WORKING_DIR;if (!file_exists($v6fdcc2f9613d38eea050742973189d44)||!is_dir($v6fdcc2f9613d38eea050742973189d44)) {throw new Exception('Директория '.$v6fdcc2f9613d38eea050742973189d44.' не существует.');}if ( !file_exists($v65d20a2eeb64b467ae2a1ff3c9116f7b) ) {throw new Exception('Отсутствует список файлов для восстановления - '.$v65d20a2eeb64b467ae2a1ff3c9116f7b);}if ( !is_writable($v97c66a27a342821017d8156042557fbd) ) {throw new Exception('Директория '.$v97c66a27a342821017d8156042557fbd.' закрыта для записи. Проверьте разрешения.');}$v0f635d0e0f3874fff8b581c132e6c7a7 = $this->loadDomDocument($v65d20a2eeb64b467ae2a1ff3c9116f7b);$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v0f635d0e0f3874fff8b581c132e6c7a7);if ($v3d788fa62d7c185a1bee4c9147ee1091->query("//file[@restored]")->length==0) {$this->flushLog('Восстановление файлов...');}$v45b963397aa40d4a0063e0d85e4fe7a1 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//file[not(@restored)]');if ( 0<$v45b963397aa40d4a0063e0d85e4fe7a1->length ) {foreach($v45b963397aa40d4a0063e0d85e4fe7a1 as $v8c7dd922ad47494fc02c388e12c00eac) {$this->execSubProcess('restore-file', array(      'backup_dir'=>$v6fdcc2f9613d38eea050742973189d44,      'src_file'=>$v8c7dd922ad47494fc02c388e12c00eac->getAttributeNode('path')->nodeValue,      'dest_dir'=>$v97c66a27a342821017d8156042557fbd      )     );$v8c7dd922ad47494fc02c388e12c00eac->setAttribute('restored', 'true');if (!$this->cli_mode) {$this->saveDomDocument($v0f635d0e0f3874fff8b581c132e6c7a7, $v65d20a2eeb64b467ae2a1ff3c9116f7b);return false;}}}$v45b963397aa40d4a0063e0d85e4fe7a1 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//file[@restored]');foreach($v45b963397aa40d4a0063e0d85e4fe7a1 as $v8c7dd922ad47494fc02c388e12c00eac) {$v8c7dd922ad47494fc02c388e12c00eac->removeAttribute("restored");}$this->saveDomDocument($v0f635d0e0f3874fff8b581c132e6c7a7, $v65d20a2eeb64b467ae2a1ff3c9116f7b);$this->flushLog('Файлы были восстановлены.');$this->setDone(__METHOD__);return true;}private function restoreFile() {$v6fdcc2f9613d38eea050742973189d44 = $this->params['backup_dir'];$v97c66a27a342821017d8156042557fbd = $this->params['dest_dir'];$v04d59e5cbf3b8bcb10ede20d71578386 = (strpos($this->params['src_file'], './')===0)?substr($this->params['src_file'], 1):$this->params['src_file'];$this->flushLog($v04d59e5cbf3b8bcb10ede20d71578386.'...');$vd9df1cb8a45bb0d98db73ff0669c7239 = $v97c66a27a342821017d8156042557fbd.$v04d59e5cbf3b8bcb10ede20d71578386;$v97c66a27a342821017d8156042557fbd = pathinfo($vd9df1cb8a45bb0d98db73ff0669c7239, PATHINFO_DIRNAME);if ( (!file_exists($v97c66a27a342821017d8156042557fbd) || !is_dir($v97c66a27a342821017d8156042557fbd)) && !mkdir($v97c66a27a342821017d8156042557fbd, 0777, true)) {throw new Exception('Не удается создать директорию '.$v97c66a27a342821017d8156042557fbd);}if (!copy($v6fdcc2f9613d38eea050742973189d44.$v04d59e5cbf3b8bcb10ede20d71578386, $vd9df1cb8a45bb0d98db73ff0669c7239)) {throw new Exception('Не удается скопировать файл '.$vd9df1cb8a45bb0d98db73ff0669c7239);}return true;}private function getDemositeList() {header("Content-Type: text/xml; charset=utf-8");echo $this->getDownloader()->getDemositesList()->saveXML();}private function saveSettings($vf09cc7ee3a9a93273f4b80601cafb00c='') {if (!INSTALLER_CLI_MODE && $this->install_mode) {$this->checkSelf();}if (file_exists(CURRENT_WORKING_DIR . "/install.ini")) {$v2e5d8aa3dfa8ef34ca5131d20f9dad51 = parse_ini_file(CURRENT_WORKING_DIR . "/install.ini", true);}else {$v2e5d8aa3dfa8ef34ca5131d20f9dad51 = array();}if (!$this->install_mode && $vf09cc7ee3a9a93273f4b80601cafb00c!='') {foreach($vf09cc7ee3a9a93273f4b80601cafb00c as $v8ce4b16b22b58894aa86c421e8759df3=>$v9e3669d19b675bd57058fd4664205d2a) {$v2e5d8aa3dfa8ef34ca5131d20f9dad51['SUPERVISOR'][$v8ce4b16b22b58894aa86c421e8759df3] = $v9e3669d19b675bd57058fd4664205d2a;}}else {if (!is_null($this->getParam("demosite"))) {$v2e5d8aa3dfa8ef34ca5131d20f9dad51['DEMOSITE']['name']  = $this->getParam("demosite");}elseif (!is_null($this->getParam("sv_login"))) {if (is_null($this->getParam("sv_password"))) {throw new Exception("Не указан пароль суперпользователя");}if ($this->getParam("sv_password")!=$this->getParam("sv_password2")) {throw new Exception("Пароли не совпадают!");}if (strlen($this->getParam("sv_login"))<2) {throw new Exception("Имя пользователя должно быть не менее 2-х символов");}if ( $this->getParam("sv_login") == $this->getParam("sv_password") ) {throw new Exception("Пароль не должен совпадать с логином");}$v2e5d8aa3dfa8ef34ca5131d20f9dad51['SUPERVISOR']['login']  = $this->getParam("sv_login");$v2e5d8aa3dfa8ef34ca5131d20f9dad51['SUPERVISOR']['password'] = $this->getParam("sv_password");$v2e5d8aa3dfa8ef34ca5131d20f9dad51['SUPERVISOR']['email']  = $this->getParam("sv_email");$this->cleanUpdateMode();}else {$v2e5d8aa3dfa8ef34ca5131d20f9dad51['LICENSE']['domain']  = $_SERVER['HTTP_HOST'];$v2e5d8aa3dfa8ef34ca5131d20f9dad51['LICENSE']['ip'] = isset($_SERVER['SERVER_ADDR'])?($_SERVER['SERVER_ADDR']):str_replace("\\", "", $_SERVER['DOCUMENT_ROOT']);$v2e5d8aa3dfa8ef34ca5131d20f9dad51['LICENSE']['key'] = $this->getParam("license_key");$v67b3dba8bc6778101892eb77249db32e = $this->getParam("db_host");if (is_null($v67b3dba8bc6778101892eb77249db32e)) {$v67b3dba8bc6778101892eb77249db32e = 'localhost';$v901555fb06e346cb065ceb9808dcfc25 = '';}elseif (strpos($v67b3dba8bc6778101892eb77249db32e, ':')!==false) {list($v67b3dba8bc6778101892eb77249db32e, $v901555fb06e346cb065ceb9808dcfc25) = explode(':', $v67b3dba8bc6778101892eb77249db32e);}else {$v901555fb06e346cb065ceb9808dcfc25 = '';}$v2e5d8aa3dfa8ef34ca5131d20f9dad51['DB']['host'] = trim($v67b3dba8bc6778101892eb77249db32e);$v2e5d8aa3dfa8ef34ca5131d20f9dad51['DB']['port'] = trim($v901555fb06e346cb065ceb9808dcfc25);$v2e5d8aa3dfa8ef34ca5131d20f9dad51['DB']['user']  = $this->getParam("db_login");$v2e5d8aa3dfa8ef34ca5131d20f9dad51['DB']['password'] = $this->getParam("db_password");$v2e5d8aa3dfa8ef34ca5131d20f9dad51['DB']['dbname']  = $this->getParam("db_name");$v2e5d8aa3dfa8ef34ca5131d20f9dad51['BACKUP']['mode']  = $this->getParam("backup_mode");$this->cleanup();if ( $v2e5d8aa3dfa8ef34ca5131d20f9dad51['BACKUP']['mode']=='all' || $v2e5d8aa3dfa8ef34ca5131d20f9dad51['BACKUP']['mode']=='files' ) {$v65d20a2eeb64b467ae2a1ff3c9116f7b = CURRENT_WORKING_DIR.'/umibackup/backup_files.xml';if (file_exists($v65d20a2eeb64b467ae2a1ff3c9116f7b)) unlink($v65d20a2eeb64b467ae2a1ff3c9116f7b);}if ( $v2e5d8aa3dfa8ef34ca5131d20f9dad51['BACKUP']['mode']=='all' || $v2e5d8aa3dfa8ef34ca5131d20f9dad51['BACKUP']['mode']=='base' ) {$v65d20a2eeb64b467ae2a1ff3c9116f7b = CURRENT_WORKING_DIR.'/umibackup/backup_database.xml';if (file_exists($v65d20a2eeb64b467ae2a1ff3c9116f7b)) unlink($v65d20a2eeb64b467ae2a1ff3c9116f7b);}}}$v7ae1d32e7e4aded6d8cc7f0cc349fee0 = "";foreach($v2e5d8aa3dfa8ef34ca5131d20f9dad51 as $v7c13c7fcc4552661a3a87b1e25e448f7 => $vdb0f6f37ebeb6ea09489124345af2a45) {$v7ae1d32e7e4aded6d8cc7f0cc349fee0 .= "[{$v7c13c7fcc4552661a3a87b1e25e448f7}]\n";foreach($vdb0f6f37ebeb6ea09489124345af2a45 as $vd1148ee84e7e2219e5d751a3e0b61ed2 => $v06e3d36fa30cea095545139854ad1fb9)  {$v7ae1d32e7e4aded6d8cc7f0cc349fee0 .= "{$vd1148ee84e7e2219e5d751a3e0b61ed2} = \"" . addslashes($v06e3d36fa30cea095545139854ad1fb9) . "\"\n";}}if (!file_put_contents(CURRENT_WORKING_DIR . "/install.ini", $v7ae1d32e7e4aded6d8cc7f0cc349fee0)) {throw new Exception('Не удается сохранить файл install.ini, проверьте права доступа.', 13049);}return true;}private function backupMySQL($v65d20a2eeb64b467ae2a1ff3c9116f7b='/backup_database.xml', $v6fdcc2f9613d38eea050742973189d44='/umibackup') {if($this->checkDone(__METHOD__)) return true;$this->setUpdateMode();if ( (INSTALLER_CLI_MODE && !$this->getBackupMode('base')) || (!INSTALLER_CLI_MODE && $this->install_mode && !$this->getBackupMode('base'))) {return true;}$v6fdcc2f9613d38eea050742973189d44 = CURRENT_WORKING_DIR.$v6fdcc2f9613d38eea050742973189d44;$v65d20a2eeb64b467ae2a1ff3c9116f7b = $v6fdcc2f9613d38eea050742973189d44.$v65d20a2eeb64b467ae2a1ff3c9116f7b;if ( (!file_exists($v6fdcc2f9613d38eea050742973189d44.'/mysql')||!is_dir($v6fdcc2f9613d38eea050742973189d44.'/mysql'))     && !mkdir($v6fdcc2f9613d38eea050742973189d44.'/mysql', 0777, true) ) {throw new Exception('Не удается создать директорию для сохранения данных таблиц.');}if (!$this->closeByHtaccess($v6fdcc2f9613d38eea050742973189d44)) {throw new Exception('Не удается закрыть директорию данных базы для доступа!');}$this->includeMicrocore();$this->flushLog("Бэкапирование базы...");if (file_exists($v65d20a2eeb64b467ae2a1ff3c9116f7b) ) {unlink($v65d20a2eeb64b467ae2a1ff3c9116f7b);}$v0ea7dd4da372f1a68a5dda3b9fc7e2e8 = new dbSchemeConverter($this->connection);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setMode('save');$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setDestinationFile($v65d20a2eeb64b467ae2a1ff3c9116f7b);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->run();$v0f635d0e0f3874fff8b581c132e6c7a7 = new DomDocument();$v0f635d0e0f3874fff8b581c132e6c7a7->formatOutput = true;$v0f635d0e0f3874fff8b581c132e6c7a7->load($v65d20a2eeb64b467ae2a1ff3c9116f7b);$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v0f635d0e0f3874fff8b581c132e6c7a7);$v9ab2ec7ea4a2041306f7bdf150fcd453 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//table');foreach($v9ab2ec7ea4a2041306f7bdf150fcd453 as $vaab9e1de16f38176f86d7a92ba337a8d) {$vac7e51dbd66751c467e441fe45470a64 = $v0f635d0e0f3874fff8b581c132e6c7a7->createAttribute('backuped');$vaab9e1de16f38176f86d7a92ba337a8d->appendChild($vac7e51dbd66751c467e441fe45470a64);$vac7e51dbd66751c467e441fe45470a64->appendChild($v0f635d0e0f3874fff8b581c132e6c7a7->createTextNode('false'));}$v0f635d0e0f3874fff8b581c132e6c7a7->save($v65d20a2eeb64b467ae2a1ff3c9116f7b);if (!isset($v0f635d0e0f3874fff8b581c132e6c7a7)) {$v0f635d0e0f3874fff8b581c132e6c7a7 = new DomDocument();$v0f635d0e0f3874fff8b581c132e6c7a7->formatOutput = true;$v0f635d0e0f3874fff8b581c132e6c7a7->load($v65d20a2eeb64b467ae2a1ff3c9116f7b);if (!$v0f635d0e0f3874fff8b581c132e6c7a7) {throw new Exception('Не удается загрузить xml документ.');}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v0f635d0e0f3874fff8b581c132e6c7a7);}$v9ab2ec7ea4a2041306f7bdf150fcd453 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//table');if ( 0<$v9ab2ec7ea4a2041306f7bdf150fcd453->length ) {foreach($v9ab2ec7ea4a2041306f7bdf150fcd453 as $vaab9e1de16f38176f86d7a92ba337a8d) {$v4b27b6e578e03e53206b2e4688d7a3e5[] = $vaab9e1de16f38176f86d7a92ba337a8d->getAttributeNode('name')->nodeValue;}$v1b1cc7f086b3f074da452bc3129981eb = "LOCK TABLES `".implode("` READ, `", $v4b27b6e578e03e53206b2e4688d7a3e5)."` READ";l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);$v9ab2ec7ea4a2041306f7bdf150fcd453 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//table[@backuped="false"]');if ( 0<$v9ab2ec7ea4a2041306f7bdf150fcd453->length ) {foreach($v9ab2ec7ea4a2041306f7bdf150fcd453 as $vaab9e1de16f38176f86d7a92ba337a8d) {$this->execSubProcess('backup-mysql-table', array(       'table_name'=>$vaab9e1de16f38176f86d7a92ba337a8d->getAttributeNode('name')->nodeValue,       'backup_dir'=>$v6fdcc2f9613d38eea050742973189d44.'/mysql'       )      );$vaab9e1de16f38176f86d7a92ba337a8d->setAttribute('backuped', 'true');$v0f635d0e0f3874fff8b581c132e6c7a7->save($v65d20a2eeb64b467ae2a1ff3c9116f7b);}}$v1b1cc7f086b3f074da452bc3129981eb = "UNLOCK TABLES";l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);$this->flushLog("База данных была сохранена.");}else {$this->flushLog("В базе данных отсутствуют таблицы для сохранения.");}$this->setDone(__METHOD__);return true;}private function backupMySQLTable($v9ee0cd9d4f204c536aecd314d92147e3=50) {$v4b27b6e578e03e53206b2e4688d7a3e5 = $this->params['table_name'];$v6fdcc2f9613d38eea050742973189d44 = $this->params['backup_dir'];$v7a86c157ee9713c34fbd7a1ee40f0c5a = isset($this->params['offset'])?$this->params['offset']:0;$v3090ad88ff7c9ca191579b709069fe64 = $v6fdcc2f9613d38eea050742973189d44.'/'.$v4b27b6e578e03e53206b2e4688d7a3e5.'.sql';$this->includeMicrocore();if (file_exists($v3090ad88ff7c9ca191579b709069fe64) ) {unlink($v3090ad88ff7c9ca191579b709069fe64);}$this->flushLog("Сохранение таблицы ".$v4b27b6e578e03e53206b2e4688d7a3e5."...");touch($v3090ad88ff7c9ca191579b709069fe64);$ve2942a04780e223b215eb8b663cf5353 = mysql_result(l_mysql_query("SELECT COUNT(*) FROM `".$v4b27b6e578e03e53206b2e4688d7a3e5."`"), 0);if ($ve2942a04780e223b215eb8b663cf5353!=0) {$vc059260f760bd5b373c95673b1f67763 = ceil($ve2942a04780e223b215eb8b663cf5353/$v9ee0cd9d4f204c536aecd314d92147e3);for($v865c0c0b4ab0e063e5caa3387c1a8741=1;$v865c0c0b4ab0e063e5caa3387c1a8741<=$vc059260f760bd5b373c95673b1f67763;$v865c0c0b4ab0e063e5caa3387c1a8741++) {if ($v865c0c0b4ab0e063e5caa3387c1a8741==1) {file_put_contents($v3090ad88ff7c9ca191579b709069fe64, "INSERT INTO `".$v4b27b6e578e03e53206b2e4688d7a3e5."` VALUES \n");}$this->execSubProcess('backup-mysql-table-part', array(      'table_name'=>$v4b27b6e578e03e53206b2e4688d7a3e5,      'backup_dir'=>$v6fdcc2f9613d38eea050742973189d44,      'start'=>(($v865c0c0b4ab0e063e5caa3387c1a8741-1)*$v9ee0cd9d4f204c536aecd314d92147e3),      'parse_by'=>$v9ee0cd9d4f204c536aecd314d92147e3      )     );if ($v865c0c0b4ab0e063e5caa3387c1a8741!=$vc059260f760bd5b373c95673b1f67763) {file_put_contents($v3090ad88ff7c9ca191579b709069fe64, ", \n", FILE_APPEND);}}}$this->flushLog("завершено.");}private function backupMySQLTablePart() {$v4b27b6e578e03e53206b2e4688d7a3e5 = $this->params['table_name'];$v6fdcc2f9613d38eea050742973189d44 = $this->params['backup_dir'];$vea2b2676c28c0db26d39331a336c6b92 = $this->params['start'];$v9ee0cd9d4f204c536aecd314d92147e3 = $this->params['parse_by'];$v1b1cc7f086b3f074da452bc3129981eb = "SELECT * FROM `".$v4b27b6e578e03e53206b2e4688d7a3e5."` LIMIT ".$vea2b2676c28c0db26d39331a336c6b92.", ".$v9ee0cd9d4f204c536aecd314d92147e3;$v3090ad88ff7c9ca191579b709069fe64 = $v6fdcc2f9613d38eea050742973189d44.'/'.$v4b27b6e578e03e53206b2e4688d7a3e5.'.sql';$this->includeMicrocore();$v8bcf6629759bd278a5c6266bd9c054f8 = array();$v9b207167e5381c47682c6b4f58a623fb = l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);while($vf1965a857bc285d26fe22023aa5ab50d = mysql_fetch_row($v9b207167e5381c47682c6b4f58a623fb)) {foreach($vf1965a857bc285d26fe22023aa5ab50d as $v8ce4b16b22b58894aa86c421e8759df3=>$v9e3669d19b675bd57058fd4664205d2a) {$vf1965a857bc285d26fe22023aa5ab50d[$v8ce4b16b22b58894aa86c421e8759df3] = addslashes($v9e3669d19b675bd57058fd4664205d2a);}$v8bcf6629759bd278a5c6266bd9c054f8[] = "('".implode("', '", $vf1965a857bc285d26fe22023aa5ab50d)."')";}file_put_contents($v3090ad88ff7c9ca191579b709069fe64, implode(", \n", $v8bcf6629759bd278a5c6266bd9c054f8), FILE_APPEND);}private function closeByHtaccess($v736007832d2167baaae763fd3a3f3cf1) {if (is_file($v736007832d2167baaae763fd3a3f3cf1.'/.htaccess') || file_put_contents($v736007832d2167baaae763fd3a3f3cf1.'/.htaccess', 'Deny from all')) {return true;}return false;}private function getBackupMode($v15d61712450a686a7f365adf4fef581f) {$v5259554dde26010f6ef15e52f4694828 = $this->getConfigOption('BACKUP', 'mode', null, "В install.ini не указан тип бекапирования.", 13060);if (!in_array($v5259554dde26010f6ef15e52f4694828, array('all', 'files', 'base', 'none'))) {throw new Exception('Ошибка: install.ini, секция BACKUP, значение не в списке разрешенных (all, none).', 13060);}if ($v5259554dde26010f6ef15e52f4694828=='all' || $v5259554dde26010f6ef15e52f4694828==$v15d61712450a686a7f365adf4fef581f) {return true;}else {return false;}}private function backupFiles($v3d643d2f9b8074d8bb6f0936e7e8911e='/backup_files.xml', $v6fdcc2f9613d38eea050742973189d44='/umibackup', $v33030abc929f083da5f6c3f755b46034=array('.'), $ve91a63bfd34992f6a563ffcc52e597a8=array('php', 'ini', 'js', 'htaccess', 'xsl', 'css', 'tpl')){if($this->checkDone(__METHOD__)) return true;$this->setUpdateMode();if ( (INSTALLER_CLI_MODE && !$this->getBackupMode('files')) || (!INSTALLER_CLI_MODE && $this->install_mode && !$this->getBackupMode('files'))) {return true;}$this->flushLog('Сохранение файлов...');$v6fdcc2f9613d38eea050742973189d44 = CURRENT_WORKING_DIR.$v6fdcc2f9613d38eea050742973189d44;$v3d643d2f9b8074d8bb6f0936e7e8911e = $v6fdcc2f9613d38eea050742973189d44.$v3d643d2f9b8074d8bb6f0936e7e8911e;if ( (!file_exists($v6fdcc2f9613d38eea050742973189d44.'/files') || !is_dir($v6fdcc2f9613d38eea050742973189d44.'/files')) && !mkdir($v6fdcc2f9613d38eea050742973189d44.'/files', 0777, true) ) {throw new Exception('Не удается создать директорию для сохранения файлов!');}if (!$this->closeByHtaccess($v6fdcc2f9613d38eea050742973189d44)) {throw new Exception('Не удается закрыть директорию с резервной копией для доступа!');}if (INSTALLER_CLI_MODE && file_exists($v3d643d2f9b8074d8bb6f0936e7e8911e)) {unlink($v3d643d2f9b8074d8bb6f0936e7e8911e);}if (!file_exists($v3d643d2f9b8074d8bb6f0936e7e8911e)) {$v4aea81fe61ebc492622b93e2f564bdd2 = array();foreach($v33030abc929f083da5f6c3f755b46034 as $v736007832d2167baaae763fd3a3f3cf1) {$this->getAllFiles($v736007832d2167baaae763fd3a3f3cf1, $v4aea81fe61ebc492622b93e2f564bdd2, true);}$v0f635d0e0f3874fff8b581c132e6c7a7 = new DOMDocument('1.0', 'utf-8');if (!$v0f635d0e0f3874fff8b581c132e6c7a7) {throw new Exception('Не удается создать модель xml документа.');}$v0f635d0e0f3874fff8b581c132e6c7a7->formatOutput = true;$v402051f4be0cc3aad33bcf3ac3d6532b = $v0f635d0e0f3874fff8b581c132e6c7a7->createElement('backup');$v0f635d0e0f3874fff8b581c132e6c7a7->appendChild($v402051f4be0cc3aad33bcf3ac3d6532b);$v45b963397aa40d4a0063e0d85e4fe7a1 = $v0f635d0e0f3874fff8b581c132e6c7a7->createElement('files');$v402051f4be0cc3aad33bcf3ac3d6532b->appendChild($v45b963397aa40d4a0063e0d85e4fe7a1);foreach($v4aea81fe61ebc492622b93e2f564bdd2 as $vf97c5d29941bfb1b2fdab0874906ab82) {$vabf77184f55403d75b9d51d79162a7ca = strtolower(pathinfo($vf97c5d29941bfb1b2fdab0874906ab82, PATHINFO_EXTENSION));if ( !in_array($vabf77184f55403d75b9d51d79162a7ca, $ve91a63bfd34992f6a563ffcc52e597a8) ) {continue;}$v8c7dd922ad47494fc02c388e12c00eac = $v0f635d0e0f3874fff8b581c132e6c7a7->createElement('file');$v45b963397aa40d4a0063e0d85e4fe7a1->appendChild($v8c7dd922ad47494fc02c388e12c00eac);$vd6fe1d0be6347b8ef2427fa629c04485 = $v0f635d0e0f3874fff8b581c132e6c7a7->createAttribute('path');$v8c7dd922ad47494fc02c388e12c00eac->appendChild($vd6fe1d0be6347b8ef2427fa629c04485);$vd6fe1d0be6347b8ef2427fa629c04485->appendChild($v0f635d0e0f3874fff8b581c132e6c7a7->createTextNode(htmlentities($vf97c5d29941bfb1b2fdab0874906ab82)));$vac9f7584d3fd6d49faa7bcf5e1ebec1f = $v0f635d0e0f3874fff8b581c132e6c7a7->createAttribute('copied');$v8c7dd922ad47494fc02c388e12c00eac->appendChild($vac9f7584d3fd6d49faa7bcf5e1ebec1f);$vac9f7584d3fd6d49faa7bcf5e1ebec1f->appendChild($v0f635d0e0f3874fff8b581c132e6c7a7->createTextNode('false'));}if (!$v0f635d0e0f3874fff8b581c132e6c7a7->save($v3d643d2f9b8074d8bb6f0936e7e8911e)) {throw new Exception('Не удается сохранить xml документ.');}}if (!isset($v0f635d0e0f3874fff8b581c132e6c7a7)) {$v0f635d0e0f3874fff8b581c132e6c7a7 = new DOMDocument();if (!$v0f635d0e0f3874fff8b581c132e6c7a7) {throw new Exception('Не удается создать модель xml документа.');}if (!$v0f635d0e0f3874fff8b581c132e6c7a7->load($v3d643d2f9b8074d8bb6f0936e7e8911e)) {throw new Exception('Не удается загрузить xml файл.');}}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v0f635d0e0f3874fff8b581c132e6c7a7);$v45b963397aa40d4a0063e0d85e4fe7a1 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//file[@copied="false"]');if (!INSTALLER_CLI_MODE && $v45b963397aa40d4a0063e0d85e4fe7a1->length>50) {$v865c0c0b4ab0e063e5caa3387c1a8741 = 50;}else {$v865c0c0b4ab0e063e5caa3387c1a8741 = $v45b963397aa40d4a0063e0d85e4fe7a1->length+1;}foreach($v45b963397aa40d4a0063e0d85e4fe7a1 as $v8c7dd922ad47494fc02c388e12c00eac) {if (0==$v865c0c0b4ab0e063e5caa3387c1a8741--) break;$this->execSubProcess('backup-file', array(     'src'=>html_entity_decode($v8c7dd922ad47494fc02c388e12c00eac->getAttributeNode('path')->nodeValue),     'backup_dir'=>$v6fdcc2f9613d38eea050742973189d44.'/files'     )    );$v8c7dd922ad47494fc02c388e12c00eac->setAttribute('copied', 'true');$v0f635d0e0f3874fff8b581c132e6c7a7->save($v3d643d2f9b8074d8bb6f0936e7e8911e);}if ($v865c0c0b4ab0e063e5caa3387c1a8741==-1) return false;$this->setDone(__METHOD__);$this->flushLog('завершено.');}private function getAllFiles($v736007832d2167baaae763fd3a3f3cf1, &$v45b963397aa40d4a0063e0d85e4fe7a1, $v0b2c082c00e002a2f571cbe340644239=false) {$vc1cbfe271a40788a00e8bf8574d94d4b = opendir(CURRENT_WORKING_DIR.'/'.$v736007832d2167baaae763fd3a3f3cf1);while ( false!==($v435ed7e9f07f740abf511a62c00eef6e = readdir($vc1cbfe271a40788a00e8bf8574d94d4b)) ) {if ($v435ed7e9f07f740abf511a62c00eef6e == "." || $v435ed7e9f07f740abf511a62c00eef6e == ".." || $v435ed7e9f07f740abf511a62c00eef6e == 'umibackup' || $v435ed7e9f07f740abf511a62c00eef6e == 'sys-temp') {continue;}if ($v0b2c082c00e002a2f571cbe340644239 && is_dir($v736007832d2167baaae763fd3a3f3cf1.'/'.$v435ed7e9f07f740abf511a62c00eef6e)) {$this->getAllFiles($v736007832d2167baaae763fd3a3f3cf1.'/'.$v435ed7e9f07f740abf511a62c00eef6e, $v45b963397aa40d4a0063e0d85e4fe7a1, true);}else {$v45b963397aa40d4a0063e0d85e4fe7a1[] = $v736007832d2167baaae763fd3a3f3cf1.'/'.$v435ed7e9f07f740abf511a62c00eef6e;}}return;}private function backupFile() {$v04d59e5cbf3b8bcb10ede20d71578386 = htmlentities($this->params['src']);$v6fdcc2f9613d38eea050742973189d44 = $this->params['backup_dir'];$v316c43f2521730b6cbb832d9099a9ec0 = pathinfo($v04d59e5cbf3b8bcb10ede20d71578386);$v316c43f2521730b6cbb832d9099a9ec0['dirname'] = realpath($v316c43f2521730b6cbb832d9099a9ec0['dirname']);$vd9df1cb8a45bb0d98db73ff0669c7239 = str_replace('./', $v6fdcc2f9613d38eea050742973189d44.'/', $v04d59e5cbf3b8bcb10ede20d71578386);$v6875beae8cd39495ba4f16d1462e8a82 = pathinfo($vd9df1cb8a45bb0d98db73ff0669c7239);if ( (!file_exists($v6875beae8cd39495ba4f16d1462e8a82['dirname']) || !is_dir($v6875beae8cd39495ba4f16d1462e8a82['dirname']))     && !mkdir($v6875beae8cd39495ba4f16d1462e8a82['dirname'], 0777, true) ) {throw new Exception('Не удается создать директорию для бэкапирования '.$v97c66a27a342821017d8156042557fbd);}$this->flushLog('Копирование: '.$v316c43f2521730b6cbb832d9099a9ec0['dirname'].'/'.htmlentities($v316c43f2521730b6cbb832d9099a9ec0['basename']).'...');if ( !copy($v316c43f2521730b6cbb832d9099a9ec0['dirname'].'/'.html_entity_decode($v316c43f2521730b6cbb832d9099a9ec0['basename']), $v6875beae8cd39495ba4f16d1462e8a82['dirname'].'/'.html_entity_decode($v6875beae8cd39495ba4f16d1462e8a82['basename'])) ) {throw new Exception('Не удается скопировать файл '.$v316c43f2521730b6cbb832d9099a9ec0['dirname'].'/'.$v316c43f2521730b6cbb832d9099a9ec0['basename']);}$this->flushLog("завершено");}public static function returnResultXML($v6b2ded51d81a4403d8a4bd25fa1e57ee) {$vfdc3bdefb79cec8eb8211d2499e04704 = new DOMDocument("1.0", "utf-8");$v63a9f0ea7bb98050796b649e85481845 = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("result");$vfdc3bdefb79cec8eb8211d2499e04704->appendChild($v63a9f0ea7bb98050796b649e85481845);$v19ad89bc3e3c9d7ef68b89523eff1987 = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("install");$v9ed39e2ea931586b6a985a6942ef573e = $vfdc3bdefb79cec8eb8211d2499e04704->createAttribute("state");$v9ed39e2ea931586b6a985a6942ef573e->value = $v6b2ded51d81a4403d8a4bd25fa1e57ee ? "done" : "inprogress";$v19ad89bc3e3c9d7ef68b89523eff1987->appendChild($v9ed39e2ea931586b6a985a6942ef573e);$v63a9f0ea7bb98050796b649e85481845->appendChild($v19ad89bc3e3c9d7ef68b89523eff1987);$v63a9f0ea7bb98050796b649e85481845->appendChild( self::getLogXML($vfdc3bdefb79cec8eb8211d2499e04704) );header("Content-Type: text/xml; charset=utf-8");echo $vfdc3bdefb79cec8eb8211d2499e04704->saveXML();die();}public static function returnErrorXML(Exception $ve1671797c52e15f763380b45e841ec32) {$vfdc3bdefb79cec8eb8211d2499e04704 = new DOMDocument("1.0", "utf-8");$v63a9f0ea7bb98050796b649e85481845 = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("result");$vfdc3bdefb79cec8eb8211d2499e04704->appendChild($v63a9f0ea7bb98050796b649e85481845);$vcb5e100e5a9a3e7f6d1fd97512215282 = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("error");$v78e731027d8fd50ed642340b7c9a63b3 = $vfdc3bdefb79cec8eb8211d2499e04704->createAttribute("message");$v78e731027d8fd50ed642340b7c9a63b3->value = $ve1671797c52e15f763380b45e841ec32->getMessage();$vcb5e100e5a9a3e7f6d1fd97512215282->appendChild($v78e731027d8fd50ed642340b7c9a63b3);$vcb5e100e5a9a3e7f6d1fd97512215282->appendChild( self::getBacktraceXML($vfdc3bdefb79cec8eb8211d2499e04704, $ve1671797c52e15f763380b45e841ec32->getTrace()) );$v63a9f0ea7bb98050796b649e85481845->appendChild($vcb5e100e5a9a3e7f6d1fd97512215282);$v63a9f0ea7bb98050796b649e85481845->appendChild( self::getLogXML($vfdc3bdefb79cec8eb8211d2499e04704) );header("Content-Type: text/xml; charset=utf-8");echo $vfdc3bdefb79cec8eb8211d2499e04704->saveXML();die();}private static function getBacktraceXML(DOMDocument $vfdc3bdefb79cec8eb8211d2499e04704, $v04a75036e9d520bb983c5ed03b8d0182) {$vf80222de64b3079c261e058703f4e07a = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("backtrace");foreach($v04a75036e9d520bb983c5ed03b8d0182 as $v3cde413efdb2e8ce17b094592df0334e) {$v53b9e9679a8ea25880376080b76f98ad = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("call");$vdbc11caa5bda99f77e6fb4dabd882e7d = "";$va181a603769c1f98ad927e7367c7aa51 = array();foreach($v3cde413efdb2e8ce17b094592df0334e["args"] as $v61dd86c2dc75c3f569ec619bd283a33f) {switch(gettype($v61dd86c2dc75c3f569ec619bd283a33f)) {case "string" : $va181a603769c1f98ad927e7367c7aa51[] = "\"{$v61dd86c2dc75c3f569ec619bd283a33f}\"";break;case "boolean": $va181a603769c1f98ad927e7367c7aa51[] = $v61dd86c2dc75c3f569ec619bd283a33f ? "true" : "false";break;case "array"  : $va181a603769c1f98ad927e7367c7aa51[] = "array";break;case "object" : $va181a603769c1f98ad927e7367c7aa51[] = get_class($v61dd86c2dc75c3f569ec619bd283a33f);break;default : $va181a603769c1f98ad927e7367c7aa51[] = (string) $v61dd86c2dc75c3f569ec619bd283a33f;}$vdbc11caa5bda99f77e6fb4dabd882e7d = implode(", ", $va181a603769c1f98ad927e7367c7aa51);}$vb342543544e0e73437346f285f186883 = $v3cde413efdb2e8ce17b094592df0334e["class"] .        $v3cde413efdb2e8ce17b094592df0334e["type"] .        $v3cde413efdb2e8ce17b094592df0334e["function"] .        "({$vdbc11caa5bda99f77e6fb4dabd882e7d})";$vd9ef6bda8fb69f1c7e277bd1c2cd21d1 = $vfdc3bdefb79cec8eb8211d2499e04704->createCDATASection($vb342543544e0e73437346f285f186883);$v53b9e9679a8ea25880376080b76f98ad->appendChild($vd9ef6bda8fb69f1c7e277bd1c2cd21d1);$vf80222de64b3079c261e058703f4e07a->appendChild($v53b9e9679a8ea25880376080b76f98ad);}return $vf80222de64b3079c261e058703f4e07a;}private static function getLogXML(DOMDocument $vfdc3bdefb79cec8eb8211d2499e04704) {$vdc1d71bbb5c4d2a5e936db79ef10c19f = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("log");foreach(self::$log as $va3580380d46100ce1214bc181742b14a) {$v78e731027d8fd50ed642340b7c9a63b3 = $vfdc3bdefb79cec8eb8211d2499e04704->createElement("message", $va3580380d46100ce1214bc181742b14a);$vdc1d71bbb5c4d2a5e936db79ef10c19f->appendChild($v78e731027d8fd50ed642340b7c9a63b3);}return $vdc1d71bbb5c4d2a5e936db79ef10c19f;}private function getDownloader() {if ($this->install_mode) {$v3c6e0b8a9c15224a8228b9a98ca1531d = $this->getConfigOption('LICENSE', 'key', null, "В install.ini не указан лицензионный ключ.");$v67b3dba8bc6778101892eb77249db32e = $this->getConfigOption('LICENSE', 'domain', null, "В install.ini не указано имя домена для установки.");$v957b527bcfbad2e80f58d20683931435 = $this->getConfigOption('LICENSE', 'ip', "В install.ini не указан ip адрес сервера.");$v24eee2eae2a568c828691c2d48f8e29f = 'last';}else {$this->includeMicrocore();if (INSTALLER_CLI_MODE) {$v957b527bcfbad2e80f58d20683931435 = $this->getConfigOption('LICENSE', 'ip', "В install.ini не указан ip адрес сервера.");}else {$v957b527bcfbad2e80f58d20683931435 = $_SERVER['SERVER_ADDR'];}$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();$v3c6e0b8a9c15224a8228b9a98ca1531d = $vb1444fb0c07653567ad325aa25d4e37a->getVal("//settings/keycode");$v24eee2eae2a568c828691c2d48f8e29f = $vb1444fb0c07653567ad325aa25d4e37a->getVal("//modules/autoupdate/system_build");$v67b3dba8bc6778101892eb77249db32e = domainsCollection::getInstance()->getDefaultDomain()->getHost();}$vd4721a6bab8c7dee78cc25f7fa154bfc = new umiUpdateDownloader($this->temp_dir, $v3c6e0b8a9c15224a8228b9a98ca1531d, $v67b3dba8bc6778101892eb77249db32e, $v957b527bcfbad2e80f58d20683931435, $v24eee2eae2a568c828691c2d48f8e29f);return $vd4721a6bab8c7dee78cc25f7fa154bfc;}private function downloadServicePackage() {if($this->checkDone(__METHOD__)) return true;$this->flushLog("Загрузка сервисного компонента...");$vd4721a6bab8c7dee78cc25f7fa154bfc = $this->getDownloader();$vd4721a6bab8c7dee78cc25f7fa154bfc->downloadServiceComponent("installer");$this->flushLog("Сервисный компонент загружен.");$this->setDone(__METHOD__);return true;}private function extractServicePackage() {if($this->checkDone(__METHOD__)) return true;$result = $this->execSubProcess('extract-component', array('component' => 'installer.service'));$this->setDone(__METHOD__);return $result;}private function writeInitialConfiguration() {if($this->checkDone(__METHOD__)) return true;$va74ad8dfacd4f985eb3977517615ce25 = $this->temp_dir . "/installer.service/umicms-microcore.php";if(!file_exists($va74ad8dfacd4f985eb3977517615ce25)) {throw new Exception("В сервисном пакете отсутствует microcore.php!");}if (!is_dir($this->temp_dir."/core/smu") && !mkdir($this->temp_dir."/core/smu", 0777,true)) {throw new Exception("Не удается создать временную директорию для ядра!");}if (!copy($va74ad8dfacd4f985eb3977517615ce25, $this->temp_dir."/core/smu/umicms-microcore.php")) {throw new Exception("Не удается скопировать ядро!");}else {chmod($this->temp_dir."/core/smu/umicms-microcore.php", PHP_FILES_ACCESS_MODE);}$vebd8cd56be062b07c2d5e44da134793f = $this->temp_dir . "/installer.service/config.ini.original";if(!file_exists($vebd8cd56be062b07c2d5e44da134793f)) {throw new Exception("В сервисном пакете отсутствует файл с примером конфигурации системы.");}if ($this->install_mode || (!file_exists("config.ini")||!is_file("config.ini"))) {$v67b3dba8bc6778101892eb77249db32e = $this->getConfigOption('DB', 'host', "localhost");$v901555fb06e346cb065ceb9808dcfc25 = $this->getConfigOption('DB', 'port', "");$v67b3dba8bc6778101892eb77249db32e = trim($v67b3dba8bc6778101892eb77249db32e);$v901555fb06e346cb065ceb9808dcfc25 = trim($v901555fb06e346cb065ceb9808dcfc25);$vd56b699830e77ba53855679cb1d252da = $this->getConfigOption('DB', 'user', "root");$v5f4dcc3b5aa765d61d8327deb882cf99 = $this->getConfigOption('DB', 'password', "");$v4cd4a49f25984e26fe708c1fbd896653 = $this->getConfigOption('DB', 'dbname', null, "В install.ini не указано имя базы данных.");$v2245023265ae4cf87d02c8b6ba991139 = file_get_contents($vebd8cd56be062b07c2d5e44da134793f);$v2245023265ae4cf87d02c8b6ba991139 = str_replace("%db-core-host%", $v67b3dba8bc6778101892eb77249db32e, $v2245023265ae4cf87d02c8b6ba991139);$v2245023265ae4cf87d02c8b6ba991139 = str_replace("%db-core-port%", $v901555fb06e346cb065ceb9808dcfc25, $v2245023265ae4cf87d02c8b6ba991139);$v2245023265ae4cf87d02c8b6ba991139 = str_replace("%db-core-login%", $vd56b699830e77ba53855679cb1d252da, $v2245023265ae4cf87d02c8b6ba991139);$v2245023265ae4cf87d02c8b6ba991139 = str_replace("%db-core-password%", $v5f4dcc3b5aa765d61d8327deb882cf99, $v2245023265ae4cf87d02c8b6ba991139);$v2245023265ae4cf87d02c8b6ba991139 = str_replace("%db-core-name%", $v4cd4a49f25984e26fe708c1fbd896653, $v2245023265ae4cf87d02c8b6ba991139);}else {$vb6c55d5402301a2728d7e8f6c4ebdf61 = parse_ini_file($vebd8cd56be062b07c2d5e44da134793f, true);$vc8d192f23f1429bb6c397f66d89562dd = parse_ini_file("config.ini", true);foreach($vb6c55d5402301a2728d7e8f6c4ebdf61 as $v73d5342eba070f636ac3246f319bf77f=>$v3a0317e07571e01889f5f6982960cc2a) {foreach($v3a0317e07571e01889f5f6982960cc2a as $vf578b860df8544c8f826f66977b6e908=>$vff2320c2b88ea55c3e82458612971055) {if (is_array($vff2320c2b88ea55c3e82458612971055)) {foreach($vff2320c2b88ea55c3e82458612971055 as $v3a6d0284e743dc4a9b86f97d6dd1a3bf) {if ( !isset($vc8d192f23f1429bb6c397f66d89562dd[$v73d5342eba070f636ac3246f319bf77f][$vf578b860df8544c8f826f66977b6e908]) || !in_array($v3a6d0284e743dc4a9b86f97d6dd1a3bf, $vc8d192f23f1429bb6c397f66d89562dd[$v73d5342eba070f636ac3246f319bf77f][$vf578b860df8544c8f826f66977b6e908]) ) {$vc8d192f23f1429bb6c397f66d89562dd[$v73d5342eba070f636ac3246f319bf77f][$vf578b860df8544c8f826f66977b6e908][]="{$v3a6d0284e743dc4a9b86f97d6dd1a3bf}";}}}else {if (!isset($vc8d192f23f1429bb6c397f66d89562dd[$v73d5342eba070f636ac3246f319bf77f][$vf578b860df8544c8f826f66977b6e908])) {$vc8d192f23f1429bb6c397f66d89562dd[$v73d5342eba070f636ac3246f319bf77f][$vf578b860df8544c8f826f66977b6e908] = "{$vb6c55d5402301a2728d7e8f6c4ebdf61[$v73d5342eba070f636ac3246f319bf77f][$vf578b860df8544c8f826f66977b6e908]}";}}}}$v2245023265ae4cf87d02c8b6ba991139 = "";ksort($vc8d192f23f1429bb6c397f66d89562dd);foreach($vc8d192f23f1429bb6c397f66d89562dd as $v73d5342eba070f636ac3246f319bf77f=>$v3a0317e07571e01889f5f6982960cc2a) {ksort($vc8d192f23f1429bb6c397f66d89562dd[$v73d5342eba070f636ac3246f319bf77f]);$v2245023265ae4cf87d02c8b6ba991139 .= "[{$v73d5342eba070f636ac3246f319bf77f}]\n";foreach($v3a0317e07571e01889f5f6982960cc2a as $vf578b860df8544c8f826f66977b6e908=>$vff2320c2b88ea55c3e82458612971055) {if (is_array($vff2320c2b88ea55c3e82458612971055)) {sort($vc8d192f23f1429bb6c397f66d89562dd[$v73d5342eba070f636ac3246f319bf77f][$vf578b860df8544c8f826f66977b6e908]);foreach($vff2320c2b88ea55c3e82458612971055 as $v3a6d0284e743dc4a9b86f97d6dd1a3bf) {$v2245023265ae4cf87d02c8b6ba991139 .= "{$vf578b860df8544c8f826f66977b6e908}[] = \"{$v3a6d0284e743dc4a9b86f97d6dd1a3bf}\"\n";}}else {$v2245023265ae4cf87d02c8b6ba991139 .= "{$vf578b860df8544c8f826f66977b6e908} = \"{$vff2320c2b88ea55c3e82458612971055}\"\n";}}$v2245023265ae4cf87d02c8b6ba991139 .= "\n";}}file_put_contents("config.ini", $v2245023265ae4cf87d02c8b6ba991139);$this->setDone(__METHOD__);return $this->cli_mode;}private function writeHtaccess() {$vdc1f12c99f7fef3c56e4c512e51cee47 = $this->temp_dir.'/installer.service/.htaccess.original';$v9957454584bf1628a9ed4983fe8ac54c = './.htaccess';$v8d589afa4dfaeeed85fff5aa78e5ff6a = '####################### UMI_CMS_HTACCESS_BEGIN ###########################';$v7f021a1415b86f2d013b2618fb31ae53  =  '######################## UMI_CMS_HTACCESS_END ############################';if (!file_exists($vdc1f12c99f7fef3c56e4c512e51cee47)) {throw new Exception("В сервисном пакете отсутствует корневой файл настроек .htaccess");}if (!file_exists($v9957454584bf1628a9ed4983fe8ac54c)) {if (!file_put_contents($v9957454584bf1628a9ed4983fe8ac54c, $v8d589afa4dfaeeed85fff5aa78e5ff6a."\r\n".file_get_contents($vdc1f12c99f7fef3c56e4c512e51cee47)."\r\n".$v7f021a1415b86f2d013b2618fb31ae53)) {throw new Exception("Не удается записать .htaccess, проверьте разрешения!");}}else {$v753677c7b1b19b460445b4d94cb020db = file_get_contents($v9957454584bf1628a9ed4983fe8ac54c);if ( false!==($v92eb5ffee6ae2fec3ad71c777531578f=stripos($v753677c7b1b19b460445b4d94cb020db, $v8d589afa4dfaeeed85fff5aa78e5ff6a)) && false!==($ve1671797c52e15f763380b45e841ec32=stripos($v753677c7b1b19b460445b4d94cb020db, $v7f021a1415b86f2d013b2618fb31ae53)) ) {$v149603e6c03516362a8da23f624db945 = substr($v753677c7b1b19b460445b4d94cb020db, 0, $v92eb5ffee6ae2fec3ad71c777531578f).substr($v753677c7b1b19b460445b4d94cb020db, $ve1671797c52e15f763380b45e841ec32+strlen($v7f021a1415b86f2d013b2618fb31ae53));}else {$v149603e6c03516362a8da23f624db945 = $v753677c7b1b19b460445b4d94cb020db;}copy('./.htaccess', './.htaccess_old');if (!file_put_contents('./.htaccess', $v149603e6c03516362a8da23f624db945."\r\n".$v8d589afa4dfaeeed85fff5aa78e5ff6a."\r\n".file_get_contents($vdc1f12c99f7fef3c56e4c512e51cee47)."\r\n".$v7f021a1415b86f2d013b2618fb31ae53)) {throw new Exception("Не удается записать .htaccess, проверьте разрешения!");}}}private function runTests() {if($this->checkDone(__METHOD__)) return true;$this->flushLog("Проверка системных требований...");$vb61a6d542f9036550ba9c401c80f00ef = $this->temp_dir . "/installer.service/testhost.php";if (!is_file($vb61a6d542f9036550ba9c401c80f00ef)) {throw new Exception('Не удается найти запрошенный файл: ' . $vb61a6d542f9036550ba9c401c80f00ef);}include $vb61a6d542f9036550ba9c401c80f00ef;if ($this->getParam('guiUpdate')  && is_file('config.ini')) {$v4d90362d661461e558408e982aaa49d3 = parse_ini_file('config.ini');$v67b3dba8bc6778101892eb77249db32e = $v4d90362d661461e558408e982aaa49d3['core.host'];$v901555fb06e346cb065ceb9808dcfc25 = $v4d90362d661461e558408e982aaa49d3['core.port'];$vd56b699830e77ba53855679cb1d252da = $v4d90362d661461e558408e982aaa49d3['core.login'];$v5f4dcc3b5aa765d61d8327deb882cf99 = $v4d90362d661461e558408e982aaa49d3['core.password'];$v4cd4a49f25984e26fe708c1fbd896653 = $v4d90362d661461e558408e982aaa49d3['core.dbname'];$vad5f82e879a9c5d6b5b442eb37e50551 = $_SERVER['HTTP_HOST'];}else {$v67b3dba8bc6778101892eb77249db32e = $this->getConfigOption('DB', 'host', "localhost");$v901555fb06e346cb065ceb9808dcfc25 = $this->getConfigOption('DB', 'port', "");$vd56b699830e77ba53855679cb1d252da = $this->getConfigOption('DB', 'user', "root");$v5f4dcc3b5aa765d61d8327deb882cf99 = $this->getConfigOption('DB', 'password', "");$v4cd4a49f25984e26fe708c1fbd896653 = $this->getConfigOption('DB', 'dbname', null, "В install.ini не указано имя базы данных.");$vad5f82e879a9c5d6b5b442eb37e50551 = $this->getConfigOption('LICENSE', 'domain');}$v67b3dba8bc6778101892eb77249db32e = (string) trim($v67b3dba8bc6778101892eb77249db32e);$v901555fb06e346cb065ceb9808dcfc25 = (string) trim($v901555fb06e346cb065ceb9808dcfc25);$v67b3dba8bc6778101892eb77249db32e .= ($v901555fb06e346cb065ceb9808dcfc25==="") ? ("") : (":" . $v901555fb06e346cb065ceb9808dcfc25);$vb61a6d542f9036550ba9c401c80f00ef = new testHost(array(), $vad5f82e879a9c5d6b5b442eb37e50551);$vb61a6d542f9036550ba9c401c80f00ef->setConnect($v67b3dba8bc6778101892eb77249db32e, $vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99, $v4cd4a49f25984e26fe708c1fbd896653);$vb61a6d542f9036550ba9c401c80f00ef->getResults();if ( 0!=count($vb61a6d542f9036550ba9c401c80f00ef->listErrors) ) {$v02f4657ea7070d169aa861a2688a0763 = false;foreach($vb61a6d542f9036550ba9c401c80f00ef->listErrors as $v3c6e0b8a9c15224a8228b9a98ca1531d => $v2063c1608d6e0baf80249c42e2be5804) {if($v2063c1608d6e0baf80249c42e2be5804[1] == 1) {throw new Exception(' Cервер не соответствует системным требованиям для установки UMI.CMS. Подробное описание ошибки и способы её устранения доступны по ссылке <a href="http://errors.umi-cms.ru/'.$v2063c1608d6e0baf80249c42e2be5804[0].'/" target="_blank">http://errors.umi-cms.ru/'.$v2063c1608d6e0baf80249c42e2be5804[0].'/</a>');}else {$this->flushLog("Ошибка #".$v2063c1608d6e0baf80249c42e2be5804[0]." Сервер не соответствует системным требованиям для установки UMI.CMS. Подробная информация по ссылке http://errors.umi-cms.ru/".$v2063c1608d6e0baf80249c42e2be5804[0]."/");}}}$this->flushLog("завершено.");$this->setDone(__METHOD__);return true;}private function downloadUpdateInstructions() {if($this->checkDone(__METHOD__)) return true;$this->flushLog("Загрузка инструкций по обновлению...");if (is_file($this->temp_dir . "/update-instructions.xml")) {unlink($this->temp_dir . "/update-instructions.xml");}$vd4721a6bab8c7dee78cc25f7fa154bfc = $this->getDownloader();$vd4721a6bab8c7dee78cc25f7fa154bfc->downloadUpdateInstructions();$this->flushLog("Инструкции загружены.");$this->setDone(__METHOD__);return $this->cli_mode;}private function downloadComponents() {if($this->checkDone(__METHOD__)) return true;$this->setUpdateMode();$vcbde2df6a7c89370edc449dc5705d30c = $this->temp_dir . "/update-instructions.xml";$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if (!$v9a09b4dfda82e3e665e31092d1c3ec8d->load($vcbde2df6a7c89370edc449dc5705d30c)) {throw new Exception("Не удается загрузить инструкции по обновлению");}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v157c43e76cda7c87ba5b649565bb2983 = (int) $this->getConfigOption("SETUP", "download_by");if ($v157c43e76cda7c87ba5b649565bb2983<=0) {$v157c43e76cda7c87ba5b649565bb2983 = 1024;}$v157c43e76cda7c87ba5b649565bb2983*=1024;$v4725dcf446a342f1473a8228e42dfa48 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//package/component[not(@downloaded)]");foreach ($v4725dcf446a342f1473a8228e42dfa48 as $v700c216fb376666eaeda0c892e8bdc09) {$vb068931cc450442b63f5b3d276ea4297 = $v700c216fb376666eaeda0c892e8bdc09->getAttribute('name');$v11b4278c7e5a79003db77272c1ed2cf5 = $v700c216fb376666eaeda0c892e8bdc09->getAttribute('filesize');$v7a86c157ee9713c34fbd7a1ee40f0c5a = $v700c216fb376666eaeda0c892e8bdc09->getAttribute('offset');$va3da707b651c79ecc39a4986516180b2 = $this->temp_dir . $vb068931cc450442b63f5b3d276ea4297 . ".tar";if (!$v7a86c157ee9713c34fbd7a1ee40f0c5a) {$v7a86c157ee9713c34fbd7a1ee40f0c5a = 0;$this->flushLog("Загрузка компонента {$vb068931cc450442b63f5b3d276ea4297}");file_put_contents($va3da707b651c79ecc39a4986516180b2, '');}do {$vea2b2676c28c0db26d39331a336c6b92 = $v7a86c157ee9713c34fbd7a1ee40f0c5a;$v7f021a1415b86f2d013b2618fb31ae53 = $vea2b2676c28c0db26d39331a336c6b92 + $v157c43e76cda7c87ba5b649565bb2983;if ($v7f021a1415b86f2d013b2618fb31ae53>$v11b4278c7e5a79003db77272c1ed2cf5) {$v7f021a1415b86f2d013b2618fb31ae53 = $v11b4278c7e5a79003db77272c1ed2cf5;}$result = $this->execSubProcess('download-component', array('component' => $vb068931cc450442b63f5b3d276ea4297, 'fname'=>$va3da707b651c79ecc39a4986516180b2, 'start' => $vea2b2676c28c0db26d39331a336c6b92, 'end' => $v7f021a1415b86f2d013b2618fb31ae53-1));$v7a86c157ee9713c34fbd7a1ee40f0c5a = $v7f021a1415b86f2d013b2618fb31ae53;if (!$this->cli_mode && $v7f021a1415b86f2d013b2618fb31ae53<$v11b4278c7e5a79003db77272c1ed2cf5) {$v700c216fb376666eaeda0c892e8bdc09->setAttribute('offset', $v7a86c157ee9713c34fbd7a1ee40f0c5a);$v9a09b4dfda82e3e665e31092d1c3ec8d->save($vcbde2df6a7c89370edc449dc5705d30c);return false;}}while ($v7f021a1415b86f2d013b2618fb31ae53<$v11b4278c7e5a79003db77272c1ed2cf5);$v700c216fb376666eaeda0c892e8bdc09->removeAttribute("offset");$v700c216fb376666eaeda0c892e8bdc09->setAttribute("downloaded", true);$v9a09b4dfda82e3e665e31092d1c3ec8d->save($vcbde2df6a7c89370edc449dc5705d30c);if (!$this->cli_mode) {return false;}}$this->flushLog("Все компоненты загружены.");$this->setDone(__METHOD__);return true;}private function downloadComponent() {$vb068931cc450442b63f5b3d276ea4297 = isset($this->params['component']) ? trim($this->params['component']) : '';$va3da707b651c79ecc39a4986516180b2 = isset($this->params['fname']) ? trim($this->params['fname']) : '';$vea2b2676c28c0db26d39331a336c6b92 = isset($this->params['start']) ? trim($this->params['start']) : false;$v7f021a1415b86f2d013b2618fb31ae53 = isset($this->params['end']) ? trim($this->params['end']) : false;if (!strlen($vb068931cc450442b63f5b3d276ea4297)) {throw new Exception("Отсутствует имя компонента (пример: installer.php  --component=core).");}if (!strlen($va3da707b651c79ecc39a4986516180b2)) {throw new Exception("Отсутствует имя файла компонента (пример: installer.php  --fname=core.tar).");}$vd4721a6bab8c7dee78cc25f7fa154bfc = $this->getDownloader();if ($vea2b2676c28c0db26d39331a336c6b92!==false && $v7f021a1415b86f2d013b2618fb31ae53!==false) {$this->flushLog("с ".$vea2b2676c28c0db26d39331a336c6b92.' по '.$v7f021a1415b86f2d013b2618fb31ae53.'...');$v9a0364b9e99bb480dd25e1f0284c8555 = $vd4721a6bab8c7dee78cc25f7fa154bfc->query('get-component', array('component' => $vb068931cc450442b63f5b3d276ea4297), $vea2b2676c28c0db26d39331a336c6b92, $v7f021a1415b86f2d013b2618fb31ae53);}else {$this->flushLog("Загрузка компонента \"{$vb068931cc450442b63f5b3d276ea4297}\"...");$v9a0364b9e99bb480dd25e1f0284c8555 = $vd4721a6bab8c7dee78cc25f7fa154bfc->query('get-component', array('component' => $vb068931cc450442b63f5b3d276ea4297));}file_put_contents($va3da707b651c79ecc39a4986516180b2, $v9a0364b9e99bb480dd25e1f0284c8555, FILE_APPEND);return true;}private function extractComponents() {if($this->checkDone(__METHOD__)) return true;$vcbde2df6a7c89370edc449dc5705d30c = $this->temp_dir . "/update-instructions.xml";$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if (!$v9a09b4dfda82e3e665e31092d1c3ec8d->load($vcbde2df6a7c89370edc449dc5705d30c)) {throw new Exception("Не удается загрузить инструкции по обновлению");}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v4725dcf446a342f1473a8228e42dfa48 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//package/component[not(@extracted)]");foreach ($v4725dcf446a342f1473a8228e42dfa48 as $v700c216fb376666eaeda0c892e8bdc09) {$vb068931cc450442b63f5b3d276ea4297 = $v700c216fb376666eaeda0c892e8bdc09->getAttribute('name');$result = $this->execSubProcess('extract-component', array('component' => $vb068931cc450442b63f5b3d276ea4297));if($result) {$v700c216fb376666eaeda0c892e8bdc09->setAttribute('extracted', true);$v9a09b4dfda82e3e665e31092d1c3ec8d->save($vcbde2df6a7c89370edc449dc5705d30c);}if(!$this->cli_mode) return false;}$this->flushLog("Все компоненты были распакованы.");$this->setDone(__METHOD__);return $this->cli_mode;}private function extractComponent() {$vb068931cc450442b63f5b3d276ea4297 = isset($this->params['component']) ? trim($this->params['component']) : '';if (!strlen($vb068931cc450442b63f5b3d276ea4297)) {throw new Exception("Отсутствует имя компонента (пример: installer.php  --component=core).");}$this->flushLog("Распаковка компонента \"{$vb068931cc450442b63f5b3d276ea4297}\"...");$v109633366fd0d46d371ede589998abaa = getcwd();$vf411599a33ca33e91fd910ca3943ed15 = $this->temp_dir . "/" . $vb068931cc450442b63f5b3d276ea4297;if (!is_dir($vf411599a33ca33e91fd910ca3943ed15)) {mkdir($vf411599a33ca33e91fd910ca3943ed15);}chdir($vf411599a33ca33e91fd910ca3943ed15);$v511e5487be332e901519c6cecc467990 = new umiTarExtracter("../" . $vb068931cc450442b63f5b3d276ea4297 . ".tar");$v511e5487be332e901519c6cecc467990->extractFiles();chdir($v109633366fd0d46d371ede589998abaa);unlink($this->temp_dir.$vb068931cc450442b63f5b3d276ea4297.".tar");$this->flushLog("Компонент \"{$vb068931cc450442b63f5b3d276ea4297}\" был распакован.");return true;}private function checkComponents() {if($this->checkDone(__METHOD__)) return true;$vcbde2df6a7c89370edc449dc5705d30c = $this->temp_dir . "/update-instructions.xml";$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if (!$v9a09b4dfda82e3e665e31092d1c3ec8d->load($vcbde2df6a7c89370edc449dc5705d30c)) {throw new Exception("Не удается загрузить инструкции по обновлению");}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v4725dcf446a342f1473a8228e42dfa48 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//package/component[not(@checked)]");foreach ($v4725dcf446a342f1473a8228e42dfa48 as $v700c216fb376666eaeda0c892e8bdc09) {$vb068931cc450442b63f5b3d276ea4297 = $v700c216fb376666eaeda0c892e8bdc09->getAttribute('name');$result = $this->execSubProcess('check-component', array('component' => $vb068931cc450442b63f5b3d276ea4297));if($result) {$v700c216fb376666eaeda0c892e8bdc09->setAttribute('checked', true);$v9a09b4dfda82e3e665e31092d1c3ec8d->save($vcbde2df6a7c89370edc449dc5705d30c);}if(!$this->cli_mode) return false;}$this->flushLog("Все компоненты были проверены.");$this->setDone(__METHOD__);return $this->cli_mode;}private function downloadDemosite() {if (!$this->install_mode) {$this->setDone(__METHOD__);return true;}if($this->checkDone(__METHOD__)) return true;$vb068931cc450442b63f5b3d276ea4297 = $this->getConfigOption("DEMOSITE", "name", "_blank");if($vb068931cc450442b63f5b3d276ea4297 == "_blank") return true;$this->flushLog("Загрузка сайта \"{$vb068931cc450442b63f5b3d276ea4297}\"...");$vd4721a6bab8c7dee78cc25f7fa154bfc = $this->getDownloader();$vd4721a6bab8c7dee78cc25f7fa154bfc->downloadDemosite($vb068931cc450442b63f5b3d276ea4297);$this->flushLog("Сайт \"{$vb068931cc450442b63f5b3d276ea4297}\" был загружен.");$this->setDone(__METHOD__);return $this->cli_mode;}private function extractDemosite() {if (!$this->install_mode) {$this->setDone(__METHOD__);return true;}if($this->checkDone(__METHOD__)) return true;$vb068931cc450442b63f5b3d276ea4297 = $this->getConfigOption("DEMOSITE", "name", "_blank");if($vb068931cc450442b63f5b3d276ea4297 == "_blank") return true;$result = $this->execSubProcess('extract-component', array('component' => $vb068931cc450442b63f5b3d276ea4297));$this->setDone(__METHOD__, $result);return $result && $this->cli_mode;}private function installDemosite() {if (!$this->install_mode) {$this->setDone(__METHOD__);return true;}if($this->checkDone(__METHOD__)) return true;$vb068931cc450442b63f5b3d276ea4297 = $this->getConfigOption("DEMOSITE", "name", "_blank");if($vb068931cc450442b63f5b3d276ea4297 == "_blank") return true;do {$v7a86c157ee9713c34fbd7a1ee40f0c5a = $this->getComponentOffset($vb068931cc450442b63f5b3d276ea4297);if ($v7a86c157ee9713c34fbd7a1ee40f0c5a==0) {$this->flushLog("Установка сайта {$vb068931cc450442b63f5b3d276ea4297}...");}$result = $this->execSubProcess('install-component', array('component' => $vb068931cc450442b63f5b3d276ea4297, 'type' => 'demosite'));$this->loadState();$v7accef6c2c3c7e2b4ec045ed6360b2ae = $this->getComponentOffset($vb068931cc450442b63f5b3d276ea4297);if ($v7accef6c2c3c7e2b4ec045ed6360b2ae!=$v7a86c157ee9713c34fbd7a1ee40f0c5a && !$this->cli_mode) {return false;}}while ($v7a86c157ee9713c34fbd7a1ee40f0c5a!=$v7accef6c2c3c7e2b4ec045ed6360b2ae);$this->flushLog("Сайт {$vb068931cc450442b63f5b3d276ea4297} установлен.");$this->setDone(__METHOD__);return true;}private function checkDemosite() {if (!$this->install_mode) {$this->setDone(__METHOD__);return true;}if($this->checkDone(__METHOD__)) return true;$vb068931cc450442b63f5b3d276ea4297 = $this->getConfigOption("DEMOSITE", "name", "_blank");if($vb068931cc450442b63f5b3d276ea4297 == "_blank") return true;$result = $this->execSubProcess('check-component', array('component' => $vb068931cc450442b63f5b3d276ea4297));$this->setDone(__METHOD__, $result);return $result && $this->cli_mode;}private function updateInstaller() {if($this->checkDone(__METHOD__)) return true;$this->flushLog("Обновление инсталлятора...");if (defined('INSTALLER_DEBUG') && INSTALLER_DEBUG) {$this->flushLog("Not updated (debug mode).");$this->setDone(__METHOD__);return true;}$v97384261b8bbf966df16e5ad509922db = $this->temp_dir . "/core/smu/installer.php";if (!is_file($v97384261b8bbf966df16e5ad509922db)) {throw new Exception("Инсталлятор не найден в пакете: " . $v97384261b8bbf966df16e5ad509922db);}if (!copy($v97384261b8bbf966df16e5ad509922db, __FILE__)) {throw new Exception("Не удалось обновить инсталлятор, возможно файл " . __FILE__ . " не доступен для записи." . $v97384261b8bbf966df16e5ad509922db);}else {chmod(__FILE__, PHP_FILES_ACCESS_MODE);}$this->flushLog("Инсталлятор был обновлен.");$this->setDone(__METHOD__);return $this->cli_mode;}private function checkComponent() {$vb068931cc450442b63f5b3d276ea4297 = isset($this->params['component']) ? trim($this->params['component']) : '';if (!strlen($vb068931cc450442b63f5b3d276ea4297)) {throw new Exception("Не передано имя компонента для проверки (пример: installer.php  --component=core).");}$this->flushLog("Проверка компонента \"$vb068931cc450442b63f5b3d276ea4297\"...");$v2245023265ae4cf87d02c8b6ba991139 = $this->temp_dir . "/" . $vb068931cc450442b63f5b3d276ea4297 . "/{$vb068931cc450442b63f5b3d276ea4297}.xml";if (!is_file($v2245023265ae4cf87d02c8b6ba991139)) {throw new Exception("Не удается загрузить конфигурацию компонента: " . $v2245023265ae4cf87d02c8b6ba991139);}$v4b43b0aee35624cd95b910189b3dc231 = new DomDocument();$v4b43b0aee35624cd95b910189b3dc231->load($v2245023265ae4cf87d02c8b6ba991139);$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v4b43b0aee35624cd95b910189b3dc231);$v6fc55be19664ab6bf176bd8946fcf5ad = array();$v33030abc929f083da5f6c3f755b46034 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//directory');if ($v33030abc929f083da5f6c3f755b46034->length>0) {foreach($v33030abc929f083da5f6c3f755b46034 as $v736007832d2167baaae763fd3a3f3cf1) {$va93d0e397c59c5eb9f69f9a41cc22980 = $v736007832d2167baaae763fd3a3f3cf1->getAttribute('path');if (is_dir($va93d0e397c59c5eb9f69f9a41cc22980) && !is_writable($va93d0e397c59c5eb9f69f9a41cc22980)) {$v6fc55be19664ab6bf176bd8946fcf5ad[] = $va93d0e397c59c5eb9f69f9a41cc22980;}}}if (!$this->install_mode) {$v45b963397aa40d4a0063e0d85e4fe7a1 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//file[not(@only_install)]');}else {$v45b963397aa40d4a0063e0d85e4fe7a1 = $v3d788fa62d7c185a1bee4c9147ee1091->query('//file');}if ($v45b963397aa40d4a0063e0d85e4fe7a1->length>0) {foreach($v45b963397aa40d4a0063e0d85e4fe7a1 as $v8c7dd922ad47494fc02c388e12c00eac) {$v97fd815a3803a0588876bdd862014fed = $v8c7dd922ad47494fc02c388e12c00eac->getAttribute('path');if (is_file($v97fd815a3803a0588876bdd862014fed) && !is_writable($v97fd815a3803a0588876bdd862014fed)) {$v6fc55be19664ab6bf176bd8946fcf5ad[] = $v97fd815a3803a0588876bdd862014fed;}$v97fd815a3803a0588876bdd862014fed = $this->temp_dir . "/" . $vb068931cc450442b63f5b3d276ea4297 . "/" . $v8c7dd922ad47494fc02c388e12c00eac->textContent;$vbd5e0a6ba7157357488d5680019068dc = $v8c7dd922ad47494fc02c388e12c00eac->getAttribute('hash');if (!is_file($v97fd815a3803a0588876bdd862014fed)) {throw new Exception("Файл \"{$v97fd815a3803a0588876bdd862014fed}\" не существует");}if ($vbd5e0a6ba7157357488d5680019068dc != md5_file($v97fd815a3803a0588876bdd862014fed)) {throw new Exception("Файл \"{$v97fd815a3803a0588876bdd862014fed}\" загружен неверно (контрольная сумма: {$vbd5e0a6ba7157357488d5680019068dc})");}}}if (count($v6fc55be19664ab6bf176bd8946fcf5ad)) {throw new Exception("Невозможно обновить систему, пока следующие файлы и директории недоступны на запись:<br/>\n" . implode("<br/>\n", $v6fc55be19664ab6bf176bd8946fcf5ad));}$this->flushLog("Компонент \"{$vb068931cc450442b63f5b3d276ea4297}\" был проверен.");return true;}private function includeMicrocore() {$va74ad8dfacd4f985eb3977517615ce25 = $this->temp_dir . "core/smu/umicms-microcore.php";if (!is_file($va74ad8dfacd4f985eb3977517615ce25)) {throw new Exception('Не найдено microcore для обновления: ' . $va74ad8dfacd4f985eb3977517615ce25);}include_once $va74ad8dfacd4f985eb3977517615ce25;ini_set('display_errors', 0);error_reporting(0);$this->connection = ConnectionPool::getInstance()->getConnection();}private function saveSVInfo() {if($this->checkDone(__METHOD__)) return true;$this->flushLog('Сохранение данных супервайзера...');$v743541121c12a113af807d1582c74bea = umiObjectsCollection::getInstance()->getObjectByGUID('system-supervisor');if (!$v743541121c12a113af807d1582c74bea) {$v743541121c12a113af807d1582c74bea = umiObjectsCollection::getInstance()->getObject(14);}$_SV['login'] = $v743541121c12a113af807d1582c74bea->login;$_SV['md5pass'] = $v743541121c12a113af807d1582c74bea->password;$_SV['email'] = $v743541121c12a113af807d1582c74bea->getValue("e-mail");$_SV['fname'] = $v743541121c12a113af807d1582c74bea->fname;$_SV['lname'] = $v743541121c12a113af807d1582c74bea->lname;$_SV['mname'] = $v743541121c12a113af807d1582c74bea->father_name;$this->saveSettings($_SV);$this->flushLog('завершено.');$this->setDone(__METHOD__);return false;}private function dropTables($vd6fe1d0be6347b8ef2427fa629c04485) {if($this->checkDone(__METHOD__)) return true;$v0f635d0e0f3874fff8b581c132e6c7a7 = new DOMDocument();$v0f635d0e0f3874fff8b581c132e6c7a7->load($vd6fe1d0be6347b8ef2427fa629c04485);$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v0f635d0e0f3874fff8b581c132e6c7a7);$v9ab2ec7ea4a2041306f7bdf150fcd453 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//table[@drop]");if ($v9ab2ec7ea4a2041306f7bdf150fcd453->length==0) {$this->flushLog('Удаление таблиц в базе данных...');}$v9ab2ec7ea4a2041306f7bdf150fcd453 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//table[not(@drop)]");if ($v9ab2ec7ea4a2041306f7bdf150fcd453->length==0) {$v9ab2ec7ea4a2041306f7bdf150fcd453 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//table");foreach($v9ab2ec7ea4a2041306f7bdf150fcd453 as $vaab9e1de16f38176f86d7a92ba337a8d) {$vaab9e1de16f38176f86d7a92ba337a8d->removeAttribute('drop');}$v0f635d0e0f3874fff8b581c132e6c7a7->save($vd6fe1d0be6347b8ef2427fa629c04485);$this->flushLog('завершено');$this->setDone(__METHOD__);return false;}$v1b1cc7f086b3f074da452bc3129981eb = "SET foreign_key_checks = 0";l_mysql_query($v1b1cc7f086b3f074da452bc3129981eb);foreach($v9ab2ec7ea4a2041306f7bdf150fcd453 as $vaab9e1de16f38176f86d7a92ba337a8d) {l_mysql_query("DROP TABLE IF EXISTS `".$vaab9e1de16f38176f86d7a92ba337a8d->getAttribute('name')."`");$this->flushLog("Очистка таблицы ".$vaab9e1de16f38176f86d7a92ba337a8d->getAttribute('name'));$vaab9e1de16f38176f86d7a92ba337a8d->setAttribute('drop', 1);$v0f635d0e0f3874fff8b581c132e6c7a7->save($vd6fe1d0be6347b8ef2427fa629c04485);return false;}}private function saveDatabaseStructure($vd6fe1d0be6347b8ef2427fa629c04485) {if ($this->checkDone(__METHOD__)) return true;$this->flushLog("Обновление структуры базы данных...");$v0ea7dd4da372f1a68a5dda3b9fc7e2e8 = new dbSchemeConverter($this->connection);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setDestinationFile($vd6fe1d0be6347b8ef2427fa629c04485);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setMode('save');$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->run();$this->setDone(__METHOD__);return false;}private function updateDatabaseStructureFromFile($v8238d85b3a16e1f9d7c13d94fc6bb129, $vb35a2a11274f75067bea31d9b92978f5, $v0241e29d5a777e1f61eb1ecf1cba1239=false) {if ($this->checkDone(__METHOD__)) return true;$v0ea7dd4da372f1a68a5dda3b9fc7e2e8 = new dbSchemeConverter($this->connection);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setDestinationFile($v8238d85b3a16e1f9d7c13d94fc6bb129);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setSourceFile($vb35a2a11274f75067bea31d9b92978f5);$v0ea7dd4da372f1a68a5dda3b9fc7e2e8->setMode('restore', $v0241e29d5a777e1f61eb1ecf1cba1239);while(true) {$va363b8d13575101a0226e8d0d054f2e7 = $v0ea7dd4da372f1a68a5dda3b9fc7e2e8->run();$result = $v0ea7dd4da372f1a68a5dda3b9fc7e2e8->getConverterLog();foreach($result as $v78e731027d8fd50ed642340b7c9a63b3) {$this->flushLog($v78e731027d8fd50ed642340b7c9a63b3);}if ($va363b8d13575101a0226e8d0d054f2e7===true) {break;}return false;}$this->setDone(__METHOD__);return false;}private function updateDatabaseStructure() {if($this->checkDone(__METHOD__)) return true;$this->includeMicrocore();if (!$this->install_mode) {if (!$this->saveSVInfo() && !INSTALLER_CLI_MODE) return false;}$vb35a2a11274f75067bea31d9b92978f5 = $this->temp_dir . "/core/smu/database.xml";if (!is_file($vb35a2a11274f75067bea31d9b92978f5)) {throw new Exception("Не удается найти структуру базы данных: " . $vb35a2a11274f75067bea31d9b92978f5);}if ($this->install_mode) {while(!$this->dropTables($vb35a2a11274f75067bea31d9b92978f5)) {if (!INSTALLER_CLI_MODE) return false;}}$v8238d85b3a16e1f9d7c13d94fc6bb129 = str_replace('.xml', '_old.xml', $vb35a2a11274f75067bea31d9b92978f5);while(!$this->saveDatabaseStructure($v8238d85b3a16e1f9d7c13d94fc6bb129)) {if (!INSTALLER_CLI_MODE) return false;}if ($this->install_mode) {$this->updateDatabaseStructureFromFile($v8238d85b3a16e1f9d7c13d94fc6bb129, $vb35a2a11274f75067bea31d9b92978f5, false);}else {$v0d0715810d27a5063ff42e87f3858eb5 = mainConfiguration::getInstance()->get('updates', 'update-database-by-parts');if ( is_null($v0d0715810d27a5063ff42e87f3858eb5) ) {$v0d0715810d27a5063ff42e87f3858eb5 = true;}$v0d0715810d27a5063ff42e87f3858eb5 = (boolean) $v0d0715810d27a5063ff42e87f3858eb5;if ( !$v0d0715810d27a5063ff42e87f3858eb5 ) {$this->updateDatabaseStructureFromFile($v8238d85b3a16e1f9d7c13d94fc6bb129, $vb35a2a11274f75067bea31d9b92978f5, false);}else {while(!$this->updateDatabaseStructureFromFile($v8238d85b3a16e1f9d7c13d94fc6bb129, $vb35a2a11274f75067bea31d9b92978f5, $v0d0715810d27a5063ff42e87f3858eb5)) {if ( !INSTALLER_CLI_MODE ) return false;}}}$this->flushLog("Структура базы данных обновлена.");$this->setDone(__METHOD__);return $this->cli_mode;}private function installComponents() {if($this->checkDone(__METHOD__)) return true;$vcbde2df6a7c89370edc449dc5705d30c = $this->temp_dir . "/update-instructions.xml";$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if (!$v9a09b4dfda82e3e665e31092d1c3ec8d->load($vcbde2df6a7c89370edc449dc5705d30c)) {throw new Exception("Не удается загрузить инструкции по обновлению");}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v4725dcf446a342f1473a8228e42dfa48 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//package/component[not(@installed)]");foreach ($v4725dcf446a342f1473a8228e42dfa48 as $v700c216fb376666eaeda0c892e8bdc09) {$vb068931cc450442b63f5b3d276ea4297 = $v700c216fb376666eaeda0c892e8bdc09->getAttribute('name');if ($v3d788fa62d7c185a1bee4c9147ee1091->query("//package/component[@installed]")->length==0 && $this->getComponentOffset($vb068931cc450442b63f5b3d276ea4297)==0) {$this->flushLog("Установка компонентов...");}do {$v5c620bc2432d8d943bd414e3a71ec8d8 = $this->getComponentOffset($vb068931cc450442b63f5b3d276ea4297);if ($v5c620bc2432d8d943bd414e3a71ec8d8==0) {$this->flushLog("Установка компонента {$vb068931cc450442b63f5b3d276ea4297}...");if (!$this->install_mode) {$ve7c4a00691c547adc1250842bd67f6e9 = $this->temp_dir . "/{$vb068931cc450442b63f5b3d276ea4297}/{$vb068931cc450442b63f5b3d276ea4297}.xml";$v36cd38f49b9afa08222c0dc9ebfe35eb = new DomDocument();$v36cd38f49b9afa08222c0dc9ebfe35eb->load($ve7c4a00691c547adc1250842bd67f6e9);$v3ef0008a0f252a1c815aa7e85275df76 = new DOMXPath($v36cd38f49b9afa08222c0dc9ebfe35eb);$v12a01e7d04a02c27a01d54e1c314697d = $v3ef0008a0f252a1c815aa7e85275df76->query('//file[@only_install]');foreach($v12a01e7d04a02c27a01d54e1c314697d as $v8c7dd922ad47494fc02c388e12c00eac) {$vd6fe1d0be6347b8ef2427fa629c04485 = $v8c7dd922ad47494fc02c388e12c00eac->textContent;if (file_exists(CURRENT_WORKING_DIR.$vd6fe1d0be6347b8ef2427fa629c04485)) {$v8c7dd922ad47494fc02c388e12c00eac->parentNode->removeChild($v8c7dd922ad47494fc02c388e12c00eac);}else {$v8c7dd922ad47494fc02c388e12c00eac->removeAttribute("only_install");}}$v36cd38f49b9afa08222c0dc9ebfe35eb->save($ve7c4a00691c547adc1250842bd67f6e9);}}$result = $this->execSubProcess('install-component', array('component' => $vb068931cc450442b63f5b3d276ea4297));$this->loadState();$v7accef6c2c3c7e2b4ec045ed6360b2ae = $this->getComponentOffset($vb068931cc450442b63f5b3d276ea4297);if ($v7accef6c2c3c7e2b4ec045ed6360b2ae>=$v5c620bc2432d8d943bd414e3a71ec8d8+self::$split_block_size && !$this->cli_mode) {return false;}}while ($v7accef6c2c3c7e2b4ec045ed6360b2ae>=$v5c620bc2432d8d943bd414e3a71ec8d8+self::$split_block_size);$this->flushLog("Компонент {$vb068931cc450442b63f5b3d276ea4297} установлен.");$v700c216fb376666eaeda0c892e8bdc09->setAttribute('installed', true);$v9a09b4dfda82e3e665e31092d1c3ec8d->save($vcbde2df6a7c89370edc449dc5705d30c);if(!$this->cli_mode) return false;}$this->flushLog("Все компоненты были установлены.");$this->setDone(__METHOD__);return true;}private function delete($vd6fe1d0be6347b8ef2427fa629c04485) {if (is_dir($vd6fe1d0be6347b8ef2427fa629c04485)) {$v5891da2d64975cae48d175d1e001f5da = scandir($vd6fe1d0be6347b8ef2427fa629c04485);foreach ($v5891da2d64975cae48d175d1e001f5da as $va8cfde6331bd59eb2ac96f8911c4b666) {if ($va8cfde6331bd59eb2ac96f8911c4b666 != "." && $va8cfde6331bd59eb2ac96f8911c4b666 != "..") {if (filetype($vd6fe1d0be6347b8ef2427fa629c04485."/".$va8cfde6331bd59eb2ac96f8911c4b666) == "dir") {$this->delete($v736007832d2167baaae763fd3a3f3cf1."/".$va8cfde6331bd59eb2ac96f8911c4b666);}else {unlink($v736007832d2167baaae763fd3a3f3cf1."/".$va8cfde6331bd59eb2ac96f8911c4b666);}}}reset($v5891da2d64975cae48d175d1e001f5da);rmdir($v736007832d2167baaae763fd3a3f3cf1);}}private function installComponent() {$this->includeMicrocore();$vb068931cc450442b63f5b3d276ea4297 = $v13921f0f9e84cf745ef7cdf661c74b0c = isset($this->params['component']) ? trim($this->params['component']) : '';if (!strlen($vb068931cc450442b63f5b3d276ea4297)) {throw new Exception("Не передано имя компонента для установки (пример: installer.php  --component=core).");}$v7a86c157ee9713c34fbd7a1ee40f0c5a = $v261beee97b53b9fb5a5265d58670c7a8 = $this->getComponentOffset($v13921f0f9e84cf745ef7cdf661c74b0c);$ve7c4a00691c547adc1250842bd67f6e9 = $this->temp_dir . "/{$v13921f0f9e84cf745ef7cdf661c74b0c}/{$v13921f0f9e84cf745ef7cdf661c74b0c}.xml";if (!is_file($ve7c4a00691c547adc1250842bd67f6e9)) {throw new Exception("Не удается найти файл конфигурации компонента \"{$v13921f0f9e84cf745ef7cdf661c74b0c}\": " . $ve7c4a00691c547adc1250842bd67f6e9);}$this->flushLog("с {$v7a86c157ee9713c34fbd7a1ee40f0c5a} по ".($v7a86c157ee9713c34fbd7a1ee40f0c5a+self::$split_block_size));$v1bc49dba86c5074c5266c6d38c301a46 = new xmlImporter(isset($this->params['type']) ? trim($this->params['type']) : 'system');if (isset($this->params['type']) && trim($this->params['type']) == 'demosite') {$v45b7e5a476c7c8aa0c5cfca50f833af1 = false;$v1bc49dba86c5074c5266c6d38c301a46->setDemositeMode(true);}else {$v45b7e5a476c7c8aa0c5cfca50f833af1 = $this->install_mode;}$v1bc49dba86c5074c5266c6d38c301a46->setUpdateIgnoreMode($v45b7e5a476c7c8aa0c5cfca50f833af1);$v1bc49dba86c5074c5266c6d38c301a46->setFilesSource($this->temp_dir . "/{$v13921f0f9e84cf745ef7cdf661c74b0c}/");$vbfde4c938d366cad9404b4647ba35217 = 'umiDump20';if ( (isset($this->params['type']) && trim($this->params['type']) == 'demosite') || !$this->install_mode) {$vbfde4c938d366cad9404b4647ba35217 = 'transfer';}$v44fd8e2f3008c90601a84a2de4382272 = $vbfde4c938d366cad9404b4647ba35217 . 'Splitter';$ved8430dc53fe9c99911b7c85e45aa6a2 = new $v44fd8e2f3008c90601a84a2de4382272($vbfde4c938d366cad9404b4647ba35217);$ved8430dc53fe9c99911b7c85e45aa6a2->load($ve7c4a00691c547adc1250842bd67f6e9, self::$split_block_size, $v7a86c157ee9713c34fbd7a1ee40f0c5a);$v1bc49dba86c5074c5266c6d38c301a46->loadXmlDocument($ved8430dc53fe9c99911b7c85e45aa6a2->getDocument());$v7a86c157ee9713c34fbd7a1ee40f0c5a = $ved8430dc53fe9c99911b7c85e45aa6a2->getOffset();$this->setComponentOffset($v13921f0f9e84cf745ef7cdf661c74b0c, $v7a86c157ee9713c34fbd7a1ee40f0c5a);$v1bc49dba86c5074c5266c6d38c301a46->execute();file_put_contents(CURRENT_WORKING_DIR . "/install.log", implode("\r\n", $v1bc49dba86c5074c5266c6d38c301a46->getImportLog()), FILE_APPEND);if(($v7a86c157ee9713c34fbd7a1ee40f0c5a < ($v261beee97b53b9fb5a5265d58670c7a8 + self::$split_block_size))) {return true;}else {return false;}}private function setDefaultDomain() {if ($this->checkDone(__METHOD__)) return true;$this->flushLog("Установка домена по умолчанию...");$v9a09b4dfda82e3e665e31092d1c3ec8d = $this->loadDomDocument($this->temp_dir . "/update-instructions.xml");$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v67b3dba8bc6778101892eb77249db32e = $v3d788fa62d7c185a1bee4c9147ee1091->evaluate("/package")->item(0)->getAttribute("host");$this->includeMicrocore();$v9d6e24ec78d309695833f4c9f8310d7a = domainsCollection::getInstance()->getDefaultDomain();$v9d6e24ec78d309695833f4c9f8310d7a->setHost($v67b3dba8bc6778101892eb77249db32e);$v9d6e24ec78d309695833f4c9f8310d7a->commit();unset($v9a09b4dfda82e3e665e31092d1c3ec8d, $v3d788fa62d7c185a1bee4c9147ee1091, $v9d6e24ec78d309695833f4c9f8310d7a);$this->flushLog("завершено.");$this->setDone(__METHOD__);return true;}private function configure() {if($this->checkDone(__METHOD__)) return true;$this->includeMicrocore();$vcbde2df6a7c89370edc449dc5705d30c = $this->temp_dir . "/update-instructions.xml";$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if (!$v9a09b4dfda82e3e665e31092d1c3ec8d->load($vcbde2df6a7c89370edc449dc5705d30c)) {throw new Exception("Не удается загрузить инструкции по обновлению");}$vefe90a8e604a7c840e88d03a67f6b7d8  = $v9a09b4dfda82e3e665e31092d1c3ec8d->firstChild;$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v2af72f100c356273d46284f6fd1dfc08 = $v3d788fa62d7c185a1bee4c9147ee1091->evaluate("/package/component[@name='core']/version")->item(0);$vd56b699830e77ba53855679cb1d252da    = $this->getConfigOption('SUPERVISOR', 'login', null, "В install.ini не указан логин супервайзера.");$v65ed8a5eec59a1a6f75ec845294aead8 = $this->getConfigOption('SUPERVISOR', 'md5pass', null);if (is_null($v65ed8a5eec59a1a6f75ec845294aead8)) {$v5f4dcc3b5aa765d61d8327deb882cf99 = $this->getConfigOption('SUPERVISOR', 'password', null, "В install.ini не указан пароль супервайзера.");}$va3da707b651c79ecc39a4986516180b2    = $this->getConfigOption('SUPERVISOR', 'fname', $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("owner_fname"));$vbfbb12dc2dce9d328e8303093db2ca33    = $this->getConfigOption('SUPERVISOR', 'lname', $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("owner_lname"));$v1416bcd61ef3b1641c2dd275e06ca3cc    = $this->getConfigOption('SUPERVISOR', 'mname', $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("owner_mname"));$v0c83f57c786a0b4a39efab23731c7ebc   = $this->getConfigOption('SUPERVISOR', 'email', $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("owner_email"));$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();$vb1444fb0c07653567ad325aa25d4e37a->setVar("//settings/keycode", $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("domain_key"));$vb1444fb0c07653567ad325aa25d4e37a->setVar("//settings/system_edition", $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("edition"));$vb1444fb0c07653567ad325aa25d4e37a->setVar("//modules/autoupdate/system_edition", $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("edition"));$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/autoupdate/system_version', $v2af72f100c356273d46284f6fd1dfc08 ? $v2af72f100c356273d46284f6fd1dfc08->getAttribute("name") : "");$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/autoupdate/system_build',   $vefe90a8e604a7c840e88d03a67f6b7d8->getAttribute("last-revision"));$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/autoupdate/last_updated',   time());$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/users/def_group', umiObjectsCollection::getInstance()->getObjectIdByGUID('users-users-2374'));$vb1444fb0c07653567ad325aa25d4e37a->setVal('//modules/users/guest_id', umiObjectsCollection::getInstance()->getObjectIdByGUID('system-guest'));$v743541121c12a113af807d1582c74bea = umiObjectsCollection::getInstance()->getObjectByGUID('system-supervisor');$v743541121c12a113af807d1582c74bea->setName($vd56b699830e77ba53855679cb1d252da);$v743541121c12a113af807d1582c74bea->login = $vd56b699830e77ba53855679cb1d252da;$v743541121c12a113af807d1582c74bea->password = is_null($v65ed8a5eec59a1a6f75ec845294aead8)?md5($v5f4dcc3b5aa765d61d8327deb882cf99):$v65ed8a5eec59a1a6f75ec845294aead8;if(strlen($va3da707b651c79ecc39a4986516180b2)) $v743541121c12a113af807d1582c74bea->fname = $va3da707b651c79ecc39a4986516180b2;if(strlen($vbfbb12dc2dce9d328e8303093db2ca33)) $v743541121c12a113af807d1582c74bea->lname = $vbfbb12dc2dce9d328e8303093db2ca33;if(strlen($v1416bcd61ef3b1641c2dd275e06ca3cc)) $v743541121c12a113af807d1582c74bea->father_name = $v1416bcd61ef3b1641c2dd275e06ca3cc;if(strlen($v0c83f57c786a0b4a39efab23731c7ebc)) $v743541121c12a113af807d1582c74bea->setValue("e-mail",  $v0c83f57c786a0b4a39efab23731c7ebc);$v743541121c12a113af807d1582c74bea->commit();if (!INSTALLER_CLI_MODE && $this->install_mode) {$this->cleanup();$this->setInstalled();}$this->writeHtaccess();if (!INSTALLER_CLI_MODE) {$this->deleteInstallIni();}$this->setDone(__METHOD__);return true;}private function checkSelf() {if ( !is_writable(__FILE__) ) {throw new Exception('Файл ' . __FILE__ . ' должен быть доступен на запись');}if ( !is_dir($this->temp_dir) && !mkdir($this->temp_dir, 0777, true) ) {throw new Exception("Не удается создать временную директорию \"{$this->temp_dir}\".");}if ( !is_writeable($this->temp_dir) ) {throw new Exception("Временная директория \"{$this->temp_dir}\" не доступна для записи. Пожалуйста, проверьте разрешения.");}if ( !$this->closeByHtaccess($this->temp_dir.'/..') ) {throw new Exception("Не удается создать htaccess в директории \"{$this->temp_dir}\". Пожалуйста, проверьте разрешения.");}return true;}private function checkInstalled() {if ($this->install_mode && is_file("./installed")) {if (is_dir(CURRENT_WORKING_DIR."/umibackup")     && (file_exists(CURRENT_WORKING_DIR."/umibackup/backup_database.xml") && is_file(CURRENT_WORKING_DIR."/umibackup/backup_database.xml"))     && (file_exists(CURRENT_WORKING_DIR."/umibackup/backup_files.xml") && is_file(CURRENT_WORKING_DIR."/umibackup/backup_files.xml"))    ) {throw new Exception('UMI.CMS уже установлена. Для принудительной установки удалите файл installed из корневой директории сервера. Для восстановления системы из бекапа запустите installer.php c параметром --step=rollback');}else {throw new Exception('UMI.CMS уже установлена. Для принудительной установки удалите файл installed из корневой директории сервера.');}}if (!$this->install_mode && !INSTALLER_CLI_MODE) {$v385ac84244b813d9303b03a0393b0d12 = CURRENT_WORKING_DIR.'/umibackup/backup_files.xml';if (file_exists($v385ac84244b813d9303b03a0393b0d12)) {unlink($v385ac84244b813d9303b03a0393b0d12);}$v385ac84244b813d9303b03a0393b0d12 = CURRENT_WORKING_DIR.'/umibackup/backup_database.xml';if (file_exists($v385ac84244b813d9303b03a0393b0d12)) {unlink($v385ac84244b813d9303b03a0393b0d12);}}return true;}private function cleanup() {if ( file_exists("./sys-temp/runtime-cache/registry") ) {unlink("./sys-temp/runtime-cache/registry");}if ( is_file($this->temp_dir . umiInstallExecutor::STATE_FILE_NAME) ) {unlink($this->temp_dir . umiInstallExecutor::STATE_FILE_NAME);}self::$state = array();return true;}private function clearCache() {if ($this->checkDone(__METHOD__)) {return true;}$this->flushLog("Очистка системного кеша...");$this->includeMicrocore();$vd4721a6bab8c7dee78cc25f7fa154bfc = $this->getDownloader();$v0eb9b3af2e4a00837a1b1a854c9ea18c = $vd4721a6bab8c7dee78cc25f7fa154bfc->query('get-modules-list');$v0f635d0e0f3874fff8b581c132e6c7a7 = new DOMDocument();if ($v0f635d0e0f3874fff8b581c132e6c7a7->loadXML($v0eb9b3af2e4a00837a1b1a854c9ea18c)) {$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v0f635d0e0f3874fff8b581c132e6c7a7);$vf1f8971ed2a2bbc27b56c631013e9e85 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//module[not(@active)]");if ($vf1f8971ed2a2bbc27b56c631013e9e85->length>0) {$vb1444fb0c07653567ad325aa25d4e37a = regedit::getInstance();foreach($vf1f8971ed2a2bbc27b56c631013e9e85 as $v22884db148f0ffb0d830ba431102b0b5) {$vb068931cc450442b63f5b3d276ea4297 = $v22884db148f0ffb0d830ba431102b0b5->getAttribute('name');if ($vb1444fb0c07653567ad325aa25d4e37a->getVal("//modules/{$vb068931cc450442b63f5b3d276ea4297}")) {$vb1444fb0c07653567ad325aa25d4e37a->delVar("//modules/{$vb068931cc450442b63f5b3d276ea4297}");}}}}$v0fea6a13c52b4d4725368f24b045ca84 = cacheFrontend::getInstance();$v0fea6a13c52b4d4725368f24b045ca84->flush();$this->flushLog("Завершено.");$this->cleanUpdateMode();$this->setDone(__METHOD__);return true;}private function deleteInstallIni() {if (file_exists(CURRENT_WORKING_DIR."/install.ini") && is_file(CURRENT_WORKING_DIR."/install.ini")) {return unlink(CURRENT_WORKING_DIR."/install.ini");}}private function setInstalled() {if(!defined("INSTALLER_DEBUG") || !INSTALLER_DEBUG) {touch("./installed");}if ($this->install_mode) {$this->flushLog('UMI.CMS установлена.');}else {$this->flushLog('UMI.CMS обновлена.');}if (INSTALLER_CLI_MODE) {if ($this->deleteInstallIni()) {$this->flushLog('Файл install.ini удален.');}else {$this->flushLog('Не удалось удалить '.CURRENT_WORKING_DIR.'/install.ini. В целях обеспечения безопасности, пожалуйста, удалите его самостоятельно.');}}return true;}private function checkIniFile() {return true;}private function checkMysqlConnect() {return true;}private function execSubProcessCLI($v2764ca9d34e90313978d044f27ae433b, $v21ffce5b8a6cc8cc6a41448dd69623c9 = array(), $v8d777f385d3dfec8815d20f7496026dc = "") {$ve1bfd762321e409cee4ac0b6e841963c = $this->getConfigOption('SERVER', 'phppath', 'php');$vc9fab33e9458412c527c3fe8a13ee37d = (int) $this->getConfigOption('SETUP', 'sleep', 0);if ($vc9fab33e9458412c527c3fe8a13ee37d>0) {$this->flushLog("Sleep ".($vc9fab33e9458412c527c3fe8a13ee37d/1000)." sec");usleep($vc9fab33e9458412c527c3fe8a13ee37d*1000);}$v6e698426544e05ea09d339c3f40ef765 = array(    0 => array("pipe", "r"),  1 => array("pipe", "w"),  2 => array("pipe", "w")   );$vf91463310f6ce26ecef8ce82613c3aa4 = "";foreach($v21ffce5b8a6cc8cc6a41448dd69623c9 as $v57289251b219b7784ca956e1cc149ea0 => $v9455adb91717fb60d2270026d61d5a80) {$vf91463310f6ce26ecef8ce82613c3aa4 .= " --{$v57289251b219b7784ca956e1cc149ea0}={$v9455adb91717fb60d2270026d61d5a80}";}$vdfff0a7fa1a55c8c1a4966c19f6da452 = $ve1bfd762321e409cee4ac0b6e841963c.' -f ' . __FILE__ . ' -- --step=' . $v2764ca9d34e90313978d044f27ae433b . $vf91463310f6ce26ecef8ce82613c3aa4;$v5075140835d0bc504791c76b04c33d2b = proc_open($vdfff0a7fa1a55c8c1a4966c19f6da452, $v6e698426544e05ea09d339c3f40ef765, $v24a9384d408f3fa1654c08dfaea45dd3);if (is_resource($v5075140835d0bc504791c76b04c33d2b)) {if (strlen($v8d777f385d3dfec8815d20f7496026dc)) {fwrite($v24a9384d408f3fa1654c08dfaea45dd3[0], $v8d777f385d3dfec8815d20f7496026dc);fclose($v24a9384d408f3fa1654c08dfaea45dd3[0]);}$v07213a0161f52846ab198be103b5ab43 = "";while (($v7f2db423a49b305459147332fb01cf87 = fgets($v24a9384d408f3fa1654c08dfaea45dd3[1], self::BUFFER_SIZE)) != NULL || ($vd7d14cfd1c4872e00b60ec25335c832f = fgets($v24a9384d408f3fa1654c08dfaea45dd3[2], self::BUFFER_SIZE)) != NULL) {$this->flushLog($v7f2db423a49b305459147332fb01cf87);if (isset($vd7d14cfd1c4872e00b60ec25335c832f)) {$v07213a0161f52846ab198be103b5ab43 .= $vd7d14cfd1c4872e00b60ec25335c832f;}}if (strlen($v07213a0161f52846ab198be103b5ab43)) {echo $v07213a0161f52846ab198be103b5ab43;die();}foreach ($v24a9384d408f3fa1654c08dfaea45dd3 as $v20826a3cb51d6c7d9c219c7f4bf4e5c9) fclose($v20826a3cb51d6c7d9c219c7f4bf4e5c9);proc_close($v5075140835d0bc504791c76b04c33d2b);}else {throw new Exception("Не могу запустить дочерний процесс: {$vdfff0a7fa1a55c8c1a4966c19f6da452}");}return true;}private function execSubProcessNonCLI($v2764ca9d34e90313978d044f27ae433b, $v21ffce5b8a6cc8cc6a41448dd69623c9 = array(), $v8d777f385d3dfec8815d20f7496026dc = "") {$v89bbb705599a2cda7b83275ff6822ec0 = new umiInstallExecutor($this->temp_dir, $this->install_mode, $v21ffce5b8a6cc8cc6a41448dd69623c9);return $v89bbb705599a2cda7b83275ff6822ec0->run($v2764ca9d34e90313978d044f27ae433b, $this->cli_mode, $v21ffce5b8a6cc8cc6a41448dd69623c9);}private function execSubProcess($v2764ca9d34e90313978d044f27ae433b, $v21ffce5b8a6cc8cc6a41448dd69623c9 = array(), $v8d777f385d3dfec8815d20f7496026dc = "") {if($this->cli_mode) {return $this->execSubProcessCLI($v2764ca9d34e90313978d044f27ae433b, $v21ffce5b8a6cc8cc6a41448dd69623c9, $v8d777f385d3dfec8815d20f7496026dc);}else {return $this->execSubProcessNonCLI($v2764ca9d34e90313978d044f27ae433b, $v21ffce5b8a6cc8cc6a41448dd69623c9, $v8d777f385d3dfec8815d20f7496026dc);}}private function runInstaller() {return   $this->checkInstalled() and   $this->checkSelf() and   $this->checkIniFile() and   $this->checkMysqlConnect() and   $this->cleanup() and   $this->execSubProcess('backup-files') and   $this->execSubProcess('download-service-package') and   $this->execSubProcess('extract-service-package') and   $this->execSubProcess('run-tests') and   $this->execSubProcess('write-initial-configuration') and   $this->execSubProcess('get-update-instructions') and   $this->execSubProcess('download-components') and   $this->execSubProcess('extract-components') and   $this->execSubProcess('check-components') and   $this->execSubProcess('backup-mysql') and   $this->execSubProcess('update-installer') and   $this->execSubProcess('update-database') and   $this->execSubProcess('install-components') and   $this->execSubProcess('set-default-domain') and   $this->execSubProcess('download-demosite') and   $this->execSubProcess('extract-demosite') and   $this->execSubProcess('check-demosite') and   $this->execSubProcess('install-demosite') and   $this->execSubProcess('configure') and   $this->execSubProcess('clear-cache') and   $this->cleanup() and   $this->setInstalled();}}class umiUpdateDownloader {private $destination, $key, $host, $ip, $current_revision;private $license = array();public function __construct($v6990a54322d9232390a784c5c9247dd6, $v3c6e0b8a9c15224a8228b9a98ca1531d, $v67b3dba8bc6778101892eb77249db32e, $v957b527bcfbad2e80f58d20683931435, $v24eee2eae2a568c828691c2d48f8e29f = 'last') {if (!is_dir($v6990a54322d9232390a784c5c9247dd6)) {throw new Exception("Директория назначения не найдена");}$this->destination = realpath($v6990a54322d9232390a784c5c9247dd6);$this->key = $v3c6e0b8a9c15224a8228b9a98ca1531d;$this->host = $v67b3dba8bc6778101892eb77249db32e;$this->ip = $v957b527bcfbad2e80f58d20683931435;$this->current_revision = $v24eee2eae2a568c828691c2d48f8e29f;}public function downloadComponent($v13921f0f9e84cf745ef7cdf661c74b0c) {$this->downloadFile("get-component", $v13921f0f9e84cf745ef7cdf661c74b0c);}public function downloadDemosite($v2c096d495f99b47a48206be8488020bc) {$this->downloadFile("get-demosite", $v2c096d495f99b47a48206be8488020bc);}public function downloadServiceComponent($vd505dfd5ba4dbefdfb62c241a78f1e90) {$this->downloadFile("get-service", $vd505dfd5ba4dbefdfb62c241a78f1e90, "service");}private function downloadFile($vcee0e90a7b3dc78e2cfafc0bc31a7c97, $v435ed7e9f07f740abf511a62c00eef6e, $v1a12797fd6767dc1048bf8a56ac91d74 = false) {$va3da707b651c79ecc39a4986516180b2 = $this->destination . "/" . $v435ed7e9f07f740abf511a62c00eef6e . ($v1a12797fd6767dc1048bf8a56ac91d74 ? ".{$v1a12797fd6767dc1048bf8a56ac91d74}" : "") . ".tar";$v9a0364b9e99bb480dd25e1f0284c8555 = $this->query($vcee0e90a7b3dc78e2cfafc0bc31a7c97, array('component' => $v435ed7e9f07f740abf511a62c00eef6e));file_put_contents($va3da707b651c79ecc39a4986516180b2, $v9a0364b9e99bb480dd25e1f0284c8555);}public function getDemositesList() {$result = $this->query('get-demosite-list');$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if ($v9a09b4dfda82e3e665e31092d1c3ec8d->loadXML($result)) {$this->checkResponseErrors($v9a09b4dfda82e3e665e31092d1c3ec8d);return $v9a09b4dfda82e3e665e31092d1c3ec8d;}else {throw new Exception("Не удается загрузить список сайтов.");}}public function downloadAllComponents() {$vcbde2df6a7c89370edc449dc5705d30c = $this->destination . "/update-instructions.xml";$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if (!$v9a09b4dfda82e3e665e31092d1c3ec8d->load($vcbde2df6a7c89370edc449dc5705d30c)) {throw new Exception("Не удается загрузить инструкции по обновлению.");}$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v4725dcf446a342f1473a8228e42dfa48 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//package/component[not(@downloaded)]");foreach ($v4725dcf446a342f1473a8228e42dfa48 as $v700c216fb376666eaeda0c892e8bdc09) {$vb068931cc450442b63f5b3d276ea4297 = $v700c216fb376666eaeda0c892e8bdc09->getAttribute('name');$this->downloadComponent($vb068931cc450442b63f5b3d276ea4297);$v700c216fb376666eaeda0c892e8bdc09->setAttribute('downloaded', true);$v9a09b4dfda82e3e665e31092d1c3ec8d->save($vcbde2df6a7c89370edc449dc5705d30c);}}public function downloadUpdateInstructions() {$result = $this->query('get-update-instructions');$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if ($v9a09b4dfda82e3e665e31092d1c3ec8d->loadXML($result)) {$this->checkResponseErrors($v9a09b4dfda82e3e665e31092d1c3ec8d);file_put_contents($this->destination . "/update-instructions.xml", $v9a09b4dfda82e3e665e31092d1c3ec8d->saveXML());return $v9a09b4dfda82e3e665e31092d1c3ec8d;}else {throw new Exception("Не удается загрузить инструкции по обновлению");}}private function flushLog($v6e2baaf3b97dbeef01c0043275f9a0e7) {echo $v6e2baaf3b97dbeef01c0043275f9a0e7;}private function checkResponseErrors(DOMDocument $v9a09b4dfda82e3e665e31092d1c3ec8d) {if ($v9a09b4dfda82e3e665e31092d1c3ec8d->documentElement->getAttribute('type') == 'exception') {$v3d788fa62d7c185a1bee4c9147ee1091 = new DOMXPath($v9a09b4dfda82e3e665e31092d1c3ec8d);$v07213a0161f52846ab198be103b5ab43 = $v3d788fa62d7c185a1bee4c9147ee1091->query("//error");foreach($v07213a0161f52846ab198be103b5ab43 as $vcb5e100e5a9a3e7f6d1fd97512215282) {throw new Exception($vcb5e100e5a9a3e7f6d1fd97512215282->nodeValue, $vcb5e100e5a9a3e7f6d1fd97512215282->getAttribute('code'));}}}public function query($v599dcce2998a6b40b1e38e8c6006cb0a, $v21ffce5b8a6cc8cc6a41448dd69623c9 = array(), $vea2b2676c28c0db26d39331a336c6b92=false, $v7f021a1415b86f2d013b2618fb31ae53=false) {$v572d4e421e5e6b9bc11d815e8a027112 = $this->build_query($v599dcce2998a6b40b1e38e8c6006cb0a, $v21ffce5b8a6cc8cc6a41448dd69623c9);$v572d4e421e5e6b9bc11d815e8a027112 = preg_replace('|^http:\/\/|i', '', $v572d4e421e5e6b9bc11d815e8a027112);$v67b3dba8bc6778101892eb77249db32e = preg_replace('|\/.+$|i', '', $v572d4e421e5e6b9bc11d815e8a027112);$v1b1cc7f086b3f074da452bc3129981eb = preg_replace('|^[^/]+|i', '', $v572d4e421e5e6b9bc11d815e8a027112);if (is_callable("curl_init")) {return $this->get_file_by_curl($v67b3dba8bc6778101892eb77249db32e, $v1b1cc7f086b3f074da452bc3129981eb, $vea2b2676c28c0db26d39331a336c6b92, $v7f021a1415b86f2d013b2618fb31ae53);}elseif($v0666f0acdeed38d4cd9084ade1739498=fsockopen($v67b3dba8bc6778101892eb77249db32e, 80)) {fclose($v0666f0acdeed38d4cd9084ade1739498);return $this->get_file_by_socket($v67b3dba8bc6778101892eb77249db32e, $v1b1cc7f086b3f074da452bc3129981eb, $vea2b2676c28c0db26d39331a336c6b92, $v7f021a1415b86f2d013b2618fb31ae53);}else {throw new Exception('Запрещены функции удаленной загрузки файлов. Подробнее: http://errors.umi-cms.ru/13041/');}}public function get_file($v572d4e421e5e6b9bc11d815e8a027112) {$v572d4e421e5e6b9bc11d815e8a027112 = preg_replace('|^http:\/\/|i', '', $v572d4e421e5e6b9bc11d815e8a027112);$v67b3dba8bc6778101892eb77249db32e = preg_replace('|\/.+$|i', '', $v572d4e421e5e6b9bc11d815e8a027112);$v1b1cc7f086b3f074da452bc3129981eb = preg_replace('|^[^/]+|i', '', $v572d4e421e5e6b9bc11d815e8a027112);if (is_callable("curl_init")) {return $this->get_file_by_curl($v67b3dba8bc6778101892eb77249db32e, $v1b1cc7f086b3f074da452bc3129981eb);}elseif($v0666f0acdeed38d4cd9084ade1739498=fsockopen($v67b3dba8bc6778101892eb77249db32e, 80)) {fclose($v0666f0acdeed38d4cd9084ade1739498);return $this->get_file_by_socket($v67b3dba8bc6778101892eb77249db32e, $v1b1cc7f086b3f074da452bc3129981eb);}else {throw new Exception('Не удается создать исходящее соединение.');}}private function build_query($v599dcce2998a6b40b1e38e8c6006cb0a, $v21ffce5b8a6cc8cc6a41448dd69623c9 = array()) {$v21ffce5b8a6cc8cc6a41448dd69623c9['type'] = $v599dcce2998a6b40b1e38e8c6006cb0a;$v21ffce5b8a6cc8cc6a41448dd69623c9['host'] = $this->host;$v21ffce5b8a6cc8cc6a41448dd69623c9['ip'] = $this->ip;$v21ffce5b8a6cc8cc6a41448dd69623c9['key'] = $this->key;$v21ffce5b8a6cc8cc6a41448dd69623c9['revision'] = $this->current_revision;return base64_decode('aHR0cDovL3VwZGF0ZXMudW1pLWNtcy5ydS91cGRhdGVzZXJ2ZXIv') . "?" . http_build_query($v21ffce5b8a6cc8cc6a41448dd69623c9, '', '&');}private function get_file_by_socket($v67b3dba8bc6778101892eb77249db32e, $v1b1cc7f086b3f074da452bc3129981eb, $vea2b2676c28c0db26d39331a336c6b92=false, $v7f021a1415b86f2d013b2618fb31ae53=false) {$v0666f0acdeed38d4cd9084ade1739498 = fsockopen($v67b3dba8bc6778101892eb77249db32e, 80, $v70106d0d821513f45702b7d25664ab7c, $v809b1abe3f111fd3bb1a54c62706129f, 30);if ($vea2b2676c28c0db26d39331a336c6b92!==false && $v7f021a1415b86f2d013b2618fb31ae53!==false) {$vc68271a63ddbc431c307beb7d2918275 = "GET {$v1b1cc7f086b3f074da452bc3129981eb} HTTP/1.1\r\n";$vc68271a63ddbc431c307beb7d2918275 .= "Range: bytes={$vea2b2676c28c0db26d39331a336c6b92}-{$v7f021a1415b86f2d013b2618fb31ae53}\r\n";}else {$vc68271a63ddbc431c307beb7d2918275 = "GET {$v1b1cc7f086b3f074da452bc3129981eb} HTTP/1.0\r\n";}$vc68271a63ddbc431c307beb7d2918275 .= "Host: {$v67b3dba8bc6778101892eb77249db32e}\r\n";$vc68271a63ddbc431c307beb7d2918275 .= "Connection: Close\r\n\r\n";fwrite($v0666f0acdeed38d4cd9084ade1739498, $vc68271a63ddbc431c307beb7d2918275);$v0c7ad6d537045a61697e20d0cfa2bc66 = "";while(!feof($v0666f0acdeed38d4cd9084ade1739498)) {$v341be97d9aff90c9978347f66f945b77 = fgets($v0666f0acdeed38d4cd9084ade1739498, 1024);$v0c7ad6d537045a61697e20d0cfa2bc66.=$v341be97d9aff90c9978347f66f945b77;if (strlen($v341be97d9aff90c9978347f66f945b77)==2) {break;}}$v9b207167e5381c47682c6b4f58a623fb = '';while (!feof($v0666f0acdeed38d4cd9084ade1739498)) {$v9b207167e5381c47682c6b4f58a623fb .= fread($v0666f0acdeed38d4cd9084ade1739498, 1024);}fclose($v0666f0acdeed38d4cd9084ade1739498);if (stripos($v0c7ad6d537045a61697e20d0cfa2bc66, "text/xml")!==false) {if (!class_exists("DomDocument")) {throw new Exception("Отсутствует класс DomDocument.  Подробное описание ошибки и способы её устранения доступны по ссылке http://errors.umi-cms.ru/13051/");}$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if ($v9a09b4dfda82e3e665e31092d1c3ec8d->loadXML($v9b207167e5381c47682c6b4f58a623fb)) {$this->checkResponseErrors($v9a09b4dfda82e3e665e31092d1c3ec8d);}unset($v9a09b4dfda82e3e665e31092d1c3ec8d);}return $v9b207167e5381c47682c6b4f58a623fb;}private function get_file_by_curl($v67b3dba8bc6778101892eb77249db32e, $v1b1cc7f086b3f074da452bc3129981eb, $vea2b2676c28c0db26d39331a336c6b92=false, $v7f021a1415b86f2d013b2618fb31ae53=false) {$vd88fc6edf21ea464d35ff76288b84103 = curl_init();curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_URL, "http://{$v67b3dba8bc6778101892eb77249db32e}{$v1b1cc7f086b3f074da452bc3129981eb}");curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_HEADER, false);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_BINARYTRANSFER, true);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_RETURNTRANSFER, true);if ($vea2b2676c28c0db26d39331a336c6b92!==false && $v7f021a1415b86f2d013b2618fb31ae53!==false) {curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_RANGE, $vea2b2676c28c0db26d39331a336c6b92.'-'.$v7f021a1415b86f2d013b2618fb31ae53);$v9b207167e5381c47682c6b4f58a623fb = curl_exec($vd88fc6edf21ea464d35ff76288b84103);}$v9b207167e5381c47682c6b4f58a623fb = curl_exec($vd88fc6edf21ea464d35ff76288b84103);$vcaf9b6b99962bf5c2264824231d7a40c = curl_getinfo($vd88fc6edf21ea464d35ff76288b84103);curl_close($vd88fc6edf21ea464d35ff76288b84103);if (isset($vcaf9b6b99962bf5c2264824231d7a40c["content_type"]) && stripos($vcaf9b6b99962bf5c2264824231d7a40c["content_type"], "text/xml")!==false) {if (!class_exists("DomDocument")) {throw new Exception("Отсутствует класс DomDocument.  Подробное описание ошибки и способы её устранения доступны по ссылке http://errors.umi-cms.ru/13051/");}$v9a09b4dfda82e3e665e31092d1c3ec8d = new DOMDocument('1.0', 'utf-8');if ($v9a09b4dfda82e3e665e31092d1c3ec8d->loadXML($v9b207167e5381c47682c6b4f58a623fb)) {$this->checkResponseErrors($v9a09b4dfda82e3e665e31092d1c3ec8d);}unset($v9a09b4dfda82e3e665e31092d1c3ec8d);}return $v9b207167e5381c47682c6b4f58a623fb;}}class umiTarExtracter {const TAR_CHUNK_SIZE = 512;const TAR_ENTRY_REGULARFILE = '0';const TAR_ENTRY_HARDLINK  = '1';const TAR_ENTRY_SYMLINK  = '2';const TAR_ENTRY_CHARDEVICE  = '3';const TAR_ENTRY_BLOCKDEVICE = '4';const TAR_ENTRY_DIRECTORY = '5';const TAR_ENTRY_FIFO   = '6';const TAR_ENTRY_RESERVED  = '7';private $unpackString = 'a100name/a8mode/a8uid/a8gid/a12size/a12mtime/a8checksum/atypeflag/a100linkname/a6magic/a2version/a32uname/a32gname/a8devmajor/a8devminor/a155prefix/x12pad';private $archiveFilename = null;private $handle = null;public function __construct($v435ed7e9f07f740abf511a62c00eef6e) {if (version_compare(PHP_VERSION, '5.5.0', '>=')) {$this->unpackString = 'Z100name/Z8mode/Z8uid/Z8gid/Z12size/Z12mtime/Z8checksum/Ztypeflag/Z100linkname/Z6magic/Z2version/Z32uname/Z32gname/Z8devmajor/Z8devminor/Z155prefix/x12pad';}$this->archiveFilename = $v435ed7e9f07f740abf511a62c00eef6e;if(!is_file($this->archiveFilename)) {throw new Exception("umiTarExtracter: {$this->archiveFilename} не существует.");}}public function __destruct() {$this->close();}public function extractFiles($v7a86c157ee9713c34fbd7a1ee40f0c5a = false, $vaa9f73eea60a006820d0f8768bc8a3fc = false) {$v27e06cd2e2c6ab6e2cf7abb4f0db0a37 = 0;$this->open();fseek($this->handle, 0, SEEK_SET);while($v27e06cd2e2c6ab6e2cf7abb4f0db0a37 < $v7a86c157ee9713c34fbd7a1ee40f0c5a) {$v8d777f385d3dfec8815d20f7496026dc = fread($this->handle, umiTarExtracter::TAR_CHUNK_SIZE);if($this->eof($v8d777f385d3dfec8815d20f7496026dc)) {return $v27e06cd2e2c6ab6e2cf7abb4f0db0a37;}$v099fb995346f31c749f6e40db0f395e3 = $this->parseEntryHeader($v8d777f385d3dfec8815d20f7496026dc);if($v099fb995346f31c749f6e40db0f395e3['typeflag'] == umiTarExtracter::TAR_ENTRY_REGULARFILE) {$v6cd7ba40b435f91219de4fb36548b023 = floor($v099fb995346f31c749f6e40db0f395e3['size'] / umiTarExtracter::TAR_CHUNK_SIZE) + 1;fseek($this->handle, $v6cd7ba40b435f91219de4fb36548b023 * umiTarExtracter::TAR_CHUNK_SIZE, SEEK_CUR);}$v27e06cd2e2c6ab6e2cf7abb4f0db0a37++;}while($vaa9f73eea60a006820d0f8768bc8a3fc === false || ($v27e06cd2e2c6ab6e2cf7abb4f0db0a37 < $v7a86c157ee9713c34fbd7a1ee40f0c5a + $vaa9f73eea60a006820d0f8768bc8a3fc)) {$v8d777f385d3dfec8815d20f7496026dc = fread($this->handle, umiTarExtracter::TAR_CHUNK_SIZE);if($this->eof($v8d777f385d3dfec8815d20f7496026dc)) {break;}$v099fb995346f31c749f6e40db0f395e3 = $this->parseEntryHeader($v8d777f385d3dfec8815d20f7496026dc);$vb068931cc450442b63f5b3d276ea4297 = (strlen($v099fb995346f31c749f6e40db0f395e3['prefix']) ? ($v099fb995346f31c749f6e40db0f395e3['prefix'] . '/') : '') . $v099fb995346f31c749f6e40db0f395e3['name'];switch($v099fb995346f31c749f6e40db0f395e3['typeflag']) {case umiTarExtracter::TAR_ENTRY_REGULARFILE : {$v3d4f47f9d78852ddc35ad26a0c42ba31 = fopen($vb068931cc450442b63f5b3d276ea4297, "wb");if (!$v3d4f47f9d78852ddc35ad26a0c42ba31) {throw new Exception("umiTarExtracter: не удается записать файл: " . $vb068931cc450442b63f5b3d276ea4297);}$v1ad7a99257f9c95f501a2ea541af3e83 = $v099fb995346f31c749f6e40db0f395e3['size'];if ($v1ad7a99257f9c95f501a2ea541af3e83)      do {$vea5273f98c146546ece478f217cf01c7 = $v1ad7a99257f9c95f501a2ea541af3e83 < umiTarExtracter::TAR_CHUNK_SIZE ? $v1ad7a99257f9c95f501a2ea541af3e83 : umiTarExtracter::TAR_CHUNK_SIZE;$v4b3a6218bb3e3a7303e8a171a60fcf92 = fread($this->handle, umiTarExtracter::TAR_CHUNK_SIZE);fwrite($v3d4f47f9d78852ddc35ad26a0c42ba31, $v4b3a6218bb3e3a7303e8a171a60fcf92, $vea5273f98c146546ece478f217cf01c7);$v1ad7a99257f9c95f501a2ea541af3e83 -= umiTarExtracter::TAR_CHUNK_SIZE;}while($v1ad7a99257f9c95f501a2ea541af3e83 > 0);fclose($v3d4f47f9d78852ddc35ad26a0c42ba31);if (strtolower(substr($vb068931cc450442b63f5b3d276ea4297, -4, 4))==='.php') {chmod($vb068931cc450442b63f5b3d276ea4297, PHP_FILES_ACCESS_MODE);}break;}case umiTarExtracter::TAR_ENTRY_DIRECTORY : {if(!is_dir($vb068931cc450442b63f5b3d276ea4297)) {if (!mkdir($vb068931cc450442b63f5b3d276ea4297, 0777, true)) {throw new Exception("umiTarExtracter: не удается создать директорию: " . $vb068931cc450442b63f5b3d276ea4297);exit();}}break;}}$v27e06cd2e2c6ab6e2cf7abb4f0db0a37++;}return $v27e06cd2e2c6ab6e2cf7abb4f0db0a37;}private function open() {if($this->handle == null) {$this->handle = fopen($this->archiveFilename, 'rb');if($this->handle === false) {throw new Exception("umiTarExtracter: Не удается открыть {$this->archiveFilename}");}}return $this->handle;}private function close() {if($this->handle != null) {fclose($this->handle);}}private function parseEntryHeader($v86439efb5a718d47685e2bffc6c6bc2e) {$v099fb995346f31c749f6e40db0f395e3 = unpack($this->unpackString, $v86439efb5a718d47685e2bffc6c6bc2e);$v099fb995346f31c749f6e40db0f395e3['uid']   = octdec($v099fb995346f31c749f6e40db0f395e3['uid']);$v099fb995346f31c749f6e40db0f395e3['gid']   = octdec($v099fb995346f31c749f6e40db0f395e3['gid']);$v099fb995346f31c749f6e40db0f395e3['size']  = octdec($v099fb995346f31c749f6e40db0f395e3['size']);$v099fb995346f31c749f6e40db0f395e3['mtime']  = octdec($v099fb995346f31c749f6e40db0f395e3['mtime']);$v099fb995346f31c749f6e40db0f395e3['checksum'] = octdec(substr($v099fb995346f31c749f6e40db0f395e3['checksum'], 0, 6));return $v099fb995346f31c749f6e40db0f395e3;}private function eof(&$v8d777f385d3dfec8815d20f7496026dc) {$vc4e61fa240610a944fda0d75e4be2343 = null;if($vc4e61fa240610a944fda0d75e4be2343 == null){$vc4e61fa240610a944fda0d75e4be2343 = str_repeat(chr(0), 512);}if(strcmp($v8d777f385d3dfec8815d20f7496026dc, $vc4e61fa240610a944fda0d75e4be2343) == 0) {$v8e69d7d49231cedc9a1273af9ac01da7 = fread($this->handle, umiTarExtracter::TAR_CHUNK_SIZE);if(strcmp($v8e69d7d49231cedc9a1273af9ac01da7, $vc4e61fa240610a944fda0d75e4be2343) == 0) {return true;}fseek($this->handle, -umiTarExtracter::TAR_CHUNK_SIZE, SEEK_CUR);}return false;}};function parse_argv($v47c80780ab608cc046f2a6e6f071feb6) {$args = Array();foreach($v47c80780ab608cc046f2a6e6f071feb6 as $v9e3669d19b675bd57058fd4664205d2a) {$v43b1cc1db7be63d899dd4280f578691a = explode("=", $v9e3669d19b675bd57058fd4664205d2a);if(sizeof($v43b1cc1db7be63d899dd4280f578691a) != 2) continue;list($v8ce4b16b22b58894aa86c421e8759df3, $v83878c91171338902e0fe0fb97a8c47a) = $v43b1cc1db7be63d899dd4280f578691a;$args[trim(substr($v8ce4b16b22b58894aa86c421e8759df3, 2))] = trim($v83878c91171338902e0fe0fb97a8c47a);}return $args;}?>